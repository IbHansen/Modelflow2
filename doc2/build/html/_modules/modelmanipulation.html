<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>modelmanipulation &mdash; ModelFlow  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="../index.html" class="icon icon-home"> ModelFlow
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ModelFlow</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>modelmanipulation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for modelmanipulation</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mon Sep 02 19:41:11 2013</span>

<span class="sd">This module is a textprocessing module which is used to transforms a *template model* for a generic bank into into a unrolled and </span>
<span class="sd">expande model which covers all banks - under  control of a list feature. </span>

<span class="sd">The resulting model can be solved after beeing proccesed in the *modelclass* module. </span>

<span class="sd">In addition to creating a model for forecasting, the module can also create a model which calculates residulas and and variables </span>
<span class="sd">in historic periods.  This model can also be solved by the *modelclass* module. </span>



<span class="sd">@author: Ib</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span><span class="p">,</span><span class="n">chain</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">solve</span><span class="p">,</span> <span class="n">sympify</span>
<span class="kn">import</span> <span class="nn">ast</span>


<span class="kn">from</span> <span class="nn">modelpattern</span> <span class="kn">import</span> <span class="n">find_statements</span><span class="p">,</span><span class="n">split_frml</span><span class="p">,</span><span class="n">find_frml</span><span class="p">,</span><span class="n">list_extract</span><span class="p">,</span><span class="n">udtryk_parse</span><span class="p">,</span><span class="n">kw_frml_name</span><span class="p">,</span><span class="n">commentchar</span>


<div class="viewcode-block" id="safesub"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.safesub">[docs]</a><span class="k">class</span> <span class="nc">safesub</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A subclass of dict.</span>
<span class="sd">    if a *safesub* is indexed by a nonexisting keyword it just return the keyword </span>
<span class="sd">    this alows missing keywords when substitution text inspired by Python cookbook &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span><span class="s1">&#39;}&#39;</span> </div>
    
<div class="viewcode-block" id="sub"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.sub">[docs]</a><span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">katalog</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Substitutes keywords from dictionary by returning </span>
<span class="sd">    text.format_map(safesub(katalog))</span>
<span class="sd">    Allows missing keywords by using safesub subclass&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">safesub</span><span class="p">(</span><span class="n">katalog</span><span class="p">))</span></div>

<div class="viewcode-block" id="oldsub_frml"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.oldsub_frml">[docs]</a><span class="k">def</span> <span class="nf">oldsub_frml</span><span class="p">(</span><span class="n">ibdic</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">plus</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lig</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; to repeat substitution from list</span>
<span class="sd">    </span>
<span class="sd">        * *plus* is a seperator, used for creating sums \n</span>

<span class="sd">        * *var* and *lig* Determins for which items the substitution should take place</span>
<span class="sd">          by var=abe, lig=&#39;ko&#39; substitution is only performed for entries where var==&#39;ko&#39; &#39;&#39;&#39;</span>

        
    <span class="n">katalog</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">outlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ibdic</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>  <span class="c1"># find keywords</span>
    <span class="c1">#    print(&#39;var, lig&#39;,var,lig)&#39;</span>
        <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">select</span> <span class="o">=</span> <span class="n">ibdic</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>   <span class="c1"># no selection criteri</span>
        <span class="k">elif</span> <span class="n">lig</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># We have a selecton criteria and select the situations where it apply</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">ibdic</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="c1"># the values for thes sublist </span>
            <span class="n">select</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">lig</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">taller</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>   <span class="c1"># loop over number of values</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">select</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ibdic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>            <span class="c1"># for each keywords</span>
                    <span class="n">ud</span> <span class="o">=</span> <span class="n">ibdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="c1"># print(&#39;*****************test&#39;,j,taller)</span>
                    <span class="n">katalog</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ud</span><span class="p">[</span><span class="n">taller</span><span class="p">]</span>
                <span class="c1"># make a list with the new text</span>
                <span class="n">outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">katalog</span><span class="p">)</span> <span class="o">+</span> <span class="n">sep</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***** problem&#39;</span><span class="p">,</span><span class="n">ibdic</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="o">+</span><span class="n">text</span><span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">plus</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outlist</span><span class="p">)</span></div>

<div class="viewcode-block" id="sub_frml"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.sub_frml">[docs]</a><span class="k">def</span> <span class="nf">sub_frml</span><span class="p">(</span><span class="n">ibdic</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">plus</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xvar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lig</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; to repeat substitution from list</span>
<span class="sd">        </span>
<span class="sd">        * *plus* is a seperator, used for creating sums \n</span>

<span class="sd">        * *xvar* and *lig* Determins for which items the substitution should take place</span>
<span class="sd">          by var=abe, lig=&#39;ko&#39; substitution is only performed for entries where var==&#39;ko&#39; </span>
<span class="sd">          </span>
<span class="sd">        * *xvar* is the variable to chek against selected in list </span>
<span class="sd">        * *select list* is a list of elements in the xvar list to be included </span>
<span class="sd">        * *matc* is the entry in *select list* from which to select from xvar  </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">          &#39;&#39;&#39;</span>
        
    <span class="n">katalog</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">outlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ibdic</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>  <span class="c1"># find keywords</span>
    <span class="c1">#    print(&#39;var, lig&#39;,xvar,lig)&#39;</span>
        <span class="k">if</span> <span class="n">xvar</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">select</span> <span class="o">=</span> <span class="n">ibdic</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>   <span class="c1"># no selection criteri</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">values</span> <span class="o">=</span> <span class="n">ibdic</span><span class="p">[</span><span class="n">xvar</span><span class="p">]</span>    
        <span class="k">if</span> <span class="n">lig</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># We have a selecton criteria and select the situations where it apply</span>
            <span class="n">select</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">lig</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">taller</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>   <span class="c1"># loop over number of values in the list </span>
            <span class="n">katalog</span><span class="o">=</span><span class="p">{}</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">select</span><span class="p">:</span>
                <span class="n">katalog</span> <span class="o">=</span> <span class="p">{</span><span class="n">j</span><span class="p">:</span> <span class="n">ibdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j</span><span class="p">)[</span><span class="n">taller</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ibdic</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
                <span class="n">outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">katalog</span><span class="p">)</span> <span class="o">+</span> <span class="n">sep</span><span class="p">)</span>
               <span class="c1"># print(&#39;&gt;&#39;,katalog)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***** problem</span><span class="se">\n</span><span class="s1">&gt;&#39;</span><span class="p">,</span><span class="n">ibdic</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&gt;&#39;</span><span class="p">,</span><span class="n">xvar</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&gt;&#39;</span><span class="p">,</span><span class="n">lig</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&gt; &lt;&#39;</span><span class="p">,</span><span class="n">text</span><span class="p">,</span><span class="s1">&#39;&gt; </span><span class="se">\n</span><span class="s1">&gt;&#39;</span><span class="p">,</span><span class="n">katalog</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">plus</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outlist</span><span class="p">)</span></div>

<span class="n">a</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bankdic&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bank&#39;</span><span class="p">:[</span><span class="s1">&#39;Danske&#39;</span><span class="p">,</span><span class="s1">&#39;Nordea&#39;</span><span class="p">],</span><span class="s1">&#39;danske&#39;</span><span class="p">:[</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span><span class="s1">&#39;no&#39;</span><span class="p">],</span><span class="s1">&#39;nordisk&#39;</span><span class="p">:[</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span><span class="s1">&#39;no&#39;</span><span class="p">]}}</span>


<div class="viewcode-block" id="find_res"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.find_res">[docs]</a><span class="k">def</span> <span class="nf">find_res</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Finds the expression which calculates the residual in a formel. FRML &lt;res=a,endo=b&gt; x=a*b+c $ &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">solve</span><span class="p">,</span> <span class="n">sympify</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">udtryk</span> <span class="o">=</span> <span class="n">split_frml</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">udres</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">tres</span> <span class="o">=</span> <span class="n">kw_frml_name</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;RES&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tres</span><span class="p">:</span>
        <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_J&#39;</span> <span class="k">if</span> <span class="n">tres</span> <span class="o">==</span> <span class="s1">&#39;J&#39;</span> <span class="k">else</span> <span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> \
            <span class="s1">&#39;_JR&#39;</span> <span class="k">if</span> <span class="n">tres</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span> <span class="k">else</span> <span class="n">tres</span>
        <span class="c1"># we take the the $ out</span>
        <span class="n">kat</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="s1">&#39;Eq(&#39;</span> <span class="o">+</span> <span class="n">lhs</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="n">res_frml</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="s1">&#39;res_frml&#39;</span><span class="p">)</span>
        <span class="n">res_frml</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">kat</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="n">udres</span> <span class="o">=</span> <span class="s1">&#39;FRML &#39;</span> <span class="o">+</span> <span class="s1">&#39;RES&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
            <span class="n">res</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res_frml</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; $&#39;</span>
    <span class="k">return</span> <span class="n">udres</span></div>

<div class="viewcode-block" id="find_res_dynare"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.find_res_dynare">[docs]</a><span class="k">def</span> <span class="nf">find_res_dynare</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; equations to calculat _res formulas</span>
<span class="sd">    FRML &lt;&gt; x=a*b+c +x_RES  $ -&gt; FRML &lt;&gt; x_res =x-a*b+c  $&#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">solve</span><span class="p">,</span> <span class="n">sympify</span>
    <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">find_frml</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">udtryk</span> <span class="o">=</span> <span class="n">split_frml</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span><span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_RES&#39;</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">rhs</span><span class="p">:</span>
            <span class="c1"># we take the the $ out</span>
            <span class="n">kat</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="s1">&#39;Eq(&#39;</span> <span class="o">+</span> <span class="n">lhs</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
            <span class="n">res_frml</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="s1">&#39;res_frml&#39;</span><span class="p">)</span>
            <span class="n">res_frml</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">kat</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
            <span class="n">udres</span> <span class="o">=</span> <span class="s1">&#39;FRML &#39;</span> <span class="o">+</span> <span class="s1">&#39;RES&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res_frml</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; $&#39;</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">udres</span><span class="p">)</span>
    <span class="k">return</span>   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> </div>

<div class="viewcode-block" id="find_res_dynare_new"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.find_res_dynare_new">[docs]</a><span class="k">def</span> <span class="nf">find_res_dynare_new</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; equations to calculat _res formulas</span>
<span class="sd">    FRML &lt;&gt; x=a*b+c +x_RES  $ -&gt; FRML &lt;&gt; x_res =x-a*b+c  $</span>
<span class="sd">    not finished to speed time up &#39;&#39;&#39;</span>
    <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">find_frml</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">udtryk</span> <span class="o">=</span> <span class="n">split_frml</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span><span class="o">=</span><span class="n">udtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">rhs</span><span class="o">=</span><span class="n">rhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">res</span><span class="o">=</span> <span class="n">lhs</span><span class="o">+</span><span class="s1">&#39;_RES&#39;</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">rhs</span><span class="p">:</span>
            <span class="n">rep</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;frml &lt;&gt; </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s1"> =  </span><span class="si">{</span><span class="n">lhs</span><span class="si">}</span><span class="s1"> - (</span><span class="si">{</span><span class="n">rep</span><span class="si">}</span><span class="s1">) $&#39;</span>           
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            
    <span class="k">return</span>   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> </div>

<div class="viewcode-block" id="find_hist_model"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.find_hist_model">[docs]</a><span class="k">def</span> <span class="nf">find_hist_model</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; takes a unrolled model and create a model which can be run for historic periode \n</span>
<span class="sd">        and the identities are also calculeted&#39;&#39;&#39;</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">find_frml</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">udtryk</span> <span class="o">=</span> <span class="n">split_frml</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">kw_frml_name</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;IDENT&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kw_frml_name</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span>
            <span class="c1"># identites are just replicated in order to calculate backdata</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span></div>


<div class="viewcode-block" id="exounroll"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.exounroll">[docs]</a><span class="k">def</span> <span class="nf">exounroll</span><span class="p">(</span><span class="n">in_equations</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; takes a model and makes a new model by enhancing frml&#39;s with &lt;exo=,j=,jr=&gt; </span>
<span class="sd">    in their frml name. </span>
<span class="sd">    </span>
<span class="sd">    :exo: the value can be fixed in to a value valuename_x by setting valuename_d=1</span>

<span class="sd">    :jled: a additiv adjustment element is added to the frml</span>

<span class="sd">    :jrled: a multiplicativ adjustment element is added to the frml </span>
<span class="sd">    &#39;&#39;&#39;</span>    
    
    <span class="n">nymodel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="n">in_equations</span><span class="p">[:]</span>  <span class="c1"># we want do change the e</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
<span class="c1">#        print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;FRML&#39;</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">udtryk</span> <span class="o">=</span> <span class="n">split_frml</span><span class="p">((</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="c1">#print(fr,n, kw_frml_name(n.upper(),&#39;EXO&#39;))</span>
            <span class="c1"># we want a relatov adjustment</span>
            <span class="k">if</span> <span class="n">kw_frml_name</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;JRLED&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kw_frml_name</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;JR&#39;</span><span class="p">):</span>
                <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">udtryk</span> <span class="o">=</span> <span class="n">lhs</span> <span class="o">+</span> \
                    <span class="s1">&#39;= (&#39;</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)*(1+&#39;</span> <span class="o">+</span> <span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_JR )&#39;</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span>
            <span class="k">if</span> <span class="n">kw_frml_name</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;JLED&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kw_frml_name</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">):</span>
                <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># we want a absolute adjustment</span>
                <span class="n">udtryk</span> <span class="o">=</span> <span class="n">lhs</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_J&#39;</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span>
            <span class="k">if</span> <span class="n">kw_frml_name</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;EXO&#39;</span><span class="p">):</span>
                <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">endogen</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">dummy</span> <span class="o">=</span> <span class="n">endogen</span> <span class="o">+</span> <span class="s1">&#39;_D&#39;</span>
                <span class="n">exogen</span> <span class="o">=</span> <span class="n">endogen</span> <span class="o">+</span> <span class="s1">&#39;_X&#39;</span>
                <span class="n">udtryk</span> <span class="o">=</span> <span class="n">lhs</span> <span class="o">+</span> \
                    <span class="s1">&#39;=(&#39;</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)*(1-&#39;</span> <span class="o">+</span> <span class="n">dummy</span> <span class="o">+</span> <span class="s1">&#39;)+&#39;</span> <span class="o">+</span> <span class="n">exogen</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="n">dummy</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span>

            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">udtryk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>

    <span class="n">equations</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">equations</span></div>



<div class="viewcode-block" id="tofrml"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.tofrml">[docs]</a><span class="k">def</span> <span class="nf">tofrml</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; a function, wich adds FRML to all expressions seperated by &lt;sep&gt;  </span>
<span class="sd">    if no start is specified the max lag will be used &#39;&#39;&#39;</span> 
        
    <span class="n">notrans</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;DO&#39;</span><span class="p">,</span><span class="s1">&#39;ENDDO&#39;</span><span class="p">,</span><span class="s1">&#39;LIST&#39;</span><span class="p">,</span><span class="s1">&#39;FRML&#39;</span><span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">trans</span><span class="p">(</span><span class="n">eq</span><span class="p">):</span>
        <span class="n">test</span><span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;        &#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">notrans</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eq</span> <span class="o">+</span>  <span class="s1">&#39;$&#39;</span> 
        <span class="k">elif</span> <span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">commentchar</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eq</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;FRML &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">eq</span> <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39; &lt;&gt; &#39;</span> <span class="o">+</span><span class="n">eq</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; $&#39;</span> <span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;$&#39;</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expressions</span>
    <span class="k">else</span><span class="p">:</span> 
<span class="c1">#        exp = re.sub(commentchar+&#39;!(.*)\n&#39;,r&#39;!\1\n&#39;,expressions)        </span>
        <span class="n">eqlist</span> <span class="o">=</span>  <span class="p">[</span><span class="n">trans</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)]</span>
    
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">eqlist</span><span class="p">)</span></div>


<div class="viewcode-block" id="dounloop"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.dounloop">[docs]</a><span class="k">def</span> <span class="nf">dounloop</span><span class="p">(</span><span class="n">in_equations</span><span class="p">,</span><span class="n">listin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Expands (unrolls  do loops in a model template </span>
<span class="sd">    goes trough a model template until there is no more nested do loops &#39;&#39;&#39;</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="n">in_equations</span><span class="p">[:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>   <span class="c1"># we want do change the equations </span>
    <span class="n">liste_dict</span> <span class="o">=</span> <span class="n">listin</span> <span class="k">if</span> <span class="n">listin</span> <span class="k">else</span> <span class="n">list_extract</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>   <span class="c1"># Search the whold model for lists</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">rest</span><span class="p">:</span>  <span class="c1"># We want to eat all doo loops</span>
        <span class="n">nymodel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">domodel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dolevel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">liste_name</span><span class="p">,</span> <span class="n">liste_key</span><span class="p">,</span> <span class="n">liste_select</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">comment</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
           <span class="c1"># print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
            <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DO&#39;</span><span class="p">:</span>
                <span class="n">dolevel</span> <span class="o">=</span> <span class="n">dolevel</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">dolevel</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">rest</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># do we have more doolops</span>
                    <span class="n">domodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
    <span class="c1">#=========================================================================</span>
    <span class="c1"># else: # find listname key=select</span>
    <span class="c1">#=========================================================================</span>
                <span class="k">elif</span> <span class="n">dolevel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">liste_name</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                            <span class="sa">r</span><span class="s1">&#39;[\s,]\s*&#39;</span><span class="p">,</span>
                            <span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                    <span class="n">current_dict</span> <span class="o">=</span> <span class="n">liste_dict</span><span class="p">[</span><span class="n">liste_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="c1">#print(&#39;listenavn &#39;,liste_name, current_dict)</span>
                    <span class="c1">#ibdic, text, plus=&#39;&#39;, xvar=&#39;&#39;, lig=&#39;&#39;, sep=&#39;\n&#39;,selectlist=None,match=&#39;&#39;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">liste_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">liste_key</span><span class="p">,</span> <span class="n">liste_select</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">liste_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">liste_key</span><span class="p">,</span> <span class="n">liste_select</span> <span class="o">=</span> <span class="n">liste_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">liste_name</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="c1"># current_dict=liste_dict[value[0:-2].strip()] # find the name of the list</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="mi">1</span><span class="o">==</span><span class="mi">2</span> <span class="p">,</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; *** error in DO statement either 1 or 4 arguments:&#39;</span><span class="p">,</span><span class="n">comment</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">domodel</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ENDDO&#39;</span><span class="p">):</span>
                <span class="n">dolevel</span> <span class="o">=</span> <span class="n">dolevel</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">dolevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">liste_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">liste_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">liste_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">:</span>
                        <span class="n">ibsud</span> <span class="o">=</span> <span class="n">sub_frml</span><span class="p">(</span><span class="n">current_dict</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">domodel</span><span class="p">),</span><span class="n">plus</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> 
                          <span class="n">xvar</span><span class="o">=</span><span class="n">liste_key</span><span class="p">,</span> <span class="n">lig</span><span class="o">=</span><span class="n">liste_select</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fejl i liste&#39;</span><span class="p">,</span> <span class="n">liste_name</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ibsud&gt;&#39;</span><span class="p">,</span><span class="n">ibsud</span><span class="p">)</span>
                    <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">ibsud</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dolevel</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">domodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dolevel</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># a command to store for do looping</span>
                <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                    <span class="n">domodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">domodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># a command outside a dooloop</span>
                <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                    <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">equations</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">equations</span></div>

<span class="c1">#%</span>
<div class="viewcode-block" id="find_arg"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.find_arg">[docs]</a><span class="k">def</span> <span class="nf">find_arg</span><span class="p">(</span><span class="n">funk</span><span class="p">,</span> <span class="n">streng</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;  chops a string in 3 parts \n</span>
<span class="sd">    1. before &#39;funk(&#39; </span>

<span class="sd">    2. in the matching parantesis </span>

<span class="sd">    3. after the last matching parenthesis &#39;&#39;&#39;</span>
    <span class="n">tfunk</span><span class="p">,</span> <span class="n">tstreng</span> <span class="o">=</span> <span class="n">funk</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">streng</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">tfunk</span> <span class="o">=</span> <span class="n">tfunk</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span>
    <span class="k">if</span> <span class="n">tfunk</span> <span class="ow">in</span> <span class="n">tstreng</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">tstreng</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">tfunk</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">tstreng</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">tfunk</span><span class="p">):]</span>
        <span class="nb">open</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;()&#39;</span><span class="p">:</span>
                <span class="nb">open</span> <span class="o">=</span> <span class="p">(</span><span class="nb">open</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">match</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span> <span class="k">else</span> <span class="p">(</span><span class="nb">open</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">open</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tstreng</span><span class="p">[:</span><span class="n">start</span><span class="p">],</span> <span class="n">match</span><span class="p">[:</span><span class="n">index</span><span class="p">],</span> <span class="n">match</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span></div>


<div class="viewcode-block" id="sumunroll_old"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.sumunroll_old">[docs]</a><span class="k">def</span> <span class="nf">sumunroll_old</span><span class="p">(</span><span class="n">in_equations</span><span class="p">,</span><span class="n">listin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; expands all sum(list,&#39;expression&#39;) in a model</span>
<span class="sd">    returns a new model&#39;&#39;&#39;</span>
    <span class="n">nymodel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="n">in_equations</span><span class="p">[:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># we want do change the e</span>
    <span class="n">liste_dict</span> <span class="o">=</span> <span class="n">listin</span> <span class="k">if</span> <span class="n">listin</span> <span class="k">else</span> <span class="n">list_extract</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>   <span class="c1"># Search the whold model for lists</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
       <span class="c1"># print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="s1">&#39;SUM(&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">forsum</span><span class="p">,</span> <span class="n">sumudtryk</span><span class="p">,</span> <span class="n">eftersum</span> <span class="o">=</span> <span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">sumover</span><span class="p">,</span> <span class="n">sumled</span> <span class="o">=</span> <span class="n">sumudtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">current_dict</span> <span class="o">=</span> <span class="n">liste_dict</span><span class="p">[</span><span class="n">sumover</span><span class="p">]</span>
                <span class="n">ibsud</span> <span class="o">=</span> <span class="n">sub_frml</span><span class="p">(</span><span class="n">current_dict</span><span class="p">,</span> <span class="n">sumled</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">forsum</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">ibsud</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="n">eftersum</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">equations</span></div>

<div class="viewcode-block" id="lagarray_unroll"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.lagarray_unroll">[docs]</a><span class="k">def</span> <span class="nf">lagarray_unroll</span><span class="p">(</span><span class="n">in_equations</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&#39;&#39;&#39; expands all sum(list,&#39;expression&#39;) in a model</span>
<span class="sd">    returns a new model&#39;&#39;&#39;</span>
    <span class="n">nymodel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="n">in_equations</span><span class="p">[:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># we want do change the e</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
       <span class="c1"># print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="s1">&#39;LAG_ARRAY(&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">forlag</span><span class="p">,</span> <span class="n">lagudtryk</span><span class="p">,</span> <span class="n">efterlag</span> <span class="o">=</span> <span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;LAG_ARRAY&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">lagnumber</span><span class="p">,</span> <span class="n">lagled</span> <span class="o">=</span> <span class="n">lagudtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">ibsud</span> <span class="o">=</span> <span class="n">lag_n_tup</span><span class="p">(</span><span class="n">lagled</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">lagnumber</span><span class="p">),</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">forlag</span> <span class="o">+</span> <span class="s1">&#39;ARRAY([&#39;</span> <span class="o">+</span> <span class="n">ibsud</span> <span class="o">+</span> <span class="s1">&#39;])&#39;</span> <span class="o">+</span> <span class="n">efterlag</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">equations</span></div>

<div class="viewcode-block" id="sumunroll"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.sumunroll">[docs]</a><span class="k">def</span> <span class="nf">sumunroll</span><span class="p">(</span><span class="n">in_equations</span><span class="p">,</span><span class="n">listin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; expands all sum(list,&#39;expression&#39;) in a model</span>
<span class="sd">    if sum(list xvar=lig,&#39;expression&#39;) only list elements where the condition is </span>
<span class="sd">    satisfied wil be summed</span>
<span class="sd">    </span>
<span class="sd">    returns a new model&#39;&#39;&#39;</span>
    <span class="n">nymodel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="n">in_equations</span><span class="p">[:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># we want do change the e</span>
    <span class="n">liste_dict</span> <span class="o">=</span> <span class="n">listin</span> <span class="k">if</span> <span class="n">listin</span> <span class="k">else</span> <span class="n">list_extract</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>   <span class="c1"># Search the whold model for lists</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
       <span class="c1"># print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="s1">&#39;SUM(&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">forsum</span><span class="p">,</span> <span class="n">sumudtryk</span><span class="p">,</span> <span class="n">eftersum</span> <span class="o">=</span> <span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">suminit</span><span class="p">,</span> <span class="n">sumled</span> <span class="o">=</span> <span class="n">sumudtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">suminit</span><span class="p">:</span>
                    <span class="n">sumover</span><span class="p">,</span><span class="n">remain</span> <span class="o">=</span> <span class="n">suminit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">xvar</span><span class="p">,</span><span class="n">lig</span> <span class="o">=</span><span class="n">remain</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sumover</span> <span class="o">=</span> <span class="n">suminit</span>
                    <span class="n">xvar</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                    <span class="n">lig</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                    
                <span class="n">current_dict</span> <span class="o">=</span> <span class="n">liste_dict</span><span class="p">[</span><span class="n">sumover</span><span class="p">]</span>
                <span class="n">ibsud</span> <span class="o">=</span> <span class="n">sub_frml</span><span class="p">(</span><span class="n">current_dict</span><span class="p">,</span> <span class="n">sumled</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">xvar</span><span class="o">=</span><span class="n">xvar</span><span class="p">,</span><span class="n">lig</span><span class="o">=</span><span class="n">lig</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">forsum</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">ibsud</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="n">eftersum</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">equations</span></div>

<div class="viewcode-block" id="argunroll"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.argunroll">[docs]</a><span class="k">def</span> <span class="nf">argunroll</span><span class="p">(</span><span class="n">in_equations</span><span class="p">,</span><span class="n">listin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; expands all ARGEXPAND(list,&#39;expression&#39;) in a model</span>
<span class="sd">    returns a new model&#39;&#39;&#39;</span>
    <span class="n">nymodel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="n">in_equations</span><span class="p">[:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># we want do change the e</span>
    <span class="n">liste_dict</span> <span class="o">=</span> <span class="n">listin</span> <span class="k">if</span> <span class="n">listin</span> <span class="k">else</span> <span class="n">list_extract</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>   <span class="c1"># Search the whold model for lists</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
       <span class="c1"># print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="s1">&#39;ARGEXPAND(&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">forsum</span><span class="p">,</span> <span class="n">sumudtryk</span><span class="p">,</span> <span class="n">eftersum</span> <span class="o">=</span> <span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;ARGEXPAND&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">sumover</span><span class="p">,</span> <span class="n">sumled</span> <span class="o">=</span> <span class="n">sumudtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">current_dict</span> <span class="o">=</span> <span class="n">liste_dict</span><span class="p">[</span><span class="n">sumover</span><span class="p">]</span>
                <span class="n">ibsud</span> <span class="o">=</span> <span class="n">sub_frml</span><span class="p">(</span><span class="n">current_dict</span><span class="p">,</span> <span class="n">sumled</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">forsum</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">ibsud</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">eftersum</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">equations</span></div>
    
<div class="viewcode-block" id="creatematrix"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.creatematrix">[docs]</a><span class="k">def</span> <span class="nf">creatematrix</span><span class="p">(</span><span class="n">in_equations</span><span class="p">,</span><span class="n">listin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; expands all ARGEXPAND(list,&#39;expression&#39;) in a model</span>
<span class="sd">    returns a new model&#39;&#39;&#39;</span>
    <span class="n">nymodel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="n">in_equations</span><span class="p">[:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># we want do change the e</span>
    <span class="n">liste_dict</span> <span class="o">=</span> <span class="n">listin</span> <span class="k">if</span> <span class="n">listin</span> <span class="k">else</span> <span class="n">list_extract</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>   <span class="c1"># Search the whold model for lists</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
       <span class="c1"># print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="s1">&#39;TO_MATRIX(&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">forcreate</span><span class="p">,</span> <span class="n">createudtryk</span><span class="p">,</span> <span class="n">eftercreate</span> <span class="o">=</span> <span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;TO_MATRIX&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">temp</span>        <span class="o">=</span> <span class="n">createudtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">mat_name</span>    <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">create_row</span>  <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">row_dict</span>    <span class="o">=</span> <span class="n">liste_dict</span><span class="p">[</span><span class="n">create_row</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">ibsud</span>   <span class="o">=</span> <span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">row_dict</span><span class="p">,</span> <span class="n">mat_name</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">create_column</span><span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
                    <span class="n">column_dict</span> <span class="o">=</span> <span class="n">liste_dict</span><span class="p">[</span><span class="n">create_column</span><span class="p">]</span>
                    <span class="n">ibsud0</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">column_dict</span><span class="p">,</span> <span class="n">mat_name</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
                    <span class="n">ibsud</span> <span class="o">=</span>  <span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">row_dict</span><span class="p">,</span> <span class="n">ibsud0</span>     <span class="p">,</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
                
                <span class="n">value</span> <span class="o">=</span> <span class="n">forcreate</span> <span class="o">+</span> <span class="s1">&#39;matrix(</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">ibsud</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="n">eftercreate</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">equations</span></div>
<div class="viewcode-block" id="createarray"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.createarray">[docs]</a><span class="k">def</span> <span class="nf">createarray</span><span class="p">(</span><span class="n">in_equations</span><span class="p">,</span><span class="n">listin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; expands all to_array(list) in a model</span>
<span class="sd">    returns a new model&#39;&#39;&#39;</span>
    <span class="n">nymodel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="n">in_equations</span><span class="p">[:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># we want do change the e</span>
    <span class="n">liste_dict</span> <span class="o">=</span> <span class="n">listin</span> <span class="k">if</span> <span class="n">listin</span> <span class="k">else</span> <span class="n">list_extract</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>   <span class="c1"># Search the whold model for lists</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
       <span class="c1"># print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="s1">&#39;TO_ARRAY(&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">forcreate</span><span class="p">,</span> <span class="n">createudtryk</span><span class="p">,</span> <span class="n">eftercreate</span> <span class="o">=</span> <span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;TO_ARRAY&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">temp</span>        <span class="o">=</span> <span class="n">createudtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">mat_name</span>    <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">create_row</span>  <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">row_dict</span>    <span class="o">=</span> <span class="n">liste_dict</span><span class="p">[</span><span class="n">create_row</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">ibsud</span>   <span class="o">=</span> <span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">row_dict</span><span class="p">,</span> <span class="n">mat_name</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">create_column</span><span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
                    <span class="n">column_dict</span> <span class="o">=</span> <span class="n">liste_dict</span><span class="p">[</span><span class="n">create_column</span><span class="p">]</span>
                    <span class="n">ibsud0</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">column_dict</span><span class="p">,</span> <span class="n">mat_name</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
                    <span class="n">ibsud</span> <span class="o">=</span>  <span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">row_dict</span><span class="p">,</span> <span class="n">ibsud0</span>     <span class="p">,</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
                
                <span class="n">value</span> <span class="o">=</span> <span class="n">forcreate</span> <span class="o">+</span> <span class="s1">&#39;array(</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">ibsud</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="n">eftercreate</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">equations</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">equations</span></div>

<div class="viewcode-block" id="kaedeunroll"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.kaedeunroll">[docs]</a><span class="k">def</span> <span class="nf">kaedeunroll</span><span class="p">(</span><span class="n">in_equations</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&#39;&#39;&#39; unrolls a chain (kaede) expression - used in the SMEC moedel &#39;&#39;&#39;</span>
    <span class="n">nymodel</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">equations</span><span class="o">=</span><span class="n">in_equations</span><span class="p">[:]</span>  <span class="c1"># we want do change the e</span>
   <span class="c1"># modelprint(equations)</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
<span class="c1">#        print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">command</span><span class="o">==</span><span class="s1">&#39;FRML&#39;</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span><span class="n">fr</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">udtryk</span><span class="o">=</span><span class="n">split_frml</span><span class="p">((</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="k">while</span>  <span class="s1">&#39;KAEDE(&#39;</span> <span class="ow">in</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">forkaede</span><span class="p">,</span><span class="n">kaedeudtryk</span><span class="p">,</span><span class="n">efterkaede</span><span class="o">=</span><span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;KAEDE&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span>
                <span class="n">arg</span><span class="o">=</span><span class="n">kaedeudtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">taller</span><span class="p">,</span><span class="n">navner</span><span class="o">=</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;(&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span>
                    <span class="n">taller</span><span class="o">=</span><span class="n">taller</span><span class="o">+</span><span class="n">arg</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;*(&#39;</span><span class="o">+</span><span class="n">lagone</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">arg</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)+&#39;</span>
                    <span class="n">navner</span><span class="o">=</span><span class="n">navner</span><span class="o">+</span><span class="n">lagone</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;+&#39;</span>
                <span class="n">navner</span><span class="o">=</span><span class="n">navner</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                <span class="n">taller</span><span class="o">=</span><span class="n">taller</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>   
                <span class="c1">#print(taller,&#39;/&#39;,navner)</span>
                <span class="n">udtryk</span><span class="o">=</span><span class="n">forkaede</span><span class="o">+</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="n">taller</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">navner</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="o">+</span><span class="n">efterkaede</span> 
            <span class="k">while</span>  <span class="s1">&#39;KAEDEP(&#39;</span> <span class="ow">in</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">forkaede</span><span class="p">,</span><span class="n">kaedeudtryk</span><span class="p">,</span><span class="n">efterkaede</span><span class="o">=</span><span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;KAEDEP&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span>
                <span class="n">arg</span><span class="o">=</span><span class="n">kaedeudtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="c1">#print(arg,len(arg)/2)</span>
                <span class="n">taller</span><span class="p">,</span><span class="n">navner</span><span class="o">=</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;(&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span>
                    <span class="n">taller</span><span class="o">=</span><span class="n">taller</span><span class="o">+</span><span class="n">arg</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">lagone</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;+&#39;</span>
                    <span class="n">navner</span><span class="o">=</span><span class="n">navner</span><span class="o">+</span><span class="n">lagone</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;+&#39;</span><span class="o">+</span><span class="n">lagone</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;+&#39;</span>
                <span class="n">navner</span><span class="o">=</span><span class="n">navner</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                <span class="n">taller</span><span class="o">=</span><span class="n">taller</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>   
                <span class="c1">#print(taller,&#39;/&#39;,navner)</span>
                <span class="n">udtryk</span><span class="o">=</span><span class="n">forkaede</span><span class="o">+</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="n">taller</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">navner</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="o">+</span><span class="n">efterkaede</span> 
            <span class="k">while</span>  <span class="s1">&#39;MOVAVG(&#39;</span> <span class="ow">in</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">forkaede</span><span class="p">,</span><span class="n">kaedeudtryk</span><span class="p">,</span><span class="n">efterkaede</span><span class="o">=</span><span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;MOVAVG&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span>
                <span class="n">arg</span><span class="o">=</span><span class="n">kaedeudtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">avg</span><span class="o">=</span><span class="s1">&#39;((&#39;</span>
                <span class="n">term</span><span class="o">=</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#print(arg,len(arg)/2)</span>
                <span class="c1"># breakpoint()</span>
                <span class="n">antal</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">antal</span><span class="p">):</span>
                    <span class="n">avg</span><span class="o">=</span><span class="n">avg</span><span class="p">[:]</span><span class="o">+</span><span class="n">term</span><span class="p">[:]</span><span class="o">+</span><span class="s1">&#39;+&#39;</span>
                    <span class="n">term</span><span class="o">=</span><span class="n">lagone</span><span class="p">(</span><span class="n">term</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span>
                <span class="n">avg</span><span class="o">=</span><span class="n">avg</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;)/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">antal</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.0)&#39;</span>
                <span class="c1">#print(taller,&#39;/&#39;,navner)</span>
                <span class="n">udtryk</span><span class="o">=</span><span class="n">forkaede</span><span class="o">+</span><span class="n">avg</span><span class="o">+</span><span class="n">efterkaede</span> 
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">udtryk</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">value</span><span class="p">)</span>
    <span class="n">equations</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">equations</span>  </div>

<div class="viewcode-block" id="check_syntax_frml"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.check_syntax_frml">[docs]</a><span class="k">def</span> <span class="nf">check_syntax_frml</span><span class="p">(</span><span class="n">frml</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; check syntax of frml &#39;&#39;&#39;</span> 
    <span class="k">try</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">udtryk</span> <span class="o">=</span> <span class="n">split_frml</span><span class="p">(</span><span class="n">frml</span><span class="p">)</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="normalize_a_frml"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.normalize_a_frml">[docs]</a><span class="k">def</span> <span class="nf">normalize_a_frml</span><span class="p">(</span><span class="n">frml</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
    <span class="sd">&#39;&#39;&#39; Normalize and show a frml&#39;&#39;&#39;</span>     
    <span class="n">new</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">frml</span><span class="p">,</span><span class="n">sym</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Try normalizing     :</span><span class="si">{</span><span class="n">frml</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;After normalization :</span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_syntax_frml</span><span class="p">(</span><span class="n">new</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;** ERROR in         :</span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span> 
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;**Normalization did not solve the problem in this  formula&#39;</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">new</span></div>

<div class="viewcode-block" id="nomalize_a_model"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.nomalize_a_model">[docs]</a><span class="k">def</span> <span class="nf">nomalize_a_model</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; a symbolic normalization is performed if there is a syntaxerror &#39;&#39;&#39;</span>
    
    <span class="n">out</span><span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">frml</span> <span class="k">if</span> <span class="n">check_syntax_frml</span><span class="p">(</span><span class="n">frml</span><span class="p">)</span> <span class="k">else</span> <span class="n">normalize_a_frml</span><span class="p">(</span><span class="n">frml</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">frml</span> <span class="ow">in</span> <span class="n">find_frml</span><span class="p">(</span><span class="n">equations</span><span class="p">)])</span> 
    <span class="k">return</span> <span class="n">out</span> </div>
        

<div class="viewcode-block" id="normalize"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.normalize">[docs]</a><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">in_equations</span><span class="p">,</span><span class="n">sym</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&#39;&#39;&#39; Normalize an equation with log or several variables at the left hand side, the first variable is considerd the endogeneeus&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">findendo</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; finds the equation for the first variable of a string&#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">endovar</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>  <span class="c1"># Finds the first variable in a expression</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">udtryk_parse</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                        <span class="n">ud</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">var</span>
                        <span class="k">break</span>
                <span class="k">return</span> <span class="n">ud</span>
        <span class="n">ind</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;LOG\(&#39;</span><span class="p">,</span><span class="s1">&#39;log(&#39;</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span> <span class="c1"># sypy uses lover case for log and exp </span>
        <span class="n">ind</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;EXP\(&#39;</span><span class="p">,</span><span class="s1">&#39;exp(&#39;</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
        <span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span><span class="o">=</span><span class="n">ind</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">udtryk_parse</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">))</span> <span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># we have an expression on the left hand side </span>
<span class="c1">#            print(&#39;Before &gt;&gt;&#39;,ind)</span>
            <span class="n">endo</span><span class="o">=</span><span class="n">sympify</span><span class="p">(</span><span class="n">endovar</span><span class="p">(</span><span class="n">lhs</span><span class="p">))</span>
            <span class="n">kat</span><span class="o">=</span><span class="n">sympify</span><span class="p">(</span><span class="s1">&#39;Eq(&#39;</span><span class="o">+</span><span class="n">lhs</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span> <span class="c1"># we take the the $ out </span>
            <span class="n">endo_frml</span><span class="o">=</span><span class="n">solve</span><span class="p">(</span><span class="n">kat</span><span class="p">,</span><span class="n">endo</span><span class="p">,</span><span class="n">simplify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">rational</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#            print(&#39;After  &gt;&gt;&#39;, str(endo)+&#39;=&#39; + str(endo_frml[0])+&#39;$&#39;)</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">endo</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">endo_frml</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;$&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># no need to solve this equation </span>
            <span class="k">return</span> <span class="n">ind</span> 
    <span class="k">def</span> <span class="nf">normalizesym</span><span class="p">(</span><span class="n">in_equations</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Normalizes equations by using sympy &#39;&#39;&#39;</span>
        <span class="n">nymodel</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">equations</span><span class="o">=</span><span class="n">in_equations</span><span class="p">[:]</span>  <span class="c1"># we want do change the e</span>
       <span class="c1"># modelprint(equations)</span>
        <span class="k">for</span> <span class="n">comment</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
    <span class="c1">#        print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
            <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">command</span><span class="o">==</span><span class="s1">&#39;FRML&#39;</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span><span class="n">fr</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">udtryk</span><span class="o">=</span><span class="n">split_frml</span><span class="p">((</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="k">while</span>  <span class="s1">&#39;DLOG(&#39;</span> <span class="ow">in</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="n">fordlog</span><span class="p">,</span><span class="n">dlogudtryk</span><span class="p">,</span><span class="n">efterdlog</span><span class="o">=</span><span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;dlog&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span>
                    <span class="n">udtryk</span><span class="o">=</span><span class="n">fordlog</span><span class="o">+</span><span class="s1">&#39;diff(log(&#39;</span><span class="o">+</span><span class="n">dlogudtryk</span><span class="o">+</span><span class="s1">&#39;))&#39;</span><span class="o">+</span><span class="n">efterdlog</span>           
                <span class="k">while</span>  <span class="s1">&#39;LOGIT(&#39;</span> <span class="ow">in</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="n">forlogit</span><span class="p">,</span><span class="n">logitudtryk</span><span class="p">,</span><span class="n">efterlogit</span><span class="o">=</span><span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;LOGIT&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span>
                    <span class="n">udtryk</span><span class="o">=</span><span class="n">forlogit</span><span class="o">+</span><span class="s1">&#39;(log(&#39;</span><span class="o">+</span><span class="n">logitudtryk</span><span class="o">+</span><span class="s1">&#39;/(1.0 -&#39;</span><span class="o">+</span><span class="n">logitudtryk</span><span class="o">+</span><span class="s1">&#39;)))&#39;</span><span class="o">+</span><span class="n">efterlogit</span>           
                <span class="k">while</span>  <span class="s1">&#39;DIFF(&#39;</span> <span class="ow">in</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="n">fordif</span><span class="p">,</span><span class="n">difudtryk</span><span class="p">,</span><span class="n">efterdif</span><span class="o">=</span><span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span>
                    <span class="n">udtryk</span><span class="o">=</span><span class="n">fordif</span><span class="o">+</span><span class="s1">&#39;((&#39;</span><span class="o">+</span><span class="n">difudtryk</span><span class="o">+</span><span class="s1">&#39;)-(&#39;</span><span class="o">+</span><span class="n">lagone</span><span class="p">(</span><span class="n">difudtryk</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;))&#39;</span><span class="o">+</span><span class="n">efterdif</span>           
                <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">findendo</span><span class="p">(</span><span class="n">udtryk</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">value</span><span class="p">)</span>
        <span class="n">equations</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
<span class="c1">#        modelprint(equations)</span>
        <span class="k">return</span> <span class="n">equations</span>       
    <span class="k">def</span> <span class="nf">normalizehift</span><span class="p">(</span><span class="n">in_equations</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Normalizes equations by shuffeling terms around \n</span>
<span class="sd">        can handel LOG, DLOG and DIF in the left hans side of = &#39;&#39;&#39;</span>
        <span class="n">nymodel</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">equations</span><span class="o">=</span><span class="n">in_equations</span><span class="p">[:]</span>  <span class="c1"># we want do change the e</span>
       <span class="c1"># modelprint(equations)</span>
        <span class="k">for</span> <span class="n">comment</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
    <span class="c1">#        print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
            <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">command</span><span class="o">==</span><span class="s1">&#39;FRML&#39;</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span><span class="n">fr</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">udtryk</span><span class="o">=</span><span class="n">split_frml</span><span class="p">((</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span><span class="o">=</span><span class="n">udtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">lhsterms</span><span class="o">=</span><span class="n">udtryk_parse</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lhsterms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only one term on the left hand side, no need to shuffel around</span>
                    <span class="k">pass</span> 
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lhsterms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># We need to normalixe expect funk(x) on the levt hand side funk=LOG,DLOG or DIFF</span>
                    <span class="n">rhs</span><span class="o">=</span><span class="n">rhs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># discharge the $ strip blanks for nice look </span>
                    <span class="n">lhs</span><span class="o">=</span><span class="n">lhsterms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">var</span> <span class="c1"># name of the dependent variablem, no syntax check here </span>
                    <span class="k">if</span> <span class="n">lhsterms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;LOG&#39;</span><span class="p">:</span> 
                        <span class="n">rhs</span><span class="o">=</span><span class="s1">&#39;EXP(&#39;</span><span class="o">+</span><span class="n">rhs</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                        <span class="n">udtryk</span><span class="o">=</span><span class="n">lhs</span><span class="o">+</span><span class="s1">&#39;=&#39;</span><span class="o">+</span><span class="n">rhs</span><span class="o">+</span><span class="s1">&#39;$&#39;</span> <span class="c1"># now the equation is normalized </span>
                    <span class="k">elif</span> <span class="n">lhsterms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;DIFF&#39;</span><span class="p">:</span>
                        <span class="n">rhs</span><span class="o">=</span><span class="n">lagone</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;+(&#39;</span><span class="o">+</span><span class="n">rhs</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                        <span class="n">udtryk</span><span class="o">=</span><span class="n">lhs</span><span class="o">+</span><span class="s1">&#39;=&#39;</span><span class="o">+</span><span class="n">rhs</span><span class="o">+</span><span class="s1">&#39;$&#39;</span> <span class="c1"># now the equation is normalized </span>
                    <span class="k">elif</span> <span class="n">lhsterms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;DLOG&#39;</span><span class="p">:</span>
                        <span class="n">rhs</span><span class="o">=</span><span class="s1">&#39;EXP(LOG(&#39;</span><span class="o">+</span><span class="n">lagone</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)+&#39;</span><span class="o">+</span><span class="n">rhs</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                        <span class="n">udtryk</span><span class="o">=</span><span class="n">lhs</span><span class="o">+</span><span class="s1">&#39;=&#39;</span><span class="o">+</span><span class="n">rhs</span><span class="o">+</span><span class="s1">&#39;$&#39;</span> <span class="c1"># now the equation is normalized </span>
                    <span class="k">elif</span> <span class="n">lhsterms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;LOGIT&#39;</span><span class="p">:</span>
                        <span class="n">rhs</span><span class="o">=</span><span class="s1">&#39;(exp(&#39;</span><span class="o">+</span><span class="n">rhs</span><span class="o">+</span><span class="s1">&#39;)/(1+EXP(&#39;</span><span class="o">+</span><span class="n">rhs</span><span class="o">+</span><span class="s1">&#39;)))&#39;</span>
                        <span class="n">udtryk</span><span class="o">=</span><span class="n">lhs</span><span class="o">+</span><span class="s1">&#39;=&#39;</span><span class="o">+</span><span class="n">rhs</span><span class="o">+</span><span class="s1">&#39;$&#39;</span> <span class="c1"># now the equation is normalized </span>
<span class="c1">#                    else:</span>
<span class="c1">#                        print(&#39;*** ERROR operand not allowed left of =&#39;,lhs)</span>
<span class="c1">#                        print(lhsterms)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
<span class="c1">#                    print(&#39;*** Try to normalize relation for:&#39;,lhs)</span>
                <span class="c1"># now the right hand side is expanded for DLOG and DIFF</span>
                <span class="k">while</span>  <span class="s1">&#39;DLOG(&#39;</span> <span class="ow">in</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="n">fordlog</span><span class="p">,</span><span class="n">dlogudtryk</span><span class="p">,</span><span class="n">efterdlog</span><span class="o">=</span><span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;dlog&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span>
                    <span class="n">udtryk</span><span class="o">=</span><span class="n">fordlog</span><span class="o">+</span><span class="s1">&#39;diff(log(&#39;</span><span class="o">+</span><span class="n">dlogudtryk</span><span class="o">+</span><span class="s1">&#39;))&#39;</span><span class="o">+</span><span class="n">efterdlog</span>           
                <span class="k">while</span>  <span class="s1">&#39;DIFF(&#39;</span> <span class="ow">in</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="n">fordif</span><span class="p">,</span><span class="n">difudtryk</span><span class="p">,</span><span class="n">efterdif</span><span class="o">=</span><span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span>
                    <span class="n">udtryk</span><span class="o">=</span><span class="n">fordif</span><span class="o">+</span><span class="s1">&#39;((&#39;</span><span class="o">+</span><span class="n">difudtryk</span><span class="o">+</span><span class="s1">&#39;)-(&#39;</span><span class="o">+</span><span class="n">lagone</span><span class="p">(</span><span class="n">difudtryk</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;))&#39;</span><span class="o">+</span><span class="n">efterdif</span>           
                <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">udtryk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">value</span><span class="p">)</span>
        <span class="n">equations</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
<span class="c1">#        modelprint(in_equations,&#39;Before normalization and expansion&#39;)</span>
<span class="c1">#        modelprint(equations,   &#39;After  normalization and expansion&#39;)</span>
        <span class="k">return</span> <span class="n">equations</span> 
    <span class="k">if</span> <span class="n">sym</span> <span class="p">:</span>
        <span class="n">equations1</span><span class="o">=</span><span class="n">normalizesym</span><span class="p">(</span><span class="n">in_equations</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="n">equations1</span><span class="o">=</span><span class="n">normalizehift</span><span class="p">(</span><span class="n">in_equations</span><span class="p">)</span>
    <span class="c1">#equations2=normalizesym(equations1)    # to speed up </span>
    <span class="k">return</span> <span class="n">equations1</span> </div>

    
<div class="viewcode-block" id="udrul_model"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.udrul_model">[docs]</a><span class="k">def</span> <span class="nf">udrul_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="n">explode</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span></div>

<div class="viewcode-block" id="explode"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.explode">[docs]</a><span class="k">def</span> <span class="nf">explode</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sym</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[],</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;prepares a model from a model template. </span>
<span class="sd">    </span>
<span class="sd">    Returns a expanded model which is ready to solve</span>
<span class="sd">    </span>
<span class="sd">    Eksempel: model = udrul_model(MinModel.txt)&#39;&#39;&#39;</span>
    <span class="c1"># breakpoint()</span>
    <span class="n">udrullet</span><span class="o">=</span><span class="n">tofrml</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span> 
    <span class="n">modellist</span> <span class="o">=</span> <span class="n">list_extract</span><span class="p">(</span><span class="n">udrullet</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">norm</span> <span class="p">:</span> <span class="n">udrullet</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">udrullet</span><span class="p">,</span><span class="n">sym</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span> <span class="p">)</span> <span class="c1"># to save time if we know that normalization is not needed </span>
    <span class="n">udrullet</span> <span class="o">=</span> <span class="n">lagarray_unroll</span><span class="p">(</span><span class="n">udrullet</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span> <span class="p">)</span>
    <span class="n">udrullet</span> <span class="o">=</span> <span class="n">exounroll</span><span class="p">(</span><span class="n">udrullet</span><span class="p">)</span>    <span class="c1"># finaly the exogeneous and adjustment terms - if present -  are handled </span>
    <span class="n">udrullet</span> <span class="o">=</span> <span class="n">dounloop</span><span class="p">(</span><span class="n">udrullet</span><span class="p">,</span><span class="n">listin</span><span class="o">=</span><span class="n">modellist</span><span class="p">)</span>        <span class="c1">#  we unroll the do loops </span>
    <span class="n">udrullet</span> <span class="o">=</span> <span class="n">sumunroll</span><span class="p">(</span><span class="n">udrullet</span><span class="p">,</span><span class="n">listin</span><span class="o">=</span><span class="n">modellist</span><span class="p">)</span>    <span class="c1"># then we unroll the sum </span>
    <span class="n">udrullet</span> <span class="o">=</span> <span class="n">creatematrix</span><span class="p">(</span><span class="n">udrullet</span><span class="p">,</span><span class="n">listin</span><span class="o">=</span><span class="n">modellist</span><span class="p">)</span>
    <span class="n">udrullet</span> <span class="o">=</span> <span class="n">createarray</span><span class="p">(</span><span class="n">udrullet</span><span class="p">,</span><span class="n">listin</span><span class="o">=</span><span class="n">modellist</span><span class="p">)</span>
    <span class="n">udrullet</span> <span class="o">=</span> <span class="n">argunroll</span><span class="p">(</span><span class="n">udrullet</span><span class="p">,</span><span class="n">listin</span><span class="o">=</span><span class="n">modellist</span><span class="p">)</span>
   
    <span class="k">return</span> <span class="n">udrullet</span></div>


<div class="viewcode-block" id="modelprint"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.modelprint">[docs]</a><span class="k">def</span> <span class="nf">modelprint</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39; A model&#39;</span><span class="p">,</span> <span class="n">udfil</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; prettyprinter for a a model. </span>
<span class="sd">    :udfil: if present is output file</span>
<span class="sd">    :short: if present condences the model</span>
<span class="sd">    Can handle both model templates and models &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">if</span> <span class="n">udfil</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">udfil</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
    <span class="n">maxlenfnavn</span><span class="p">,</span> <span class="n">maxlenlhs</span><span class="p">,</span> <span class="n">maxlenrhs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;FRML&#39;</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">udtryk</span> <span class="o">=</span> <span class="n">split_frml</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">maxlenfnavn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxlenfnavn</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="c1"># Finds the max length of frml name</span>
            <span class="n">maxlenlhs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxlenlhs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lhs</span><span class="p">))</span>   <span class="c1"># finds the max length of left hand variable</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;! &#39;</span><span class="o">+</span> <span class="n">title</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="n">dolevel</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    &#39;</span> <span class="o">*</span> <span class="n">dolevel</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;FRML&#39;</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">udtryk</span> <span class="o">=</span> <span class="n">split_frml</span><span class="p">(</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">lhs</span> <span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">udtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">short</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">fr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">maxlenlhs</span><span class="p">),</span>
                        <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">rhs</span> <span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rhs</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">rhs</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="n">fr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
                        <span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">maxlenfnavn</span><span class="p">),</span>
                        <span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">maxlenlhs</span><span class="p">),</span>
                        <span class="s1">&#39;=&#39;</span><span class="p">,</span>
                        <span class="n">rhs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;    &#39;</span> <span class="o">*</span> <span class="n">dolevel</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">maxlenfnavn</span><span class="o">+</span><span class="n">maxlenlhs</span><span class="p">))),</span>
                        <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DO&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                <span class="n">dolevel</span> <span class="o">=</span> <span class="n">dolevel</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ENDDO&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                <span class="n">dolevel</span> <span class="o">=</span> <span class="n">dolevel</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span></div>
                
                
     
<div class="viewcode-block" id="lagone"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.lagone">[docs]</a><span class="k">def</span> <span class="nf">lagone</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[],</span><span class="n">laglead</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; All variables in a string i</span>
<span class="sd">    s lagged one more time &#39;&#39;&#39;</span>
    <span class="n">nt</span><span class="o">=</span><span class="n">udtryk_parse</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nt</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
            <span class="n">ud</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">op</span> 
        <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
            <span class="n">ud</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">number</span>
        <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
            <span class="n">lag</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
            <span class="n">org_lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
            <span class="n">new_lag</span> <span class="o">=</span> <span class="n">org_lag</span><span class="o">+</span><span class="n">laglead</span>
            <span class="k">if</span> <span class="n">new_lag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ud</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">ud</span><span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">new_lag</span><span class="si">:</span><span class="s1">+</span><span class="si">}</span><span class="s1">)&#39;</span>           
        <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ud</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fib</span><span class="p">)</span></div>

<div class="viewcode-block" id="lag_n"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.lag_n">[docs]</a><span class="k">def</span> <span class="nf">lag_n</span><span class="p">(</span><span class="n">udtryk</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[],</span><span class="n">laglead</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">new</span><span class="o">=</span><span class="n">udtryk</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">new</span><span class="o">=</span><span class="n">lagone</span><span class="p">(</span><span class="n">new</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">,</span><span class="n">laglead</span><span class="o">=</span><span class="n">laglead</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s1">)&#39;</span></div>
<span class="n">lag_n</span><span class="p">(</span><span class="s1">&#39;a+b&#39;</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">laglead</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="lag_n_tup"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.lag_n_tup">[docs]</a><span class="k">def</span> <span class="nf">lag_n_tup</span><span class="p">(</span><span class="n">udtryk</span><span class="p">,</span><span class="n">n</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&#39;&#39;&#39; return a tuppel og lagged expressions from lag = 0 to lag = n)&#39;&#39;&#39;</span>
    <span class="n">new</span><span class="o">=</span><span class="n">udtryk</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">res</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
        <span class="n">new</span><span class="o">=</span><span class="n">lagone</span><span class="p">(</span><span class="n">new</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">,</span><span class="n">laglead</span><span class="o">=-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span>  <span class="o">+</span> <span class="n">new</span> <span class="o">+</span><span class="s1">&#39;,&#39;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">res</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span></div>
<span class="n">lag_n_tup</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="n">n</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>


 
<div class="viewcode-block" id="pastestring"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.pastestring">[docs]</a><span class="k">def</span> <span class="nf">pastestring</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">post</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[],</span><span class="n">onlylags</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; All variable names in a  in a string **ind** is pasted with the string **post** </span>
<span class="sd">    </span>
<span class="sd">    This function can be used to awoid variable name conflict with the internal variable names in sympy. </span>
<span class="sd">    </span>
<span class="sd">    an advanced function</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nt</span><span class="o">=</span><span class="n">udtryk_parse</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nt</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
            <span class="n">ud</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">op</span> 
        <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
            <span class="n">ud</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">number</span>
        <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">onlylags</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">:</span> 
                    <span class="n">ud</span><span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="o">+</span> <span class="n">post</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> 
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">ud</span><span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">ud</span><span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="o">+</span> <span class="n">post</span><span class="o">+</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> 

        <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ud</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fib</span><span class="p">)</span></div>

<div class="viewcode-block" id="stripstring"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.stripstring">[docs]</a><span class="k">def</span> <span class="nf">stripstring</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">post</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&#39;&#39;&#39; All variable names in a  in a string is **ind** is stripped of the string **post**.</span>
<span class="sd">    </span>
<span class="sd">    This function reverses the pastestring process </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nt</span><span class="o">=</span><span class="n">udtryk_parse</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">lenpost</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nt</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
            <span class="n">ud</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">op</span> 
        <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
            <span class="n">ud</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">number</span>
        <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
                <span class="n">ud</span><span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">[:</span><span class="o">-</span><span class="n">lenpost</span><span class="p">]</span><span class="o">+</span>  <span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">ud</span><span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="o">+</span>  <span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
                
                <span class="c1"># print(&#39;Tries to strip &#39;+post +&#39; from &#39;+ind)</span>
        <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ud</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fib</span><span class="p">)</span></div>
   
  
<div class="viewcode-block" id="findindex"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.findindex">[docs]</a><span class="k">def</span> <span class="nf">findindex</span><span class="p">(</span><span class="n">ind00</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; find the index variables meaning variables on the left hand side of = braced by {} &#39;&#39;&#39;</span>
    <span class="n">ind0</span> <span class="o">=</span> <span class="n">ind00</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ind0</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind0</span><span class="p">[</span><span class="n">ind0</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind0</span>
    <span class="n">lhs</span><span class="o">=</span><span class="n">ind</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span>  <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;\{([A-Za-z][\w]*)\}&#39;</span><span class="p">,</span><span class="n">lhs</span> <span class="p">))</span> <span class="c1"># all the index variables </span></div>

<div class="viewcode-block" id="doablelist"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.doablelist">[docs]</a><span class="k">def</span> <span class="nf">doablelist</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; create a list of tupels from expressions seperated by sep, </span>
<span class="sd">    each element in the list is a tupel (index, number og expression, the expression)</span>
<span class="sd">    </span>
<span class="sd">    we want make group the expressions acording to index </span>
<span class="sd">    index is elements on the left of = braced by {} </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">lt</span> <span class="o">=</span> <span class="p">[(</span><span class="n">findindex</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expressions</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">))]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">1.</span><span class="p">)),</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span> </div>

<div class="viewcode-block" id="dosubst"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.dosubst">[docs]</a><span class="k">def</span> <span class="nf">dosubst</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">formular</span><span class="p">):</span>
    <span class="n">out</span><span class="o">=</span><span class="n">formular</span><span class="p">[:]</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">nr</span> <span class="o">&lt;=</span> <span class="mi">9</span> <span class="p">,</span> <span class="s1">&#39;To many indeces in&#39;</span><span class="o">+</span><span class="n">formular</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\%&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span><span class="s1">&#39;{&#39;</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\</span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;__&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;{&#39;</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="s1">&#39;}&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">]),</span><span class="n">out</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="doablekeep"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.doablekeep">[docs]</a><span class="k">def</span> <span class="nf">doablekeep</span><span class="p">(</span><span class="n">formulars</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; takes index in the lhs and creates a do loop around the lines with same indexes</span>
<span class="sd">    on the right side you can use %0_, %1_ an so on to indicate the index, just to awoid typing to much</span>
<span class="sd">    </span>
<span class="sd">    Also %i_ will be changed to all the indexes&#39;&#39;&#39;</span> 
        

    <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;$&#39;</span> <span class="k">if</span> <span class="s1">&#39;$&#39;</span> <span class="ow">in</span> <span class="n">formulars</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> 
    <span class="n">xx</span> <span class="o">=</span> <span class="n">doablelist</span><span class="p">(</span><span class="n">formulars</span><span class="p">,</span><span class="n">sep</span><span class="p">)</span>
    <span class="n">out</span>     <span class="o">=</span> <span class="p">[]</span>
    <span class="n">listout</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xxx</span><span class="p">,</span><span class="n">ee</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">xxx</span><span class="p">:</span>
            <span class="n">pre</span>  <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;  &#39;</span><span class="o">*</span><span class="n">i</span><span class="o">+</span>             <span class="s1">&#39;Do &#39;</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="s1">&#39;_list  $</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xxx</span><span class="p">)])</span>
            <span class="n">post</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;  &#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xxx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;Enddo $ </span><span class="se">\n</span><span class="s1">&#39;</span>          <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xxx</span><span class="p">)])</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">frml</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;  &#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xxx</span><span class="p">))</span><span class="o">+</span><span class="n">dosubst</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span> <span class="s1">&#39; $ </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ee</span> <span class="p">])</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pre</span> <span class="o">+</span> <span class="n">frml</span> <span class="o">+</span> <span class="n">post</span><span class="p">])</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">number</span><span class="p">,</span><span class="n">exp</span> <span class="ow">in</span> <span class="n">ee</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exp</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;LIST&#39;</span><span class="p">):</span>
                   <span class="n">listout</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">exp</span> <span class="o">+</span> <span class="s1">&#39; $ </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="p">:</span> 
<span class="c1">#                   print(exp)</span>
                   <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">exp</span><span class="o">+</span> <span class="s1">&#39; $ </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">listout</span><span class="p">,</span><span class="o">*</span><span class="n">out</span><span class="p">))</span></div>
<span class="c1">##%%</span>
<div class="viewcode-block" id="doable"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.doable">[docs]</a><span class="k">def</span> <span class="nf">doable</span><span class="p">(</span><span class="n">formulars</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&#39;&#39;&#39; takes index in the lhs and creates a do loop around the line</span>
<span class="sd">    on the right side you can use %0_, %1_ an so on to indicate the index, just to awoid typing to much</span>
<span class="sd">    </span>
<span class="sd">    Also %i_ will be changed to all the indexes&#39;&#39;&#39;</span> 
 
    <span class="k">def</span> <span class="nf">endovar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[]):</span>  <span class="c1"># Finds the first variable in a expression</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">udtryk_parse</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                <span class="n">ud</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">var</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">ud</span>
   

    <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;$&#39;</span> <span class="k">if</span> <span class="s1">&#39;$&#39;</span> <span class="ow">in</span> <span class="n">formulars</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> 
    <span class="n">lt</span> <span class="o">=</span> <span class="p">[(</span><span class="n">findindex</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">formulars</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">))]</span>

    <span class="n">out</span>     <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xxx</span><span class="p">,</span><span class="n">number</span><span class="p">,</span><span class="n">exp</span> <span class="ow">in</span> <span class="n">lt</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xxx</span><span class="p">:</span>
            <span class="n">pre</span>  <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;  &#39;</span><span class="o">*</span><span class="n">i</span><span class="o">+</span>             <span class="s1">&#39;Do &#39;</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="s1">&#39;_list  $</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xxx</span><span class="p">)])</span>
            <span class="n">post</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;  &#39;</span><span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xxx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;Enddo $ </span><span class="se">\n</span><span class="s1">&#39;</span>          <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xxx</span><span class="p">)])</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">frml</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xxx</span><span class="p">))</span> <span class="o">+</span> <span class="n">dosubst</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span><span class="n">exp</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39; $ </span><span class="se">\n</span><span class="s1">&#39;</span> 
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pre</span> <span class="o">+</span> <span class="n">frml</span> <span class="o">+</span> <span class="n">post</span><span class="p">)</span> 
            <span class="n">ind</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">):</span>
                <span class="n">frml_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;\&lt;.*?\&gt;&#39;</span><span class="p">,</span><span class="n">ind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sumname</span> <span class="o">=</span> <span class="n">kw_frml_name</span><span class="p">(</span><span class="n">frml_name</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sumname</span><span class="p">:</span>
                    <span class="n">lhs</span><span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">lhsvar</span> <span class="o">=</span> <span class="n">endovar</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span>
                    <span class="n">lhsvar_stub</span> <span class="o">=</span> <span class="n">lhsvar</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sumlist</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;sum(</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">_list,&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">])</span><span class="o">+</span><span class="n">lhsvar</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">xxx</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lhsvar_stub</span><span class="si">}{</span><span class="n">sumname</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">sumlist</span><span class="si">}</span><span class="s1"> $ </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="p">:</span> 
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="o">+</span> <span class="s1">&#39; $ </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>   <span class="c1"># the replace is a quick fix </span></div>

<span class="c1">#% test doable</span>
<span class="n">frml</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">list sectors_list = sectors : a b</span>
<span class="s1">list banks_list   = banks : hest ko</span>

<span class="s1">    a__</span><span class="si">{banks}</span><span class="s1">__</span><span class="si">{sectors}</span><span class="s1"> = b </span>
<span class="s1">&lt;sum= all&gt;    b__</span><span class="si">{sectors}</span><span class="s1">__</span><span class="si">{banks}</span><span class="s1">  = b</span>
<span class="s1">&lt;sum= all&gt;    diff(xx__</span><span class="si">{sectors}</span><span class="s1">__</span><span class="si">{banks}</span><span class="s1">)  = 42 </span>
<span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="n">testfrml</span> <span class="o">=</span> <span class="p">(</span><span class="n">doable</span><span class="p">(</span><span class="n">frml</span><span class="p">))</span>
<span class="c1"># print(explode(testfrml))</span>

<span class="c1">##%%</span>
<div class="viewcode-block" id="findindex_gams"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.findindex_gams">[docs]</a><span class="k">def</span> <span class="nf">findindex_gams</span><span class="p">(</span><span class="n">ind00</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; </span>
<span class="sd">     - an equation looks like this</span>
<span class="sd">     - &lt;frmlname&gt; [index] lhs = rhs </span>
<span class="sd">    </span>
<span class="sd">    this function find frmlname and index variables on the left hand side. meaning variables braced by {} &#39;&#39;&#39;</span>
    <span class="n">ind0</span> <span class="o">=</span> <span class="n">ind00</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ind0</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">):</span>
        <span class="n">frmlname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;\&lt;.*?\&gt;&#39;</span><span class="p">,</span><span class="n">ind0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind0</span><span class="p">[</span><span class="n">ind0</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frmlname</span><span class="o">=</span><span class="s1">&#39;&lt;&gt;&#39;</span>
        <span class="n">ind</span><span class="o">=</span><span class="n">ind0</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
        <span class="n">allindex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;\[.*?\]&#39;</span><span class="p">,</span><span class="n">ind0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">allindex</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">ind</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="n">ind</span>
    <span class="k">return</span> <span class="n">frmlname</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">rest</span></div>

<div class="viewcode-block" id="un_normalize_expression"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.un_normalize_expression">[docs]</a><span class="k">def</span> <span class="nf">un_normalize_expression</span><span class="p">(</span><span class="n">frml</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;This function makes sure that all formulas are unnormalized.</span>
<span class="sd">    if the formula is already decorated with &lt;endo=name&gt; this is kept </span>
<span class="sd">    else the lhs_varriable is used in &lt;endo=&gt; </span>
<span class="sd">    &#39;&#39;&#39;</span> 
    <span class="n">frml_name</span><span class="p">,</span><span class="n">frml_index</span><span class="p">,</span><span class="n">frml_rest</span> <span class="o">=</span> <span class="n">findindex_gams</span><span class="p">(</span><span class="n">frml</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">this_endo</span> <span class="o">=</span> <span class="n">kw_frml_name</span><span class="p">(</span><span class="n">frml_name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;ENDO&#39;</span><span class="p">)</span>
    <span class="c1"># breakpoint()</span>
    <span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span>  <span class="o">=</span> <span class="n">frml_rest</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">this_endo</span><span class="p">:</span> 
        <span class="n">lhs_var</span> <span class="o">=</span> <span class="n">this_endo</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">frml_name_out</span> <span class="o">=</span> <span class="n">frml_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lhs_var</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># frml_name_out = f&#39;&lt;endo={lhs_var}&gt;&#39; if frml_name == &#39;&lt;&gt;&#39; else f&#39;{frml_name[:-1]},endo={lhs_var}&gt;&#39;</span>
        <span class="n">frml_name_out</span> <span class="o">=</span> <span class="n">frml_name</span><span class="p">[:]</span>
    <span class="c1"># print(this_endo)</span>
    <span class="n">new_rest</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lhs_var</span><span class="si">}</span><span class="s1">___res = ( </span><span class="si">{</span><span class="n">rhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s1"> ) - ( </span><span class="si">{</span><span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s1"> )&#39;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">frml_name_out</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">frml_index</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frml_index</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">new_rest</span><span class="si">}</span><span class="s1">&#39;</span></div>
 

<div class="viewcode-block" id="un_normalize_model"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.un_normalize_model">[docs]</a><span class="k">def</span> <span class="nf">un_normalize_model</span><span class="p">(</span><span class="n">in_equations</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&#39;&#39;&#39; un normalize a model &#39;&#39;&#39;</span>
    <span class="n">nymodel</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">equations</span><span class="o">=</span><span class="n">in_equations</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># we want do change the e</span>
   <span class="c1"># modelprint(equations)</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">find_statements</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
        <span class="c1"># print(&#39;&gt;&gt;&#39;,comment,&#39;&lt;&#39;,command,&#39;&gt;&#39;,value)</span>
        <span class="c1"># breakpoint()</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">command</span><span class="o">==</span><span class="s1">&#39;FRML&#39;</span><span class="p">:</span>
            <span class="n">un_frml</span> <span class="o">=</span> <span class="n">un_normalize_expression</span><span class="p">(</span><span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;FRML </span><span class="si">{</span><span class="n">un_frml</span><span class="si">}</span><span class="s1"> $&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nymodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">value</span><span class="p">)</span>
    <span class="n">equations</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nymodel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">equations</span>  </div>

<div class="viewcode-block" id="un_normalize_simpel"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.un_normalize_simpel">[docs]</a><span class="k">def</span> <span class="nf">un_normalize_simpel</span><span class="p">(</span><span class="n">in_equations</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[]):</span>
   <span class="sd">&#39;&#39;&#39; un-normalize expressions delimeted by linebreaks&#39;&#39;&#39;</span>
   <span class="n">edm</span>  <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">un_normalize_expression</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">in_equations</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
   <span class="n">fdm</span>  <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="n">edm</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">fdm</span></div>


<div class="viewcode-block" id="eksempel"><a class="viewcode-back" href="../modelmanipulation.html#modelmanipulation.eksempel">[docs]</a><span class="k">def</span> <span class="nf">eksempel</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; takes a template model as input, creates a model and a histmodel and prints the models&#39;&#39;&#39;</span>
    <span class="n">abe</span> <span class="o">=</span> <span class="n">udrul_model</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">ko</span> <span class="o">=</span> <span class="n">find_hist_model</span><span class="p">(</span><span class="n">abe</span><span class="p">)</span>
    <span class="n">modelprint</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="s1">&#39;Model template&#39;</span><span class="p">)</span>
    <span class="n">modelprint</span><span class="p">(</span><span class="n">abe</span><span class="p">,</span> <span class="s1">&#39;Unrolled model&#39;</span><span class="p">)</span>
    <span class="n">modelprint</span><span class="p">(</span><span class="n">ko</span><span class="p">,</span>  <span class="s1">&#39;Historic model&#39;</span><span class="p">)</span></div>
<span class="c1"># print(&#39;Hej fra modelmanipulation&#39;)</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span> <span class="ow">and</span> <span class="mi">1</span> <span class="p">:</span>
    <span class="c1">#%%</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; and &#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">plus</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">xvar</span><span class="o">=</span><span class="s1">&#39;danske&#39;</span><span class="p">,</span><span class="n">lig</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">xvar</span><span class="o">=</span><span class="s1">&#39;danske&#39;</span><span class="p">,</span><span class="n">lig</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">))</span>
    
    <span class="c1">#%%</span>
    <span class="n">fmodel</span><span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    list BANKDIC = bank : Danske , Nordea $                                 </span>
<span class="s1">    list countryDIC = country : Uk , DK, SE , NO , IR, GE US AS AT CA$                                 </span>
<span class="s1">    list countrydanske = country : uk , DK, IR $</span>
<span class="s1">    list countrynordea = country: SE , DK, AT $</span>
<span class="s1">    do bankdic $ </span>
<span class="s1">        frml x </span><span class="si">{bank}</span><span class="s1">_income = </span><span class="si">{bank}</span><span class="s1">_a +</span><span class="si">{bank}</span><span class="s1">_b $</span>
<span class="s1">        do country</span><span class="si">{bank}</span><span class="s1"> $</span>
<span class="s1">            frml x </span><span class="si">{bank}</span><span class="s1">_</span><span class="si">{country}</span><span class="s1"> = 4242 $</span>
<span class="s1">        enddo $ </span>
<span class="s1">        do countrydic  $</span>
<span class="s1">            frml x </span><span class="si">{bank}</span><span class="s1">_</span><span class="si">{country}</span><span class="s1">_all = 42 $</span>
<span class="s1">        enddo $ </span>
<span class="s1">    enddo $ &#39;&#39;&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">dounloop</span><span class="p">(</span><span class="n">fmodel</span><span class="p">))</span>
<span class="c1">#%%</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">stripstring</span><span class="p">(</span><span class="n">pastestring</span><span class="p">(</span><span class="s1">&#39;a+b+log(x)&#39;</span><span class="p">,</span><span class="s1">&#39;_xx&#39;</span><span class="p">),</span><span class="s1">&#39;_xx&#39;</span><span class="p">))</span> 
    <span class="n">split_frml</span> <span class="p">(</span><span class="s1">&#39;FRML x ib     =1+gris $&#39;</span><span class="p">)</span>
    <span class="n">split_frml</span> <span class="p">(</span><span class="s1">&#39;FRML &lt;res&gt; ib =1+gris $&#39;</span><span class="p">)</span>
    <span class="n">find_statements</span><span class="p">(</span><span class="s1">&#39;   FRML x ib    =1+gris $    frml &lt;exo&gt; hane= 27*ged$&#39;</span><span class="p">)</span>
    <span class="n">find_statements</span><span class="p">(</span><span class="s1">&#39;! FRML x ib =1+gris $ </span><span class="se">\n</span><span class="s1"> frml &lt;exo&gt; hane=27*ged $&#39;</span><span class="p">)</span>
    <span class="n">find_statements</span><span class="p">(</span><span class="s1">&#39;FRML x ib =1+gris*(ko+1) $ ! Comment </span><span class="se">\n</span><span class="s1"> frml &lt;exo&gt; hane= ged $&#39;</span><span class="p">)</span>
    <span class="n">sub</span><span class="p">(</span><span class="s1">&#39;O </span><span class="si">{who}</span><span class="s1"> of </span><span class="si">{from}</span><span class="s1">&#39;</span><span class="p">,{</span><span class="s1">&#39;who&#39;</span><span class="p">:</span><span class="s1">&#39;Knights&#39;</span><span class="p">,</span><span class="s1">&#39;from&#39;</span><span class="p">:</span><span class="s1">&#39;Ni&#39;</span><span class="p">})</span>
    <span class="n">sub</span><span class="p">(</span><span class="s1">&#39;O </span><span class="si">{who}</span><span class="s1"> of </span><span class="si">{from}</span><span class="s1">, , we have brought you your </span><span class="si">{weed}</span><span class="s1">&#39;</span><span class="p">,{</span><span class="s1">&#39;who&#39;</span><span class="p">:</span><span class="s1">&#39;Knights&#39;</span><span class="p">,</span><span class="s1">&#39;from&#39;</span><span class="p">:</span><span class="s1">&#39;Ni&#39;</span><span class="p">})</span>
    <span class="n">sub_frml</span><span class="p">({</span><span class="s1">&#39;weed&#39;</span><span class="p">:[</span><span class="s1">&#39;scrubbery&#39;</span><span class="p">,</span><span class="s1">&#39;herring&#39;</span><span class="p">]},</span><span class="s1">&#39;we have brought you your </span><span class="si">{weed}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sub_frml</span><span class="p">({</span><span class="s1">&#39;weed&#39;</span><span class="p">:[</span><span class="s1">&#39;scrubbery&#39;</span><span class="p">,</span><span class="s1">&#39;herring&#39;</span><span class="p">],</span><span class="s1">&#39;where&#39;</span><span class="p">:[</span><span class="s1">&#39;land&#39;</span><span class="p">,</span><span class="s1">&#39;sea&#39;</span><span class="p">]},</span><span class="s1">&#39;we have brought you your </span><span class="si">{weed}</span><span class="s1"> from </span><span class="si">{where}</span><span class="s1"> &#39;</span><span class="p">)</span>
    <span class="n">sub_frml</span><span class="p">({</span><span class="s1">&#39;weed&#39;</span><span class="p">:[</span><span class="s1">&#39;scrubbery&#39;</span><span class="p">,</span><span class="s1">&#39;herring&#39;</span><span class="p">],</span><span class="s1">&#39;where&#39;</span><span class="p">:[</span><span class="s1">&#39;land&#39;</span><span class="p">,</span><span class="s1">&#39;sea&#39;</span><span class="p">]},</span><span class="s1">&#39;we have brought you your </span><span class="si">{weed}</span><span class="s1"> from </span><span class="si">{where}</span><span class="s1"> &#39;</span><span class="p">)</span>           
    <span class="n">a</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bankdic&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bank&#39;</span><span class="p">:[</span><span class="s1">&#39;Danske&#39;</span><span class="p">,</span><span class="s1">&#39;Nordea&#39;</span><span class="p">],</span><span class="s1">&#39;danske&#39;</span><span class="p">:[</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span><span class="s1">&#39;no&#39;</span><span class="p">]}}</span>
    <span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; and &#39;</span><span class="p">)</span>
    <span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">plus</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">xvar</span><span class="o">=</span><span class="s1">&#39;danske&#39;</span><span class="p">,</span><span class="n">lig</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">)</span>
    <span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">xvar</span><span class="o">=</span><span class="s1">&#39;danske&#39;</span><span class="p">,</span><span class="n">lig</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>
    <span class="n">sub_frml</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;bankdic&#39;</span><span class="p">],</span><span class="s1">&#39;Dette er </span><span class="si">{bank}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">list_extract</span><span class="p">(</span><span class="s1">&#39;list bankdic = bank	:   Danske , Nordea / danske : yes , no $&#39;</span><span class="p">)</span>
    <span class="n">kw_frml_name</span><span class="p">(</span><span class="s1">&#39;&lt;res=abe&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
    <span class="n">kw_frml_name</span><span class="p">(</span><span class="s1">&#39;&lt;res=abe,animal&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;animal&#39;</span><span class="p">)</span>
    <span class="n">find_res</span><span class="p">(</span><span class="s1">&#39;FRML &lt;res=x&gt; ib    =x+y+v +ib(-1)$&#39;</span><span class="p">)</span>
    <span class="n">find_res</span><span class="p">(</span><span class="s1">&#39;FRML &lt;res=J&gt; ib    =x+y+v + ib_j $&#39;</span><span class="p">)</span>
    <span class="n">find_res</span><span class="p">(</span><span class="s1">&#39;FRML &lt;res=JR&gt; ib   =(x+y+v + ib_j)*(1+ ib_JR) $)&#39;</span><span class="p">)</span>
    <span class="n">find_hist_model</span><span class="p">(</span><span class="s1">&#39;FRML &lt;res=x&gt; ib    =x+y+v $ frml &lt;ident&gt; y=c+i+x-m $&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">exounroll</span><span class="p">(</span><span class="s1">&#39;frml &lt;j&gt; ib=x+y $ frml &lt;jr&gt; ib=x+y $ frml &lt;j,jr&#39;</span><span class="p">))</span>
    <span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span><span class="s1">&#39;x=log(a+b)+77&#39;</span><span class="p">)</span>
    <span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span><span class="s1">&#39;x=log(a+log(b))+77&#39;</span><span class="p">)</span>
    
    <span class="n">kaedeunroll</span><span class="p">(</span><span class="s1">&#39;FRML &lt;res=x&gt; ib    =x+y+lAG_ARRAY(v,3) $&#39;</span><span class="p">)</span>
<span class="c1">#%%</span>
    <span class="n">x</span><span class="o">=</span> <span class="p">(</span><span class="n">dounloop</span><span class="p">(</span>
              <span class="sd">&#39;&#39;&#39;list bankdic = bank : Danske , Nordea /</span>
<span class="sd">                                ko   : yes , no $</span>
<span class="sd">    do bankdic ko = no $ </span>
<span class="sd">    frml x {bank}_income = {bank}_a +{bank}_b $</span>
<span class="sd">    enddo $ </span>
<span class="sd">    frml x ialt=sum(bankdic ko= yes,{bank}_income ) $&#39;&#39;&#39;</span><span class="p">))</span>
    <span class="c1"># breakpoint()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sumunroll</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="c1">#%%</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sumunroll</span><span class="p">(</span><span class="n">dounloop</span><span class="p">(</span>
    <span class="sd">&#39;&#39;&#39;list BANKDIC = bank : Danske , Nordea $</span>
<span class="sd">    do BANKDIC $ </span>
<span class="sd">    frml x {bank}_income = {bank}_a +{bank}_b $</span>
<span class="sd">    enddo $ </span>
<span class="sd">    frml x ialt=sum(bankdic,{bank}_income) $&#39;&#39;&#39;</span><span class="p">)))</span>  
<span class="c1">#%%</span>
<span class="c1">#     Trying some of the features: </span>
    <span class="n">fmodel</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    list BANKDIC            = currentbank   : Danske , Nordea , Jyske      $</span>
<span class="s1">    list BANKDIC2           = loantobank    : Danske , Nordea , Jyske     $</span>
<span class="s1">    list BANKDIC3           = loanfrombank  : Danske , Nordea , Jyske     $</span>
<span class="s1">    frml &lt;matrix&gt; msigma          = to_matrix(bankdic,bankdic2,cov_</span><span class="si">{currentbank}</span><span class="s1">_</span><span class="si">{loantobank}</span><span class="s1"> ) $</span>
<span class="s1">    frml &lt;matrix&gt; vreturn         = to_matrix(bankdic2,return_</span><span class="si">{loantobank}</span><span class="s1">)                $</span>
<span class="s1">    frml &lt;matrix&gt; vcapitalweights = to_matrix(bankdic2,capitalweights_</span><span class="si">{loantobank}</span><span class="s1">)       $</span>
<span class="s1">        </span>
<span class="s1">    do BANKDIC $  </span>
<span class="s1">        do bankdic2 $</span>
<span class="s1">            frml setmax  loanmax_</span><span class="si">{currentbank}</span><span class="s1">_to_</span><span class="si">{loantobank}</span><span class="s1"> = </span><span class="si">{currentbank}</span><span class="s1">_capital*0.25 $</span>
<span class="s1">            frml setmin  loanmin_</span><span class="si">{currentbank}</span><span class="s1">_to_</span><span class="si">{loantobank}</span><span class="s1"> = 0.0                        $</span>
<span class="s1">        enddo$        </span>
<span class="s1">        frml setmax  loanmax_</span><span class="si">{currentbank}</span><span class="s1">_to_</span><span class="si">{currentbank}</span><span class="s1">    = 0.0 $</span>
<span class="s1">        frml &lt;matrix&gt; </span><span class="si">{currentbank}</span><span class="s1">_loan_max =to_matrix(bankdic2,loan_max_</span><span class="si">{currentbank}</span><span class="s1">_to_</span><span class="si">{loantobank}</span><span class="s1">) $</span>
<span class="s1">        frml &lt;matrix&gt; </span><span class="si">{currentbank}</span><span class="s1">_loan_min =to_matrix(bankdic2,loan_min_</span><span class="si">{currentbank}</span><span class="s1">_to_</span><span class="si">{loantobank}</span><span class="s1">) $</span>
<span class="s1">    enddo      $</span>
<span class="s1">    </span>
<span class="s1">    do Bankdic $ </span>
<span class="s1">     frml &lt;matrix&gt; loan_</span><span class="si">{currentbank}</span><span class="s1">_to </span>
<span class="s1">       = mv_opt(msigma,vreturn,riskaversion, </span><span class="si">{currentbank}</span><span class="s1">_totalloan, vcapitalweights, </span><span class="si">{currentbank}</span><span class="s1">_capital,</span>
<span class="s1">        </span><span class="si">{currentbank}</span><span class="s1">_loan_max,</span><span class="si">{currentbank}</span><span class="s1">_loan_min) $</span>
<span class="s1">    enddo $</span>
<span class="s1">    do Bankdic $</span>
<span class="s1">        frml x </span><span class="si">{currentbank}</span><span class="s1">_loancheck=sum(bankdic2,</span><span class="si">{currentbank}</span><span class="s1">_to_</span><span class="si">{loantobank}</span><span class="s1">_loan)$     </span>
<span class="s1">    enddo $ &#39;&#39;&#39;</span>
    <span class="n">modelprint</span><span class="p">(</span><span class="n">fmodel</span><span class="p">)</span>
    <span class="n">modelprint</span><span class="p">(</span><span class="n">sumunroll</span><span class="p">(</span><span class="n">argunroll</span><span class="p">(</span><span class="n">creatematrix</span><span class="p">(</span><span class="n">dounloop</span><span class="p">(</span><span class="n">fmodel</span><span class="p">)))))</span>
<span class="c1">#%%    </span>
    <span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>    
    
    <span class="n">eq</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;FRML &lt;&gt; logit(pd_country_sector) = </span>
<span class="s1">    0.008 + 0.44 * logit(pd_country_sector(-1)) - 0.18 * gdp_country -0.05*gdp_country(-1) + 0.12 * URX_country  + 0.02 * sltn_country + 0.11 * nsltn_country(-1) $ &#39;&#39;&#39;</span> 
    <span class="c1"># eq=&#39;&#39;&#39;FRML &lt;&gt; logit(cow) = logit(1+1) + diff(a) $ &#39;&#39;&#39; </span>
    <span class="c1"># eq=&#39;&#39;&#39;FRML &lt;&gt; x =  diff(f1(a)) $ &#39;&#39;&#39; </span>
    <span class="nb">print</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;After normalization&#39;</span> <span class="p">)</span>
    <span class="n">neq</span><span class="o">=</span><span class="n">normalize</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[</span><span class="n">f1</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">neq</span><span class="p">)</span>
    <span class="n">toteq</span><span class="o">=</span><span class="n">eq</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="n">neq</span>
    
<span class="c1">#%%</span>

    <span class="n">org</span> <span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">! credit risk </span>
<span class="s1">! calculate pd for each portefolio sector based on  bank specific starting point </span>
<span class="s1">! remember to do a .replace(&#39;</span><span class="si">%s</span><span class="s1">eg%&#39;,&#39;</span><span class="si">{bank}</span><span class="s1">__</span><span class="si">{CrCountry}</span><span class="s1">__</span><span class="si">{PortSeg}</span><span class="s1">&#39;)</span>
<span class="s1">do banklist $</span>
<span class="s1">   do </span><span class="si">{bank}</span><span class="s1">CrCoList $ </span>
<span class="s1">      do PortSegList $ </span>
<span class="s1">          ! non defaultet stock</span>
<span class="s1">           	non_def_exp_end_y__</span><span class="si">%s</span><span class="s1">eg%    = non_def_exp_end_y__</span><span class="si">%s</span><span class="s1">eg%(-1)*(1-pd_pit__Q__</span><span class="si">%s</span><span class="s1">eg%)    $ </span>
<span class="s1">                    </span>
<span class="s1">          	! for this prototype we just use last period LGD</span>
<span class="s1">          	 Lgd_pit_new_scen__</span><span class="si">%s</span><span class="s1">eg% = Lgd_pit_new_scen__</span><span class="si">%s</span><span class="s1">eg%(-1) $</span>

<span class="s1">          	! gross impairemens (losses) newly defaulted stock          </span>
<span class="s1">          	 gross_imp_loss_new_def__</span><span class="si">%s</span><span class="s1">eg%  =  non_def_exp_end_y__</span><span class="si">%s</span><span class="s1">eg%(-1)*pd_pit__Q__</span><span class="si">%s</span><span class="s1">eg</span><span class="si">%*Lg</span><span class="s1">d_pit_new_scen__</span><span class="si">%s</span><span class="s1">eg% $ </span>

<span class="s1">          	! share of provision stock which can ofset the impairements</span>
<span class="s1">          	alfa__</span><span class="si">%s</span><span class="s1">eg%       =  pd_pit__Q__</span><span class="si">%s</span><span class="s1">eg% $</span>

<span class="s1">          	 part of provision stock which can ofset losses </span>
<span class="s1">           	prov_release_new_def__</span><span class="si">%s</span><span class="s1">eg%  =  alfa__</span><span class="si">%s</span><span class="s1">eg% * prov_stock_end_y__</span><span class="si">%s</span><span class="s1">eg%(-1) $</span>

<span class="s1">          	! net impairemens on newly defaulted stock, can only contribute to loss  </span>
<span class="s1">           	imp_loss_new_def__</span><span class="si">%s</span><span class="s1">eg%    =  max(0.0, gross_imp_loss_new_def__</span><span class="si">%s</span><span class="s1">eg% - prov_release_new_def__</span><span class="si">%s</span><span class="s1">eg%)  $</span>

<span class="s1">          	! update the stock of provisions relateed to newly defaulted amount after release to cover impairement  </span>
<span class="s1">         	   prov_stock_end_y__</span><span class="si">%s</span><span class="s1">eg% = prov_stock_end_y__</span><span class="si">%s</span><span class="s1">eg%(-1) + diff(imp_loss_new_def__</span><span class="si">%s</span><span class="s1">eg%) $</span>
<span class="s1">          </span>
<span class="s1">          	! now we look at previous defaulted loans</span>

<span class="s1">          ! defaulted exposure  </span>
<span class="s1">            	def_stock_end_y__</span><span class="si">%s</span><span class="s1">eg% = def_stock_end_y__</span><span class="si">%s</span><span class="s1">eg%(-1) + non_def_exp_end_y__</span><span class="si">%s</span><span class="s1">eg%(-1)*pd_pit__Q__</span><span class="si">%s</span><span class="s1">eg%    $ </span>

<span class="s1">          	! impairement old defaulted stock, can not contribute to profit only loss </span>
<span class="s1">           	imp_loss_old_def__</span><span class="si">%s</span><span class="s1">eg%    =  max(0,diff(Lgd_pit_old_scen__</span><span class="si">%s</span><span class="s1">eg%)* def_stock_end_y__</span><span class="si">%s</span><span class="s1">eg%(-1)) $</span>

<span class="s1">          	! amount of provisions stock relateed to old defaulted stock  </span>
<span class="s1">           	prov_stock_end_y_def__</span><span class="si">%s</span><span class="s1">eg% = prov_stock_end_y_def__</span><span class="si">%s</span><span class="s1">eg%(-1)+imp_loss_old_def__</span><span class="si">%s</span><span class="s1">eg% $</span>
<span class="s1"> </span>
<span class="s1">          	! total impairment</span>
<span class="s1">           	imp_loss_total_def__</span><span class="si">%s</span><span class="s1">eg%    = imp_loss_old_def__</span><span class="si">%s</span><span class="s1">eg</span><span class="si">% +i</span><span class="s1">mp_loss_new_def__</span><span class="si">%s</span><span class="s1">eg% $</span>

<span class="s1">      enddo $</span>
<span class="s1">   enddo $</span>
<span class="s1">   frml &lt;&gt; imp_loss_total_def__</span><span class="si">{bank}</span><span class="s1"> = sum(</span><span class="si">{bank}</span><span class="s1">CrCoList,sum(PortSegList,imp_loss_total_def__</span><span class="si">%s</span><span class="s1">eg%)) $</span>

<span class="s1">enddo $</span>

<span class="s1">       </span>
<span class="s1">        &#39;&#39;&#39;</span> 
        
    <span class="nb">print</span><span class="p">((</span><span class="n">doable</span><span class="p">(</span><span class="n">org</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tofrml</span><span class="p">(</span><span class="n">doable</span><span class="p">(</span><span class="n">org</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;$&#39;</span><span class="p">))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">tofrml</span><span class="p">(</span><span class="s1">&#39;a=b </span><span class="se">\n</span><span class="s1"> c=55 &#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="c1">#%%</span>
    <span class="n">model</span>      <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">!jjjfj</span>
<span class="s1">list alist = al : a b c  </span>
<span class="s1">a = c(-1) + b(-1)  </span>
<span class="s1">x = 0.5 * c </span>
<span class="s1">d = x + 3 * a(-1)</span>
<span class="s1">&#39;&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tofrml</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
    
    
    <span class="c1">#%% testtofrml</span>
    <span class="n">mtest</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39; </span>
<span class="s1">    list banklist = bank    : ib      soren  marie /</span>
<span class="s1">                    country : denmark sweden denmark  $</span>
<span class="s1">                    </span>
<span class="s1">    do banklist $</span>
<span class="s1">    ! kkdddk</span>
<span class="s1">        frml &lt;&gt; profit_</span><span class="si">{bank}</span><span class="s1"> = revenue_</span><span class="si">{bank}</span><span class="s1"> - lag_array(-3,expenses_</span><span class="si">{bank}</span><span class="s1">) $</span>
<span class="s1">        frml &lt;&gt; expenses_</span><span class="si">{bank}</span><span class="s1"> = factor_</span><span class="si">{country}</span><span class="s1"> * revenue_</span><span class="si">{bank}</span><span class="s1"> $</span>
<span class="s1">    enddo $ </span>
<span class="s1">    &#39;&#39;&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">tofrml</span><span class="p">(</span><span class="n">mtest</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">explode</span><span class="p">(</span><span class="n">mtest</span><span class="p">))</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Ib Hansen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>