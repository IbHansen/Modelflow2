<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>modelsandbox_Mixin &mdash; ModelFlow  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="../index.html" class="icon icon-home"> ModelFlow
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">content:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core/Core.html">Core Modules, creates and solves model instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onboard/onboard.html">Processing model specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../attribution/Attribution.html">Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vis/modelvis.html">Quick result visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotly/modeldashsidebar.html">Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jupyter/jupyter.html">Jupyter Stuff</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelinvert.html">Targets and instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelmf.html">Enrich dataframes with modelflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/model_cvx.html">Convex optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelsandbox.html">Template for a user defined  model class based on the model class</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unsorted:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/model_financial_stability.html">model_financial_stability module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/model_ifrs9.html">model_ifrs9 module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/model_run_numba.html">model_run_numba module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modelclass2.html">modelclass2 module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modeldash.html">modeldash module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modeldashboot.html">modeldashboot module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modeldiff.html">modeldiff module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modelhelp.html">modelhelp module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modelnet.html">modelnet module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modelsandbox_Mixin.html">modelsandbox_Mixin module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modeltodo.html">modeltodo module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ModelFlow</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>modelsandbox_Mixin</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for modelsandbox_Mixin</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">This is a module for testing new features of the model class, but in a smaler file. </span>

<span class="sd">Created on Sat Sep 29 06:03:35 2018</span>

<span class="sd">@author: hanseni</span>


<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">sys</span>  
<span class="kn">import</span> <span class="nn">time</span>


<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span>  <span class="k">as</span> <span class="nn">plt</span> 
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">sympify</span><span class="p">,</span><span class="n">Symbol</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">run</span> 
<span class="kn">import</span> <span class="nn">webbrowser</span> <span class="k">as</span> <span class="nn">wb</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span> 
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">ip</span>
<span class="kn">import</span> <span class="nn">inspect</span> 
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">zip_longest</span>
<span class="kn">import</span> <span class="nn">fnmatch</span> 
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">SVG</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">Math</span> <span class="p">,</span><span class="n">Latex</span><span class="p">,</span> <span class="n">Markdown</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Numba not avaiable&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">asdict</span>

<span class="kn">import</span> <span class="nn">sys</span>  
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># print(f&#39;name:{__name__} and package={__package__}!-&#39; )</span>
<span class="n">__package__</span> <span class="o">=</span> <span class="s1">&#39;ModelFlow&#39;</span>

<span class="kn">import</span> <span class="nn">modelpattern</span> <span class="k">as</span> <span class="nn">pt</span>
<span class="kn">from</span> <span class="nn">modelvis</span> <span class="kn">import</span> <span class="n">vis</span>


<span class="kn">import</span> <span class="nn">modelmanipulation</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">modeldiff</span> <span class="k">as</span> <span class="nn">md</span> 
<span class="kn">from</span> <span class="nn">modelmanipulation</span> <span class="kn">import</span> <span class="n">split_frml</span><span class="p">,</span><span class="n">udtryk_parse</span><span class="p">,</span><span class="n">find_statements</span><span class="p">,</span><span class="n">un_normalize_model</span><span class="p">,</span><span class="n">explode</span>
<span class="kn">from</span> <span class="nn">modelclass</span> <span class="kn">import</span> <span class="n">ttimer</span><span class="p">,</span> <span class="n">insertModelVar</span>
<span class="kn">from</span> <span class="nn">modelinvert</span> <span class="kn">import</span> <span class="n">targets_instruments</span>
<span class="kn">import</span> <span class="nn">modeljupyter</span> <span class="k">as</span> <span class="nn">mj</span>

<span class="kn">import</span> <span class="nn">modelvis</span> <span class="k">as</span> <span class="nn">mv</span>
<span class="kn">import</span> <span class="nn">modelmf</span>
<span class="kn">from</span> <span class="nn">modelhelp</span> <span class="kn">import</span> <span class="n">tovarlag</span>   



  
    
<div class="viewcode-block" id="Newmodel_Mixin"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin">[docs]</a><span class="k">class</span> <span class="nc">Newmodel_Mixin</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
            <span class="sd">&#39;&#39;&#39; Runs a model. </span>
<span class="sd">            </span>
<span class="sd">            Default a straight model is calculated by *xgenr* a simultaneous model is solved by *sim* </span>
<span class="sd">            </span>
<span class="sd">            :sim: If False forces a  model to be calculated (not solved) if True force simulation </span>
<span class="sd">            :setbase: If True, place the result in model.basedf </span>
<span class="sd">            :setlast: if False don&#39;t place the results in model.lastdf</span>
<span class="sd">            </span>
<span class="sd">            if the modelproperty previousbase is true, the previous run is used as basedf. </span>
<span class="sd">    </span>
<span class="sd">            </span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;oldkwargs&#39;</span><span class="p">):</span>
                <span class="n">newkwargs</span> <span class="o">=</span>  <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">oldkwargs</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newkwargs</span> <span class="o">=</span>  <span class="n">kwargs</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">oldkwargs</span> <span class="o">=</span> <span class="n">newkwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previousbase</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;lastdf&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlead</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">outdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newtonstack_un_normalized</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">newkwargs</span> <span class="p">)</span>   
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sim2&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">outdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim2d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">newkwargs</span> <span class="p">)</span>   
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">outdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim1d</span><span class="p">(</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">newkwargs</span><span class="p">)</span> 
    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;basedf&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;setbase&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span> <span class="o">=</span> <span class="n">outdf</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;setlast&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>                                  <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span> <span class="o">=</span> <span class="n">outdf</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
            <span class="k">return</span> <span class="n">outdf</span>

  
    <span class="nd">@property</span> 
    <span class="k">def</span> <span class="nf">showstartnr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">findpos</span><span class="p">()</span>
        <span class="n">variabler</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variabler</span><span class="p">}</span>        
        
       
<div class="viewcode-block" id="Newmodel_Mixin.sim2d"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.sim2d">[docs]</a>    <span class="k">def</span> <span class="nf">sim2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">slut</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">antal</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">conv</span><span class="o">=</span><span class="p">[],</span><span class="n">absconv</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">relconv</span><span class="o">=</span><span class="mf">0.0000000000000001</span><span class="p">,</span>
              <span class="n">dumpvar</span><span class="o">=</span><span class="p">[],</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">timeon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fairantal&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to slut (means end in Danish). </span>
<span class="sd">        </span>
<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>
<span class="sd">        </span>
<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">starttimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fairantal</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fairantal&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">slut</span><span class="p">,</span><span class="n">databank</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***** Warning: You are solving the model before all lags are avaiable&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maxlag:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">,</span><span class="s1">&#39;First solveperiod:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;First dataframe index&#39;</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>     
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Will start calculating: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">databank</span><span class="o">=</span><span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>   <span class="c1"># fill all Missing value with 0.0 </span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;matrix&#39;</span><span class="p">]]:</span>
                <span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span>   <span class="c1">#  Make sure columns with matrixes are of this type </span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">True</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;pro2d_jit&#39;</span><span class="p">):</span>  
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create compiled solving function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_los_text2d_jit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_los_text2d_jit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pro2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solve2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epi2d_jit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pro2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solve2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epi2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pro2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solve2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epi2d_jit</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;pro2d_nojit&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create solving function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_los_text2d_nojit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_los_text2d_nojit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pro2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solve2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epi2d_nojit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pro2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solve2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epi2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pro2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solve2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epi2d_nojit</span>
            
            
        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span>   <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
       
        <span class="n">convvar</span> <span class="o">=</span> <span class="p">[</span><span class="n">conv</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conv</span><span class="p">]</span> <span class="k">if</span> <span class="n">conv</span> <span class="o">!=</span> <span class="p">[]</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>  
        <span class="n">convplace</span><span class="o">=</span><span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span> <span class="c1"># this is how convergence is measured  </span>
        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">endoplace</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)]</span>
  
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">convvar</span> <span class="k">if</span> <span class="n">dumpvar</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">dumpvar</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">]</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>
        
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">starttime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fairiteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fairantal</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fairantal</span> <span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fair-Taylor iteration: </span><span class="si">{</span><span class="n">fairiteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">:</span>
                <span class="n">row</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">p</span><span class="p">]</span> 
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">endoplace</span><span class="p">:</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
                <span class="n">itbefore</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convplace</span><span class="p">]</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">pro2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>  <span class="n">row</span> <span class="p">,</span>  <span class="mf">1.0</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">antal</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Evaluate </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span><span class="n">timeon</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">solve2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                    <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">p</span><span class="p">]</span>
                              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">first_test</span><span class="p">:</span> 
                        <span class="n">itafter</span><span class="o">=</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convplace</span><span class="p">]</span> 
                        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">for</span> <span class="n">after</span><span class="p">,</span><span class="n">before</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">itafter</span><span class="p">,</span><span class="n">itbefore</span><span class="p">):</span>
    <span class="c1">#                        print(before,after)</span>
                            <span class="k">if</span> <span class="n">before</span> <span class="o">&gt;</span> <span class="n">absconv</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">after</span><span class="o">-</span><span class="n">before</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="n">relconv</span><span class="p">:</span>
                                <span class="n">convergence</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">break</span> 
                        <span class="k">if</span> <span class="n">convergence</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">itbefore</span><span class="o">=</span><span class="n">itafter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epi2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="mf">1.0</span> <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">convergence</span> <span class="p">:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
           
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="s1">&#39;per&#39;</span><span class="p">,</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="k">if</span> <span class="n">fairantal</span><span class="o">&lt;=</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="n">outdf</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Foating point operations             :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total iterations                     :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total floating point operations      :</span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Floating point operations per second : </span><span class="si">{</span><span class="n">numberfloats</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span> </div>
    


    
<div class="viewcode-block" id="Newmodel_Mixin.grouper"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.grouper">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">grouper</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="s2">&quot;Collect data into fixed-length chunks or blocks&quot;</span>
        <span class="c1"># grouper(&#39;ABCDEFG&#39;, 3, &#39;x&#39;) --&gt; ABC DEF Gxx&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">zip_longest</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">fillvalue</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="Newmodel_Mixin.outsolve2dcunk"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.outsolve2dcunk">[docs]</a>    <span class="k">def</span> <span class="nf">outsolve2dcunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">databank</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span><span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; takes a list of terms and translates to a evaluater function called los</span>
<span class="sd">        </span>
<span class="sd">        The model axcess the data through:Dataframe.value[rowindex+lag,coloumnindex] which is very efficient </span>

<span class="sd">        &#39;&#39;&#39;</span>        
        <span class="n">short</span><span class="p">,</span><span class="n">long</span><span class="p">,</span><span class="n">longer</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">8</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">12</span> <span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="n">columnsnr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_columnsnr</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="n">thisdebug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">thisdebug</span> <span class="o">=</span> <span class="n">debug</span> 
        <span class="c1">#print(f&#39;Generating source for {self.name} using ljit = {ljit} &#39;)</span>
        <span class="k">def</span> <span class="nf">make_gaussline2</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span><span class="n">nodamp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39; takes a list of terms and translates to a line in a gauss-seidel solver for </span>
<span class="sd">            simultanius models</span>
<span class="sd">            the variables            </span>
<span class="sd">            </span>
<span class="sd">            New version to take hand of several lhs variables. Dampning is not allowed for</span>
<span class="sd">            this. But can easely be implemented by makeing a function to multiply tupels</span>
<span class="sd">            nodamp is for pre and epilog solutions, which should not be dampened. </span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">termer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span>
            <span class="n">assigpos</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]</span> 
            <span class="k">if</span> <span class="n">nodamp</span><span class="p">:</span>
                <span class="n">ldamp</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="k">if</span> <span class="s1">&#39;Z&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">]:</span> <span class="c1"># convention for damping equations </span>
                    <span class="k">assert</span> <span class="n">assigpos</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">,</span> <span class="s1">&#39;You can not dampen equations with several left hand sides:&#39;</span><span class="o">+</span><span class="n">vx</span>
                    <span class="n">endovar</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;values[row,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">termer</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">assigpos</span><span class="o">-</span><span class="mi">1</span> <span class="p">]</span>
                    <span class="n">damp</span><span class="o">=</span><span class="s1">&#39;(1-alfa)*(&#39;</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">endovar</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)+alfa*(&#39;</span>      <span class="c1"># to implemet dampning of solution</span>
                    <span class="n">ldamp</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ldamp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">termer</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span> <span class="c1"># drop the trailing $</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">assigpos</span> <span class="ow">and</span> <span class="n">ldamp</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">damp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">assigpos</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;values[row&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span> <span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;values[row&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span> <span class="p">)</span> 
        
            <span class="k">if</span> <span class="n">ldamp</span><span class="p">:</span> <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span> <span class="c1"># the last ) in the dampening </span>
            <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            
        <span class="k">def</span> <span class="nf">make_resline2</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span><span class="n">nodamp</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39; takes a list of terms and translates to a line calculating linne</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">termer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span>
            <span class="n">assigpos</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]</span> 
            <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">termer</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span> <span class="c1"># drop the trailing $</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                    <span class="n">lag</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">assigpos</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;outvalues[row&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span> <span class="p">)</span>              
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;values[row&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span> <span class="p">)</span>              
            <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>


        <span class="k">def</span> <span class="nf">makeafunk</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">linemake</span><span class="p">,</span><span class="n">chunknumber</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overhead</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">,</span><span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nodamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">totalchunk</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39; creates the source of  an evaluation function </span>
<span class="sd">            keeps tap of how many equations and lines is in the functions abowe. </span>
<span class="sd">            This allows the errorfunction to retriewe the variable for which a math error is thrown </span>
<span class="sd">            </span>
<span class="sd">            &#39;&#39;&#39;</span> 
            <span class="n">fib1</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">fib2</span><span class="o">=</span><span class="p">[]</span>
            
            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">short</span><span class="o">+</span><span class="s1">&#39;print(&quot;&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;Compiling chunk </span><span class="si">{</span><span class="n">chunknumber</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">totalchunk</span><span class="si">}</span><span class="s2">     &quot;</span><span class="o">+</span><span class="s1">&#39;&quot;,time.strftime(&quot;%H:%M:%S&quot;)) </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ljit</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span><span class="o">+</span><span class="s1">&#39;@jit(&quot;(f8[:,:],f8[:,:],i8,f8)&quot;,fastmath=True)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;def &#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;(values,outvalues,row,alfa=1.0):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#            fib1.append(long + &#39;outvalues = values \n&#39;)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span><span class="s1">&#39;try :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longer</span><span class="o">+</span><span class="s1">&#39;pass</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">newoverhead</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fib1</span><span class="p">)</span> <span class="o">+</span> <span class="n">overhead</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">longer</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;pass  # &#39;</span><span class="o">+</span><span class="n">v</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]</span>
                       <span class="k">else</span> <span class="n">linemake</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">nodamp</span><span class="p">))</span>   
                           <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">order</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>   
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span> <span class="s1">&#39;except :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longer</span> <span class="o">+</span><span class="sa">f</span><span class="s1">&#39;errorfunk(values,sys.exc_info()[2].tb_lineno,overhead=</span><span class="si">{</span><span class="n">newoverhead</span><span class="si">}</span><span class="s1">,overeq=</span><span class="si">{</span><span class="n">oldeqs</span><span class="si">}</span><span class="s1">)&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longer</span> <span class="o">+</span> <span class="s1">&#39;raise</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">long</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="n">longer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;return </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">neweq</span> <span class="o">=</span> <span class="n">oldeqs</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">fib1</span><span class="p">,</span><span class="n">content</span><span class="p">,</span><span class="n">fib2</span><span class="p">)),</span><span class="n">newoverhead</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">fib2</span><span class="p">),</span><span class="n">neweq</span>

        <span class="k">def</span> <span class="nf">makechunkedfunk</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">linemake</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overhead</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">,</span><span class="n">oldeqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">nodamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39; makes the complete function to evaluate the model. </span>
<span class="sd">            keeps the tab on previous overhead lines and equations, to helt the error function &#39;&#39;&#39;</span>

            <span class="n">newoverhead</span> <span class="o">=</span> <span class="n">overhead</span>
            <span class="n">neweqs</span> <span class="o">=</span> <span class="n">oldeqs</span> 
            <span class="k">if</span> <span class="n">chunk</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">orderlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">orderlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grouper</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">chunk</span><span class="p">))</span>
            <span class="n">fib</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">fib2</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orderlist</span><span class="p">):</span>
                <span class="n">lines</span><span class="p">,</span><span class="n">head</span><span class="p">,</span><span class="n">eques</span>  <span class="o">=</span> <span class="n">makeafunk</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">o</span><span class="p">,</span><span class="n">linemake</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span><span class="n">overhead</span><span class="o">=</span><span class="n">newoverhead</span><span class="p">,</span><span class="n">nodamp</span><span class="o">=</span><span class="n">nodamp</span><span class="p">,</span>
                                              <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">oldeqs</span><span class="o">=</span><span class="n">neweqs</span><span class="p">,</span><span class="n">totalchunk</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">orderlist</span><span class="p">))</span>
                <span class="n">fib</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="n">newoverhead</span> <span class="o">=</span> <span class="n">head</span> 
                <span class="n">neweqs</span> <span class="o">=</span> <span class="n">eques</span>
            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">short</span><span class="o">+</span><span class="s1">&#39;print(&quot;&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;Compiling a mastersolver     &quot;</span><span class="o">+</span><span class="s1">&#39;&quot;,time.strftime(&quot;%H:%M:%S&quot;)) </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ljit</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span><span class="o">+</span><span class="s1">&#39;@jit(&quot;(f8[:,:],f8[:,:],i8,f8)&quot;,fastmath=True,cache=False)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                 
            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;def &#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;(values,outvalues,row,alfa=1.0):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#            fib2.append(long + &#39;outvalues = values \n&#39;)</span>
            <span class="n">tt</span> <span class="o">=</span><span class="p">[</span><span class="n">long</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;(values,outvalues,row,alfa=alfa)</span><span class="se">\n</span><span class="s1">&#39;</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ch</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orderlist</span><span class="p">)]</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tt</span> <span class="p">)</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span><span class="s1">&#39;return  </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">fib</span><span class="o">+</span><span class="n">fib2</span><span class="p">,</span><span class="n">newoverhead</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">fib2</span><span class="p">),</span><span class="n">neweqs</span>
                
                
            
        <span class="n">linemake</span> <span class="o">=</span>  <span class="n">make_resline2</span> <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;res&#39;</span> <span class="k">else</span> <span class="n">make_gaussline2</span> 
        <span class="n">fib2</span> <span class="o">=</span><span class="p">[]</span>
        <span class="n">fib1</span> <span class="o">=</span>     <span class="p">[</span><span class="s1">&#39;def make_los(funks=[],errorfunk=None):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;import time&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from numba import jit&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modeluserfunk import &#39;</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">userfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modelBLfunk import &#39;</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">BLfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">funktext</span> <span class="o">=</span>  <span class="p">[</span><span class="n">short</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; = funks[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)]</span>      
        <span class="n">fib1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">funktext</span><span class="p">)</span>
        
        
        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;make model text&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_preorder</span><span class="p">:</span>
                <span class="n">procontent</span><span class="p">,</span><span class="n">prooverhead</span><span class="p">,</span><span class="n">proeqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;prolog&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">preorder</span><span class="p">,</span><span class="n">linemake</span> <span class="p">,</span><span class="n">overhead</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fib1</span><span class="p">),</span><span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">content</span><span class="p">,</span><span class="n">conoverhead</span><span class="p">,</span><span class="n">coneqs</span>    <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;los&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span><span class="n">linemake</span> <span class="p">,</span><span class="n">overhead</span><span class="o">=</span><span class="n">prooverhead</span><span class="p">,</span><span class="n">oldeqs</span><span class="o">=</span><span class="n">proeqs</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">epilog</span> <span class="p">,</span><span class="n">epioverhead</span><span class="p">,</span><span class="n">epieqs</span>    <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;epilog&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epiorder</span><span class="p">,</span><span class="n">linemake</span> <span class="p">,</span><span class="n">overhead</span> <span class="o">=</span><span class="n">conoverhead</span><span class="p">,</span><span class="n">oldeqs</span><span class="o">=</span><span class="n">coneqs</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span><span class="n">nodamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">procontent</span><span class="p">,</span><span class="n">prooverhead</span><span class="p">,</span><span class="n">proeqs</span>  <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;prolog&#39;</span><span class="p">,[],</span><span class="n">linemake</span> <span class="p">,</span><span class="n">overhead</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fib1</span><span class="p">),</span><span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">content</span><span class="p">,</span><span class="n">conoverhead</span><span class="p">,</span><span class="n">coneqs</span>    <span class="o">=</span>  <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;los&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">,</span><span class="n">linemake</span> <span class="p">,</span><span class="n">overhead</span><span class="o">=</span><span class="n">prooverhead</span><span class="p">,</span><span class="n">oldeqs</span><span class="o">=</span><span class="n">proeqs</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">epilog</span> <span class="p">,</span><span class="n">epioverhead</span><span class="p">,</span><span class="n">epieqs</span>    <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;epilog&#39;</span><span class="p">,[],</span><span class="n">linemake</span> <span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">overhead</span> <span class="o">=</span><span class="n">conoverhead</span><span class="p">,</span><span class="n">oldeqs</span><span class="o">=</span><span class="n">coneqs</span><span class="p">)</span>
                
        <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;return prolog,los,epilog</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">fib1</span><span class="p">,</span><span class="n">procontent</span><span class="p">,</span><span class="n">content</span><span class="p">,</span><span class="n">epilog</span><span class="p">,</span><span class="n">fib2</span><span class="p">))</span>   </div>
    
<div class="viewcode-block" id="Newmodel_Mixin.sim1d"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.sim1d">[docs]</a>    <span class="k">def</span> <span class="nf">sim1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">slut</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">antal</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">conv</span><span class="o">=</span><span class="p">[],</span><span class="n">absconv</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">relconv</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span>
              <span class="n">dumpvar</span><span class="o">=</span><span class="p">[],</span><span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
              <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fairantal&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="n">timeon</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to slut (means end in Danish). </span>
<span class="sd">        </span>
<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>
<span class="sd">        </span>
<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">starttimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fairantal</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fairantal&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">slut</span><span class="p">,</span><span class="n">databank</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***** Warning: You are solving the model before all lags are avaiable&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maxlag:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">,</span><span class="s1">&#39;First solveperiod:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;First dataframe index&#39;</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>   
            
        <span class="bp">self</span><span class="o">.</span><span class="n">findpos</span><span class="p">()</span>
        <span class="n">databank</span> <span class="o">=</span> <span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>   <span class="c1"># fill all Missing value with 0.0 </span>
            
        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;create stuffer and gauss lines &#39;</span><span class="p">,</span><span class="n">timeon</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>        
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;stuff3&#39;</span><span class="p">))</span> <span class="ow">or</span>  <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simcolumns</span><span class="p">,</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stuff3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">saveeval3</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createstuff3</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simcolumns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Create solver function&#39;</span><span class="p">,</span><span class="n">timeon</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                   <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;solve1d_jit&#39;</span><span class="p">):</span> 
                       <span class="bp">self</span><span class="o">.</span><span class="n">make_los_text1d</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve1dcunk</span><span class="p">(</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> 
                              <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">cache</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache&#39;</span><span class="p">,</span><span class="s1">&#39;False&#39;</span><span class="p">))</span>
                       <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_los_text1d</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pro1d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solve1d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epi1d_jit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
                   <span class="n">this_pro1d</span><span class="p">,</span><span class="n">this_solve1d</span><span class="p">,</span><span class="n">this_epi1d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pro1d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solve1d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epi1d_jit</span>
            <span class="k">else</span><span class="p">:</span>  
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;solve1d&#39;</span><span class="p">):</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">make_los_text1d</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve1dcunk</span><span class="p">(</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_los_text1d</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pro1d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solve1d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epi1d_nojit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk1d</span><span class="p">)</span>
 
                    <span class="n">this_pro1d</span><span class="p">,</span><span class="n">this_solve1d</span><span class="p">,</span><span class="n">this_epi1d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pro1d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solve1d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epi1d_nojit</span>                

        <span class="n">values</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_</span> <span class="o">=</span> <span class="n">values</span> <span class="c1"># for use in errdump </span>
              
        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span>   <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
       
        <span class="n">convvar</span> <span class="o">=</span> <span class="p">[</span><span class="n">conv</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conv</span><span class="p">]</span> <span class="k">if</span> <span class="n">conv</span> <span class="o">!=</span> <span class="p">[]</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>  
<span class="c1">#        convplace=[databank.columns.get_loc(c) for c in convvar] # this is how convergence is measured  </span>
        <span class="n">convplace</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;maxlead&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span>
        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>
 
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">convvar</span> <span class="k">if</span> <span class="n">dumpvar</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">dumpvar</span><span class="p">)</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;maxlead&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>

        
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">starttime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fairiteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fairantal</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fairantal</span> <span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fair-Taylor iteration: </span><span class="si">{</span><span class="n">fairiteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">:</span>
                <span class="n">row</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">row_</span> <span class="o">=</span> <span class="n">row</span>
                <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;stuff </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span><span class="n">timeon</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span> 
                    <span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stuff3</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">row</span><span class="p">,</span><span class="n">ljit</span><span class="p">)</span>
<span class="c1">#                  </span>
                <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> 
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
    
                <span class="n">itbefore</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convplace</span><span class="p">]</span> 
                <span class="n">this_pro1d</span><span class="p">(</span><span class="n">a</span><span class="p">,</span>  <span class="mf">1.0</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">antal</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Evaluate </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span><span class="n">timeon</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span> 
                        <span class="n">this_solve1d</span><span class="p">(</span><span class="n">a</span><span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                    <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">first_test</span><span class="p">:</span> 
                        <span class="n">itafter</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convplace</span><span class="p">]</span> 
                        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">for</span> <span class="n">after</span><span class="p">,</span><span class="n">before</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">itafter</span><span class="p">,</span><span class="n">itbefore</span><span class="p">):</span>
    <span class="c1">#                        print(before,after)</span>
                            <span class="k">if</span> <span class="n">before</span> <span class="o">&gt;</span> <span class="n">absconv</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">after</span><span class="o">-</span><span class="n">before</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="n">relconv</span><span class="p">:</span>
                                <span class="n">convergence</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">break</span> 
                        <span class="k">if</span> <span class="n">convergence</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">itbefore</span><span class="o">=</span><span class="n">itafter</span>
                <span class="n">this_epi1d</span><span class="p">(</span><span class="n">a</span> <span class="p">,</span>  <span class="mf">1.0</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saveeval3</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">row</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">convergence</span> <span class="p">:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
           
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="s1">&#39;per&#39;</span><span class="p">,</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;per&#39;</span><span class="p">,</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="s1">&#39;iteration&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">fairantal</span><span class="o">&lt;=</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="n">outdf</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_</span> <span class="c1"># not needed any more </span>
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Foating point operations             :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total iterations                     :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total floating point operations      :</span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Floating point operations per second : </span><span class="si">{</span><span class="n">numberfloats</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span> </div>
    
    
<div class="viewcode-block" id="Newmodel_Mixin.outsolve1dcunk"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.outsolve1dcunk">[docs]</a>    <span class="k">def</span> <span class="nf">outsolve1dcunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cache</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; takes a list of terms and translates to a evaluater function called los</span>
<span class="sd">        </span>
<span class="sd">        The model axcess the data through:Dataframe.value[rowindex+lag,coloumnindex] which is very efficient </span>

<span class="sd">        &#39;&#39;&#39;</span>        
        <span class="n">short</span><span class="p">,</span><span class="n">long</span><span class="p">,</span><span class="n">longer</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">8</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">12</span> <span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">findpos</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="n">thisdebug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">thisdebug</span> <span class="o">=</span> <span class="n">debug</span> 
        
        
           

        <span class="k">def</span> <span class="nf">makeafunk</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">linemake</span><span class="p">,</span><span class="n">chunknumber</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overhead</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">,</span><span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nodamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">totalchunk</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39; creates the source of  an evaluation function </span>
<span class="sd">            keeps tap of how many equations and lines is in the functions abowe. </span>
<span class="sd">            This allows the errorfunction to retriewe the variable for which a math error is thrown </span>
<span class="sd">            </span>
<span class="sd">            &#39;&#39;&#39;</span> 
            <span class="n">fib1</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">fib2</span><span class="o">=</span><span class="p">[]</span>
            
            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">short</span><span class="o">+</span><span class="s1">&#39;print(&quot;&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;Compiling chunk </span><span class="si">{</span><span class="n">chunknumber</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">totalchunk</span><span class="si">}</span><span class="s2">     &quot;</span><span class="o">+</span><span class="s1">&#39;&quot;,time.strftime(&quot;%H:%M:%S&quot;)) </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ljit</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;@jit(&quot;(f8[:],f8)&quot;,fastmath=True,cache=</span><span class="si">{</span><span class="n">cache</span><span class="si">}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;def &#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;(a,alfa=1.0):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#            fib1.append(long + &#39;outvalues = values \n&#39;)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span><span class="s1">&#39;try :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longer</span><span class="o">+</span><span class="s1">&#39;pass</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">newoverhead</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fib1</span><span class="p">)</span> <span class="o">+</span> <span class="n">overhead</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">longer</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;pass  # &#39;</span><span class="o">+</span><span class="n">v</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]</span>
                       <span class="k">else</span> <span class="n">linemake</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">nodamp</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>   
                           <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">order</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>   
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span> <span class="s1">&#39;except :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longer</span> <span class="o">+</span><span class="sa">f</span><span class="s1">&#39;errorfunk(a,sys.exc_info()[2].tb_lineno,overhead=</span><span class="si">{</span><span class="n">newoverhead</span><span class="si">}</span><span class="s1">,overeq=</span><span class="si">{</span><span class="n">oldeqs</span><span class="si">}</span><span class="s1">)&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longer</span> <span class="o">+</span> <span class="s1">&#39;raise</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">long</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="n">longer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;return </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">neweq</span> <span class="o">=</span> <span class="n">oldeqs</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">fib1</span><span class="p">,</span><span class="n">content</span><span class="p">,</span><span class="n">fib2</span><span class="p">)),</span><span class="n">newoverhead</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">fib2</span><span class="p">),</span><span class="n">neweq</span>

        <span class="k">def</span> <span class="nf">makechunkedfunk</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">linemake</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overhead</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">,</span><span class="n">oldeqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">nodamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39; makes the complete function to evaluate the model. </span>
<span class="sd">            keeps the tab on previous overhead lines and equations, to helt the error function &#39;&#39;&#39;</span>

            <span class="n">newoverhead</span> <span class="o">=</span> <span class="n">overhead</span>
            <span class="n">neweqs</span> <span class="o">=</span> <span class="n">oldeqs</span> 
            <span class="k">if</span> <span class="n">chunk</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">orderlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">orderlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grouper</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">chunk</span><span class="p">))</span>
            <span class="n">fib</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">fib2</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orderlist</span><span class="p">):</span>
                <span class="n">lines</span><span class="p">,</span><span class="n">head</span><span class="p">,</span><span class="n">eques</span>  <span class="o">=</span> <span class="n">makeafunk</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">o</span><span class="p">,</span><span class="n">linemake</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span><span class="n">overhead</span><span class="o">=</span><span class="n">newoverhead</span><span class="p">,</span><span class="n">nodamp</span><span class="o">=</span><span class="n">nodamp</span><span class="p">,</span>
                                              <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">oldeqs</span><span class="o">=</span><span class="n">neweqs</span><span class="p">,</span><span class="n">totalchunk</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">orderlist</span><span class="p">))</span>
                <span class="n">fib</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="n">newoverhead</span> <span class="o">=</span> <span class="n">head</span> 
                <span class="n">neweqs</span> <span class="o">=</span> <span class="n">eques</span>
            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">short</span><span class="o">+</span><span class="s1">&#39;print(&quot;&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;Compiling a mastersolver     &quot;</span><span class="o">+</span><span class="s1">&#39;&quot;,time.strftime(&quot;%H:%M:%S&quot;)) </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ljit</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;@jit(&quot;(f8[:],f8)&quot;,fastmath=True,cache=</span><span class="si">{</span><span class="n">cache</span><span class="si">}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                 
            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;def &#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;(a,alfa=1.0):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#            fib2.append(long + &#39;outvalues = values \n&#39;)</span>
            <span class="n">tt</span> <span class="o">=</span><span class="p">[</span><span class="n">long</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;(a,alfa=alfa)</span><span class="se">\n</span><span class="s1">&#39;</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ch</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orderlist</span><span class="p">)]</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tt</span> <span class="p">)</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span><span class="s1">&#39;return  </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">fib</span><span class="o">+</span><span class="n">fib2</span><span class="p">,</span><span class="n">newoverhead</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">fib2</span><span class="p">),</span><span class="n">neweqs</span>
                
                
            
        <span class="n">linemake</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">make_gaussline</span>  
        <span class="n">fib2</span> <span class="o">=</span><span class="p">[]</span>
        <span class="n">fib1</span> <span class="o">=</span>     <span class="p">[</span><span class="s1">&#39;def make_los(funks=[],errorfunk=None):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;import time&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from numba import jit&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
       
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modeluserfunk import &#39;</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">userfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modelBLfunk import &#39;</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">BLfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">funktext</span> <span class="o">=</span>  <span class="p">[</span><span class="n">short</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; = funks[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)]</span>      
        <span class="n">fib1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">funktext</span><span class="p">)</span>
        
        
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_preorder</span><span class="p">:</span>
            <span class="n">procontent</span><span class="p">,</span><span class="n">prooverhead</span><span class="p">,</span><span class="n">proeqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;prolog&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">preorder</span><span class="p">,</span><span class="n">linemake</span> <span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fib1</span><span class="p">),</span>   <span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>     <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">content</span><span class="p">,</span><span class="n">conoverhead</span><span class="p">,</span><span class="n">coneqs</span>    <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;los&#39;</span><span class="p">,</span>   <span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span><span class="n">linemake</span> <span class="p">,</span><span class="n">overhead</span><span class="o">=</span><span class="n">prooverhead</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="n">proeqs</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">epilog</span> <span class="p">,</span><span class="n">epioverhead</span><span class="p">,</span><span class="n">epieqs</span>    <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;epilog&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epiorder</span><span class="p">,</span> <span class="n">linemake</span> <span class="p">,</span><span class="n">overhead</span> <span class="o">=</span><span class="n">conoverhead</span><span class="p">,</span><span class="n">oldeqs</span><span class="o">=</span><span class="n">coneqs</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span><span class="n">nodamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">procontent</span><span class="p">,</span><span class="n">prooverhead</span><span class="p">,</span><span class="n">proeqs</span>  <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;prolog&#39;</span><span class="p">,[],</span>            <span class="n">linemake</span> <span class="p">,</span><span class="n">overhead</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fib1</span><span class="p">),</span>  <span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>      <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">content</span><span class="p">,</span><span class="n">conoverhead</span><span class="p">,</span><span class="n">coneqs</span>     <span class="o">=</span>  <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;los&#39;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">,</span><span class="n">linemake</span> <span class="p">,</span><span class="n">overhead</span><span class="o">=</span><span class="n">prooverhead</span><span class="p">,</span><span class="n">oldeqs</span><span class="o">=</span><span class="n">proeqs</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">epilog</span> <span class="p">,</span><span class="n">epioverhead</span><span class="p">,</span><span class="n">epieqs</span>     <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;epilog&#39;</span><span class="p">,[]</span>             <span class="p">,</span><span class="n">linemake</span> <span class="p">,</span><span class="n">overhead</span> <span class="o">=</span><span class="n">conoverhead</span><span class="p">,</span><span class="n">oldeqs</span><span class="o">=</span><span class="n">coneqs</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            
        <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;return prolog,los,epilog</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">fib1</span><span class="p">,</span><span class="n">procontent</span><span class="p">,</span><span class="n">content</span><span class="p">,</span><span class="n">epilog</span><span class="p">,</span><span class="n">fib2</span><span class="p">))</span>   </div>
    
  
<div class="viewcode-block" id="Newmodel_Mixin.errfunk1d"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.errfunk1d">[docs]</a>    <span class="k">def</span> <span class="nf">errfunk1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">linenr</span><span class="p">,</span><span class="n">overhead</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">overeq</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Handle errors in sim1d &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveeval3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values_</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">row_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values_</span><span class="p">,</span><span class="n">linenr</span><span class="p">,</span><span class="n">overhead</span><span class="p">,</span><span class="n">overeq</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Newmodel_Mixin.errfunk"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.errfunk">[docs]</a>    <span class="k">def</span> <span class="nf">errfunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">values</span><span class="p">,</span><span class="n">linenr</span><span class="p">,</span><span class="n">overhead</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">overeq</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; developement function</span>
<span class="sd">        </span>
<span class="sd">        to handle run time errors in model calculations&#39;&#39;&#39;</span>
        
<span class="c1">#        winsound.Beep(500,1000)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errdump</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errdump</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; Error in     :&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; In           :&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; Linenr       :&#39;</span><span class="p">,</span><span class="n">linenr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; Overhead   :&#39;</span><span class="p">,</span><span class="n">overhead</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; over eq   :&#39;</span><span class="p">,</span><span class="n">overeq</span><span class="p">)</span>
        <span class="n">varposition</span> <span class="o">=</span> <span class="n">linenr</span><span class="o">-</span><span class="n">overhead</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">overeq</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; varposition   :&#39;</span><span class="p">,</span><span class="n">varposition</span><span class="p">)</span>
        
        <span class="n">errvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">[</span><span class="n">varposition</span><span class="p">]</span>
        <span class="n">outeq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">errvar</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; Equation     :&#39;</span><span class="p">,</span><span class="n">outeq</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A snapshot of the data at the error point is at .errdump &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Also the .lastdf contains .errdump,  for inspecting &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_eq_values</span><span class="p">(</span><span class="n">errvar</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errdump</span><span class="p">,</span><span class="n">per</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;dumplist&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="s1">&#39;per&#39;</span><span class="p">,</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span></div>

    <span class="k">pass</span>

<div class="viewcode-block" id="Newmodel_Mixin.newton1per"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.newton1per">[docs]</a>    <span class="k">def</span> <span class="nf">newton1per</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">slut</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">antal</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">conv</span><span class="o">=</span><span class="p">[],</span><span class="n">absconv</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">relconv</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">nonlin</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span><span class="n">timeit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">reset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">dumpvar</span><span class="o">=</span><span class="p">[],</span><span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
              <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fairantal&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to slut (means end in Danish). </span>
<span class="sd">        </span>
<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>
<span class="sd">        </span>
<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="c1">#    print(&#39;new nwwton&#39;)</span>
        <span class="n">starttimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fairantal</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fairantal&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">slut</span><span class="p">,</span><span class="n">databank</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***** Warning: You are solving the model before all lags are avaiable&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maxlag:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">,</span><span class="s1">&#39;First solveperiod:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;First dataframe index&#39;</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>     
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Will start calculating: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="c1">#        if not samedata or not hasattr(self,&#39;new2d&#39;) :</span>
<span class="c1">#           if (not hasattr(self,&#39;solvenew2d&#39;)) or (not self.eqcolumns(self.genrcolumns,databank.columns)):</span>
<span class="c1">#                databank=insertModelVar(databank,self)   # fill all Missing value with 0.0 </span>
<span class="c1">#                for i in [j for j in self.allvar.keys() if self.allvar[j][&#39;matrix&#39;]]:</span>
<span class="c1">#                    databank.loc[:,i]=databank.loc[:,i].astype(&#39;O&#39;)   #  Make sure columns with matrixes are of this type </span>
<span class="c1">#    </span>
<span class="c1">#                self.make_new_text2d =  self.outsolve2dcunk(databank,chunk=chunk,</span>
<span class="c1">#                      ljit=ljit, debug=kwargs.get(&#39;debug&#39;,1),type=&#39;res&#39;)</span>
<span class="c1">#                exec(self.make_new_text2d,globals())  # creates the los function</span>
<span class="c1">#                self.pronew2d,self.solvenew2d,self.epinew2d  = make_los(self.funks,self.errfunk)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">databank</span><span class="o">=</span><span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>   <span class="c1"># fill all Missing value with 0.0 </span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;matrix&#39;</span><span class="p">]]:</span>
                <span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span>   <span class="c1">#  Make sure columns with matrixes are of this type </span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">True</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;pronew2d_jit&#39;</span><span class="p">):</span>  
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create compiled solving function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_jit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_jit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_jit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_jit</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;pronew2d_nojit&#39;</span><span class="p">):</span>  
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create solving function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_nojit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_nojit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_nojit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_nojit</span>

                
        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="c1"># </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;newton_diff&#39;</span><span class="p">):</span>
            <span class="n">endovar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_preorder</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_diff</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">forcenum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span>
                                           <span class="n">endovar</span> <span class="o">=</span> <span class="n">endovar</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">nchunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">onlyendocur</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;newton_1per_solver&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">reset</span><span class="p">:</span>
            <span class="c1"># breakpoint()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_diff</span><span class="o">.</span><span class="n">get_solve1per</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">newton_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_diff</span><span class="o">.</span><span class="n">endovar</span><span class="p">]</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span>   <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
       
        <span class="n">convvar</span> <span class="o">=</span> <span class="p">[</span><span class="n">conv</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conv</span><span class="p">]</span> <span class="k">if</span> <span class="n">conv</span> <span class="o">!=</span> <span class="p">[]</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>  
        <span class="n">convplace</span><span class="o">=</span><span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span> <span class="c1"># this is how convergence is measured  </span>
        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>
     
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">convvar</span> <span class="k">if</span> <span class="n">dumpvar</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">dumpvar</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">]</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>
        
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
        <span class="n">starttime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fairiteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fairantal</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fairantal</span> <span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fair-Taylor iteration: </span><span class="si">{</span><span class="n">fairiteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">:</span>
                <span class="n">row</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">p</span><span class="p">]</span> 
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
    
                <span class="n">itbefore</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convplace</span><span class="p">]</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>  <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">antal</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sim per:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> it:</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">xxtt</span><span class="p">:</span>
                        <span class="n">before</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">newton_col</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                        <span class="n">now</span>   <span class="o">=</span> <span class="n">outvalues</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">newton_col</span><span class="p">]</span>
                        <span class="n">distance</span> <span class="o">=</span> <span class="n">now</span><span class="o">-</span><span class="n">before</span>
                        <span class="n">newton_conv</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> sum of distances </span><span class="si">{</span><span class="n">newton_conv</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">newton_conv</span> <span class="o">&lt;=</span> <span class="mf">0.000001</span> <span class="p">:</span>
                            <span class="k">break</span> 
                        <span class="c1"># breakpoint()</span>
                        <span class="k">if</span> <span class="n">iteration</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nonlin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">%</span> <span class="n">nonlin</span><span class="p">):</span>
                            <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Updating solver&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t3</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updating solver, iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">df_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_diff</span><span class="o">.</span><span class="n">get_solve1per</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_now</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">]</span>
                            
                        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Update solution&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                <span class="c1">#            update = self.solveinv(distance)</span>
                            <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_solver</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">newton_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">before</span> <span class="o">-</span> <span class="n">update</span>
    
                    <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">p</span><span class="p">]</span>
                              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
    <span class="c1">#                if iteration &gt; first_test: </span>
    <span class="c1">#                    itafter=[values[row,c] for c in convplace] </span>
    <span class="c1">#                    convergence = True</span>
    <span class="c1">#                    for after,before in zip(itafter,itbefore):</span>
    <span class="c1">##                        print(before,after)</span>
    <span class="c1">#                        if before &gt; absconv and abs(after-before)/abs(before)  &gt; relconv:</span>
    <span class="c1">#                            convergence = False</span>
    <span class="c1">#                            break </span>
    <span class="c1">#                    if convergence:</span>
    <span class="c1">#                        break</span>
    <span class="c1">#                    else:</span>
    <span class="c1">#                        itbefore=itafter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
    
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">convergence</span> <span class="p">:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
           
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="s1">&#39;per&#39;</span><span class="p">,</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="k">if</span> <span class="n">fairantal</span><span class="o">&lt;=</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="n">outdf</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Foating point operations             :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total iterations                     :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total floating point operations      :</span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Floating point operations per second : </span><span class="si">{</span><span class="n">numberfloats</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span> </div>

<div class="viewcode-block" id="Newmodel_Mixin.newtonstack"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.newtonstack">[docs]</a>    <span class="k">def</span> <span class="nf">newtonstack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">slut</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">antal</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">conv</span><span class="o">=</span><span class="p">[],</span><span class="n">absconv</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">relconv</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span>
              <span class="n">dumpvar</span><span class="o">=</span><span class="p">[],</span><span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nchunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nljit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
              <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fairantal&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">timeit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nonlin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nonlinfirst</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
              <span class="n">newtonalfa</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="n">newtonnodamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">forcenum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">reset</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to slut (means end in Danish). </span>
<span class="sd">        </span>
<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>
<span class="sd">        </span>
<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="c1">#    print(&#39;new nwwton&#39;)</span>
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">diffcount</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">starttimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fairantal</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fairantal&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">slut</span><span class="p">,</span><span class="n">databank</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***** Warning: You are solving the model before all lags are avaiable&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maxlag:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">,</span><span class="s1">&#39;First solveperiod:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;First dataframe index&#39;</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>     
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Will start calculating: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="c1">#        if not samedata or not hasattr(self,&#39;solve2d&#39;) :</span>
<span class="c1">#           if (not hasattr(self,&#39;solvestack2d&#39;)) or (not self.eqcolumns(self.genrcolumns,databank.columns)):</span>
<span class="c1">#                databank=insertModelVar(databank,self)   # fill all Missing value with 0.0 </span>
<span class="c1">#                for i in [j for j in self.allvar.keys() if self.allvar[j][&#39;matrix&#39;]]:</span>
<span class="c1">#                    databank.loc[:,i]=databank.loc[:,i].astype(&#39;O&#39;)   #  Make sure columns with matrixes are of this type </span>
<span class="c1">#    </span>
<span class="c1">#                self.make_losstack_text2d =  self.outsolve2dcunk(databank,chunk=chunk,</span>
<span class="c1">#                      ljit=ljit, debug=debug,type=&#39;res&#39;)</span>
<span class="c1">#                exec(self.make_losstack_text2d,globals())  # creates the los function</span>
<span class="c1">#                self.prostack2d,self.solvestack2d,self.epistack2d  = make_los(self.funks,self.errfunk)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">databank</span><span class="o">=</span><span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>   <span class="c1"># fill all Missing value with 0.0 </span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;matrix&#39;</span><span class="p">]]:</span>
                <span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span>   <span class="c1">#  Make sure columns with matrixes are of this type </span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">True</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;pronew2d_jit&#39;</span><span class="p">):</span>  
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create compiled solving function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_jit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_jit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_jit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_jit</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;pronew2d_nojit&#39;</span><span class="p">):</span>  
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create solving function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_nojit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_nojit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_nojit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_nojit</span>


                
        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="c1"># </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;newton_diff_stack&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">forcenum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">nljit</span><span class="p">,</span><span class="n">nchunk</span><span class="o">=</span><span class="n">nchunk</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;stacksolver&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">get_solvestacked</span>
            <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating new derivatives and new solver&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span> <span class="o">=</span> <span class="n">sol_periode</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">reset</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="n">sol_periode</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="p">:</span>   
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating new solver&#39;</span><span class="p">)</span>
            <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span> <span class="o">=</span> <span class="n">sol_periode</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">newton_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">endovar</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">timeit</span> <span class="o">=</span> <span class="n">timeit</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span>   <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
       
        <span class="n">convvar</span> <span class="o">=</span> <span class="p">[</span><span class="n">conv</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conv</span><span class="p">]</span> <span class="k">if</span> <span class="n">conv</span> <span class="o">!=</span> <span class="p">[]</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>  
        <span class="n">convplace</span><span class="o">=</span><span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span> <span class="c1"># this is how convergence is measured  </span>
        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">False</span>
     
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">convvar</span> <span class="k">if</span> <span class="n">dumpvar</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">dumpvar</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">]</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>
        
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
        <span class="n">starttime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="o">=</span><span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">r</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">newton_col</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">newton_col</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
       <span class="c1"># breakpoint()</span>

        
<span class="c1">#                if ldumpvar:</span>
<span class="c1">#                    self.dumplist.append([fairiteration,self.periode,int(0)]+[values[row,p] </span>
<span class="c1">#                        for p in dumpplac])</span>

<span class="c1">#        itbefore = values[self.stackrows,convplace] </span>
<span class="c1">#        self.pro2d(values, values,  row ,  alfa )</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">antal</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Newton it:</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">xxtt</span><span class="p">:</span>
                <span class="n">before</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span><span class="p">]</span>
                <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;calculate new solution&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t2</span><span class="p">:</span>                
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                        <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;extract new solution&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t2</span><span class="p">:</span>                
                    <span class="n">now</span>   <span class="o">=</span> <span class="n">outvalues</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span><span class="p">]</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">now</span><span class="o">-</span><span class="n">before</span>
                <span class="n">newton_conv</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Iteration  </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> Sum of distances </span><span class="si">{</span><span class="n">newton_conv</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="mi">15</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="mi">6</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newton_conv</span> <span class="o">&lt;=</span> <span class="mf">0.001</span> <span class="p">:</span>
                    <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span> 
                    <span class="k">break</span> 
                <span class="k">if</span> <span class="n">iteration</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nonlin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">%</span> <span class="n">nonlin</span><span class="p">)</span> <span class="ow">or</span> <span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">nonlinfirst</span> <span class="p">:</span>
                    <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Updating solver&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t3</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updating solver, iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">df_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_now</span><span class="p">)</span>
                        <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>
                        
                    
                <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Update solution&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">):</span>
        <span class="c1">#            update = self.solveinv(distance)</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
                    <span class="n">damp</span> <span class="o">=</span> <span class="n">newtonalfa</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">newtonnodamp</span> <span class="k">else</span> <span class="mf">1.0</span> 
                <span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">before</span> <span class="o">-</span> <span class="n">damp</span> <span class="o">*</span> <span class="n">update</span>

                    
                <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">p</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
    <span class="c1">#                if iteration &gt; first_test: </span>
    <span class="c1">#                    itafter=[values[row,c] for c in convplace] </span>
    <span class="c1">#                    convergence = True</span>
    <span class="c1">#                    for after,before in zip(itafter,itbefore):</span>
    <span class="c1">##                        print(before,after)</span>
    <span class="c1">#                        if before &gt; absconv and abs(after-before)/abs(before)  &gt; relconv:</span>
    <span class="c1">#                            convergence = False</span>
    <span class="c1">#                            break </span>
    <span class="c1">#                    if convergence:</span>
    <span class="c1">#                        break</span>
    <span class="c1">#                    else:</span>
    <span class="c1">#                        itbefore=itafter</span>
<span class="c1">#                self.epistack2d(values, values, row ,  alfa )</span>
    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">convergence</span> <span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
           
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="s1">&#39;per&#39;</span><span class="p">,</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="k">if</span> <span class="n">fairantal</span><span class="o">&lt;=</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="n">outdf</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total model evaluations              :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of solver update              :</span><span class="si">{</span><span class="n">diffcount</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Floating point operations per second : </span><span class="si">{</span><span class="n">numberfloats</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span> </div>

<div class="viewcode-block" id="Newmodel_Mixin.newton1per_un_normalized"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.newton1per_un_normalized">[docs]</a>    <span class="k">def</span> <span class="nf">newton1per_un_normalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">slut</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">antal</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">conv</span><span class="o">=</span><span class="p">[],</span><span class="n">absconv</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">relconv</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">nonlin</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span><span class="n">timeit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">reset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">dumpvar</span><span class="o">=</span><span class="p">[],</span><span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
              <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fairantal&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span>
              <span class="n">newtonalfa</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="n">newtonnodamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to slut (means end in Danish). </span>
<span class="sd">        </span>
<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>
<span class="sd">        </span>
<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="c1">#    print(&#39;new nwwton&#39;)</span>
        <span class="n">starttimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fairantal</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fairantal&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">slut</span><span class="p">,</span><span class="n">databank</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***** Warning: You are solving the model before all lags are avaiable&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maxlag:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">,</span><span class="s1">&#39;First solveperiod:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;First dataframe index&#39;</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>     
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Will start calculating: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="c1">#        if not samedata or not hasattr(self,&#39;new2d&#39;) :</span>
<span class="c1">#           if (not hasattr(self,&#39;solvenew2d&#39;)) or (not self.eqcolumns(self.genrcolumns,databank.columns)):</span>
<span class="c1">#                databank=insertModelVar(databank,self)   # fill all Missing value with 0.0 </span>
<span class="c1">#                for i in [j for j in self.allvar.keys() if self.allvar[j][&#39;matrix&#39;]]:</span>
<span class="c1">#                    databank.loc[:,i]=databank.loc[:,i].astype(&#39;O&#39;)   #  Make sure columns with matrixes are of this type </span>
<span class="c1">#    </span>
<span class="c1">#                self.make_new_text2d =  self.outsolve2dcunk(databank,chunk=chunk,</span>
<span class="c1">#                      ljit=ljit, debug=kwargs.get(&#39;debug&#39;,1),type=&#39;res&#39;)</span>
<span class="c1">#                exec(self.make_new_text2d,globals())  # creates the los function</span>
<span class="c1">#                self.pronew2d,self.solvenew2d,self.epinew2d  = make_los(self.funks,self.errfunk)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">databank</span><span class="o">=</span><span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>   <span class="c1"># fill all Missing value with 0.0 </span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;matrix&#39;</span><span class="p">]]:</span>
                <span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span>   <span class="c1">#  Make sure columns with matrixes are of this type </span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">True</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;pronew2d_jit&#39;</span><span class="p">):</span>  
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create compiled solving function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_jit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_jit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_jit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_jit</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;pronew2d_nojit&#39;</span><span class="p">):</span>  
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create solving function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_nojit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_nojit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_nojit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_nojit</span>

                
        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="c1"># </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;newton_diff&#39;</span><span class="p">):</span>
            <span class="n">endovar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_preorder</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">forcenum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span>
                                           <span class="n">endovar</span> <span class="o">=</span> <span class="n">endovar</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span><span class="n">nchunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">onlyendocur</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;solver&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">reset</span><span class="p">:</span>
            <span class="c1"># breakpoint()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span><span class="o">.</span><span class="n">get_solve1per</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">newton_col</span>      <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span><span class="o">.</span><span class="n">endovar</span><span class="p">]</span>
        <span class="n">newton_col_endo</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span>   <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
       
        <span class="n">convvar</span> <span class="o">=</span> <span class="p">[</span><span class="n">conv</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conv</span><span class="p">]</span> <span class="k">if</span> <span class="n">conv</span> <span class="o">!=</span> <span class="p">[]</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>  
        <span class="n">convplace</span><span class="o">=</span><span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span> <span class="c1"># this is how convergence is measured  </span>
        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>
     
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">convvar</span> <span class="k">if</span> <span class="n">dumpvar</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">dumpvar</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">]</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>
        
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
        <span class="n">starttime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fairiteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fairantal</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fairantal</span> <span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fair-Taylor iteration: </span><span class="si">{</span><span class="n">fairiteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">:</span>
                <span class="n">row</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">p</span><span class="p">]</span> 
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
    
                <span class="n">itbefore</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convplace</span><span class="p">]</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>  <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">antal</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sim per:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> it:</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">xxtt</span><span class="p">:</span>
                        <span class="n">before</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">newton_col_endo</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                        <span class="n">now</span>   <span class="o">=</span> <span class="n">outvalues</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">newton_col</span><span class="p">]</span>
                        <span class="n">distance</span> <span class="o">=</span> <span class="n">now</span><span class="o">-</span><span class="mf">0.0</span>
                        <span class="n">newton_conv</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">newton_conv</span> <span class="o">&lt;=</span> <span class="mf">0.000000001</span> <span class="p">:</span>
        <span class="c1">#                    print(f&#39;Iteration {iteration} sum of distances {newton_conv}&#39;)</span>
                            <span class="k">break</span> 
                        <span class="k">if</span> <span class="n">iteration</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nonlin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">%</span> <span class="n">nonlin</span><span class="p">):</span>
                            <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Updating solver&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t3</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updating solver, iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">df_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span><span class="o">.</span><span class="n">get_solve1per</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_now</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">]</span>
                        <span class="c1">#breakpoint()    </span>
                        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Update solution&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                <span class="c1">#            update = self.solveinv(distance)</span>
                            <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
                            <span class="c1"># breakpoint()</span>
                        
                        <span class="n">damp</span> <span class="o">=</span> <span class="n">newtonalfa</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">newtonnodamp</span> <span class="k">else</span> <span class="mf">1.0</span> 
                        <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">newton_col_endo</span><span class="p">]</span> <span class="o">=</span> <span class="n">before</span> <span class="o">-</span> <span class="n">damp</span><span class="o">*</span><span class="n">update</span>
    
                    <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">p</span><span class="p">]</span>
                              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
    <span class="c1">#                if iteration &gt; first_test: </span>
    <span class="c1">#                    itafter=[values[row,c] for c in convplace] </span>
    <span class="c1">#                    convergence = True</span>
    <span class="c1">#                    for after,before in zip(itafter,itbefore):</span>
    <span class="c1">##                        print(before,after)</span>
    <span class="c1">#                        if before &gt; absconv and abs(after-before)/abs(before)  &gt; relconv:</span>
    <span class="c1">#                            convergence = False</span>
    <span class="c1">#                            break </span>
    <span class="c1">#                    if convergence:</span>
    <span class="c1">#                        break</span>
    <span class="c1">#                    else:</span>
    <span class="c1">#                        itbefore=itafter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
    
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">convergence</span> <span class="p">:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
           
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="s1">&#39;per&#39;</span><span class="p">,</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="k">if</span> <span class="n">fairantal</span><span class="o">&lt;=</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="n">outdf</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Foating point operations             :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total iterations                     :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total floating point operations      :</span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Floating point operations per second : </span><span class="si">{</span><span class="n">numberfloats</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span> </div>

<div class="viewcode-block" id="Newmodel_Mixin.newtonstack_un_normalized"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.newtonstack_un_normalized">[docs]</a>    <span class="k">def</span> <span class="nf">newtonstack_un_normalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">slut</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">antal</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">conv</span><span class="o">=</span><span class="p">[],</span><span class="n">absconv</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">relconv</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span>
              <span class="n">dumpvar</span><span class="o">=</span><span class="p">[],</span><span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nchunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nljit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
              <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fairantal&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">timeit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nonlin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">newtonalfa</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="n">newtonnodamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">forcenum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">reset</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to slut (means end in Danish). </span>
<span class="sd">        </span>
<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>
<span class="sd">        </span>
<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="c1">#    print(&#39;new nwwton&#39;)</span>
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">diffcount</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">starttimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fairantal</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fairantal&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">slut</span><span class="p">,</span><span class="n">databank</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***** Warning: You are solving the model before all lags are avaiable&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maxlag:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">,</span><span class="s1">&#39;First solveperiod:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;First dataframe index&#39;</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>     
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Will start calculating: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="c1">#        if not samedata or not hasattr(self,&#39;solve2d&#39;) :</span>
<span class="c1">#           if (not hasattr(self,&#39;solvestack2d&#39;)) or (not self.eqcolumns(self.genrcolumns,databank.columns)):</span>
<span class="c1">#                databank=insertModelVar(databank,self)   # fill all Missing value with 0.0 </span>
<span class="c1">#                for i in [j for j in self.allvar.keys() if self.allvar[j][&#39;matrix&#39;]]:</span>
<span class="c1">#                    databank.loc[:,i]=databank.loc[:,i].astype(&#39;O&#39;)   #  Make sure columns with matrixes are of this type </span>
<span class="c1">#    </span>
<span class="c1">#                self.make_losstack_text2d =  self.outsolve2dcunk(databank,chunk=chunk,</span>
<span class="c1">#                      ljit=ljit, debug=debug,type=&#39;res&#39;)</span>
<span class="c1">#                exec(self.make_losstack_text2d,globals())  # creates the los function</span>
<span class="c1">#                self.prostack2d,self.solvestack2d,self.epistack2d  = make_los(self.funks,self.errfunk)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">databank</span><span class="o">=</span><span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>   <span class="c1"># fill all Missing value with 0.0 </span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;matrix&#39;</span><span class="p">]]:</span>
                <span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span>   <span class="c1">#  Make sure columns with matrixes are of this type </span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">True</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;pronew2d_jit&#39;</span><span class="p">):</span>  
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create compiled solving function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_jit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_jit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_jit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_jit</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;pronew2d_nojit&#39;</span><span class="p">):</span>  
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create solving function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_nojit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_newlos_text2d_nojit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_nojit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epinew2d_nojit</span>


                
        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="c1"># </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;newton_diff_stack&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">forcenum</span><span class="o">=</span><span class="n">forcenum</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">nljit</span><span class="p">,</span><span class="n">nchunk</span><span class="o">=</span><span class="n">nchunk</span><span class="p">,</span><span class="n">timeit</span><span class="o">=</span><span class="n">timeit</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;stacksolver&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calculating new derivatives and create new stacked Newton solver&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">get_solvestacked</span>
            <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span> <span class="o">=</span> <span class="n">sol_periode</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">reset</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="n">sol_periode</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="p">:</span>   
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating new stacked Newton solver&#39;</span><span class="p">)</span>
            <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span> <span class="o">=</span> <span class="n">sol_periode</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">newton_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">endovar</span><span class="p">]</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">newton_col_endo</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">timeit</span> <span class="o">=</span> <span class="n">timeit</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span>   <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
       
        <span class="n">convvar</span> <span class="o">=</span> <span class="p">[</span><span class="n">conv</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conv</span><span class="p">]</span> <span class="k">if</span> <span class="n">conv</span> <span class="o">!=</span> <span class="p">[]</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>  
        <span class="n">convplace</span><span class="o">=</span><span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span> <span class="c1"># this is how convergence is measured  </span>
        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">False</span>
     
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">convvar</span> <span class="k">if</span> <span class="n">dumpvar</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">dumpvar</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">]</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>
        
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
        <span class="n">starttime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="o">=</span><span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">r</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">newton_col</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">newton_col</span>      <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex_endo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">newton_col_endo</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        
<span class="c1">#                if ldumpvar:</span>
<span class="c1">#                    self.dumplist.append([fairiteration,self.periode,int(0)]+[values[row,p] </span>
<span class="c1">#                        for p in dumpplac])</span>

<span class="c1">#        itbefore = values[self.stackrows,convplace] </span>
<span class="c1">#        self.pro2d(values, values,  row ,  alfa )</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">antal</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Newton it:</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">xxtt</span><span class="p">:</span>
                <span class="n">before</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex_endo</span><span class="p">]</span>
                <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;calculate new solution&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t2</span><span class="p">:</span>                
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                        <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;extract new solution&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t2</span><span class="p">:</span>                
                    <span class="n">now</span>   <span class="o">=</span> <span class="n">outvalues</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span><span class="p">]</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">now</span><span class="o">-</span><span class="mf">0.0</span>
                <span class="n">newton_conv</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
               <span class="c1"># breakpoint()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Iteration  </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> Sum of distances </span><span class="si">{</span><span class="n">newton_conv</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="mi">25</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="mi">12</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newton_conv</span> <span class="o">&lt;=</span> <span class="mf">0.001</span> <span class="p">:</span>
                    <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span> 
                    <span class="k">break</span> 
                <span class="k">if</span> <span class="n">iteration</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nonlin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">%</span> <span class="n">nonlin</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Updating solver&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t3</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updating solver, iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">df_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_now</span><span class="p">)</span>
                        <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>
                        
                    
                <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Update solution&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">):</span>
        <span class="c1">#            update = self.solveinv(distance)</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
                    <span class="n">damp</span> <span class="o">=</span> <span class="n">newtonalfa</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">newtonnodamp</span> <span class="k">else</span> <span class="mf">1.0</span> 
                <span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex_endo</span><span class="p">]</span> <span class="o">=</span> <span class="n">before</span> <span class="o">-</span> <span class="n">damp</span> <span class="o">*</span> <span class="n">update</span>

                    
                <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">p</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
    <span class="c1">#                if iteration &gt; first_test: </span>
    <span class="c1">#                    itafter=[values[row,c] for c in convplace] </span>
    <span class="c1">#                    convergence = True</span>
    <span class="c1">#                    for after,before in zip(itafter,itbefore):</span>
    <span class="c1">##                        print(before,after)</span>
    <span class="c1">#                        if before &gt; absconv and abs(after-before)/abs(before)  &gt; relconv:</span>
    <span class="c1">#                            convergence = False</span>
    <span class="c1">#                            break </span>
    <span class="c1">#                    if convergence:</span>
    <span class="c1">#                        break</span>
    <span class="c1">#                    else:</span>
    <span class="c1">#                        itbefore=itafter</span>
<span class="c1">#                self.epistack2d(values, values, row ,  alfa )</span>
    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">convergence</span> <span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
           
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="s1">&#39;per&#39;</span><span class="p">,</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="k">if</span> <span class="n">fairantal</span><span class="o">&lt;=</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="n">outdf</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">diff_numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">diff_model</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">)</span><span class="o">*</span><span class="n">diffcount</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                       :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total model evaluations                    :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of solver update                    :</span><span class="si">{</span><span class="n">diffcount</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)                  :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Floating point operations in model         : </span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Floating point operations in jacobi model  : </span><span class="si">{</span><span class="n">diff_numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span> </div>

<div class="viewcode-block" id="Newmodel_Mixin.res2d"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.res2d">[docs]</a>    <span class="k">def</span> <span class="nf">res2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">slut</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">timeit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">alfa</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">stats</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">samedata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;calculates the result of a model, no iteration or interaction </span>
<span class="sd">        The text for the evaluater function is placed in the model property **make_res_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="c1">#    print(&#39;new nwwton&#39;)</span>
        <span class="n">starttimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">slut</span><span class="p">,</span><span class="n">databank</span><span class="p">)</span>
        <span class="c1"># breakpoint()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***** Warning: You are solving the model before all lags are avaiable&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maxlag:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">,</span><span class="s1">&#39;First solveperiod:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;First dataframe index&#39;</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>     
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlead</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlead</span><span class="p">)</span> <span class="ow">in</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***** Warning: You are solving the model before all leads are avaiable&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maxlag:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlead</span><span class="p">,</span><span class="s1">&#39;Last solveperiod:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;Last dataframe index&#39;</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>     
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Will start calculating: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">databank</span><span class="o">=</span><span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>   <span class="c1"># fill all Missing value with 0.0 </span>
<span class="c1">#        if not samedata or not hasattr(self,&#39;solve2d&#39;) :</span>
<span class="c1">#           if (not hasattr(self,&#39;solve2d&#39;)) or (not self.eqcolumns(self.genrcolumns,databank.columns)):</span>
<span class="c1">#                for i in [j for j in self.allvar.keys() if self.allvar[j][&#39;matrix&#39;]]:</span>
<span class="c1">#                    databank.loc[:,i]=databank.loc[:,i].astype(&#39;O&#39;)   #  Make sure columns with matrixes are of this type </span>
<span class="c1">#                with ttimer(&#39;make model:&#39;):</span>
<span class="c1">#                    self.make_res_text2d =  self.outsolve2dcunk(databank,chunk=chunk,</span>
<span class="c1">#                      ljit=ljit, debug=debug,type=&#39;res&#39;)</span>
<span class="c1">#                exec(self.make_res_text2d,globals())  # creates the los function</span>
<span class="c1">#                self.pro2d,self.solve2d,self.epi2d  = make_los(self.funks,self.errfunk)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span><span class="p">,</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">databank</span><span class="o">=</span><span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>   <span class="c1"># fill all Missing value with 0.0 </span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;matrix&#39;</span><span class="p">]]:</span>
                <span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span>   <span class="c1">#  Make sure columns with matrixes are of this type </span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">True</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;prores2d_jit&#39;</span><span class="p">):</span>  
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create compiled res function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_reslos_text2d_jit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_reslos_text2d_jit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prores2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solveres2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epires2d_jit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prores2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solveres2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epires2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prores2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solveres2d_jit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epires2d_jit</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;prores2d_nojit&#39;</span><span class="p">):</span>  
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create res function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                                 
                <span class="bp">self</span><span class="o">.</span><span class="n">make_res_text2d_nojit</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_res_text2d_nojit</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prores2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solveres2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epires2d_nojit</span>  <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prores2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solveres2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epires2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prores2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solveres2d_nojit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epires2d_nojit</span>

                
        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outvalues</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 

        <span class="n">res_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">]</span>
        
       
        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span>   <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
        <span class="n">endtimesetup</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
        <span class="n">starttime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="o">=</span><span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">res calculation&#39;</span><span class="p">,</span><span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">xxtt</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">periode</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prores2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">solveres2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epires2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span> <span class="p">,</span>  <span class="n">alfa</span> <span class="p">)</span>
            
        <span class="n">outdf</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">outvalues</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">)</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Foating point operations             :</span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span> </div>

<div class="viewcode-block" id="Newmodel_Mixin.control"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.control">[docs]</a>    <span class="k">def</span> <span class="nf">control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">databank</span><span class="p">,</span><span class="n">targets</span><span class="p">,</span><span class="n">instruments</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                <span class="n">maxiter</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_i</span> <span class="o">=</span> <span class="n">targets_instruments</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span><span class="n">targets</span><span class="p">,</span><span class="n">instruments</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span>
                 <span class="n">DefaultImpuls</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">defaultconv</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">nonlin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxiter</span> <span class="o">=</span> <span class="n">maxiter</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_i</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>

       
<div class="viewcode-block" id="Newmodel_Mixin.totexplain"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.totexplain">[docs]</a>    <span class="k">def</span> <span class="nf">totexplain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">vtype</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="n">per</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                   <span class="p">,</span><span class="n">use</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;totdekomp&#39;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">modeldekom</span> <span class="kn">import</span> <span class="n">totdif</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span> <span class="o">=</span> <span class="n">totdif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">summaryvar</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">desdic</span><span class="o">=</span><span class="p">{})</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span><span class="o">.</span><span class="n">totexplain</span><span class="p">(</span><span class="n">pat</span><span class="o">=</span><span class="n">pat</span><span class="p">,</span><span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span><span class="n">stacked</span><span class="o">=</span><span class="n">stacked</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                                        <span class="n">per</span> <span class="o">=</span> <span class="n">per</span> <span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="n">top</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>
        
    
<div class="viewcode-block" id="Newmodel_Mixin.get_att_gui"><a class="viewcode-back" href="../unsorted/modelsandbox_Mixin.html#modelsandbox_Mixin.Newmodel_Mixin.get_att_gui">[docs]</a>    <span class="k">def</span> <span class="nf">get_att_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="s1">&#39;FY&#39;</span><span class="p">,</span><span class="n">spat</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">desdic</span><span class="o">=</span><span class="p">{},</span><span class="n">use</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Creates a jupyter ipywidget to display model level </span>
<span class="sd">        attributions &#39;&#39;&#39;</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;totdekomp&#39;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">modeldekom</span> <span class="kn">import</span> <span class="n">totdif</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span> <span class="o">=</span> <span class="n">totdif</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">summaryvar</span><span class="o">=</span><span class="n">spat</span><span class="p">,</span><span class="n">desdic</span><span class="o">=</span><span class="n">desdic</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TOTDEKOMP made&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span><span class="o">.</span><span class="n">go</span><span class="p">:</span>
            <span class="n">xvar</span> <span class="o">=</span> <span class="n">var</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">else</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xx</span> <span class="o">=</span><span class="n">mj</span><span class="o">.</span><span class="n">get_att_gui</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="n">xvar</span><span class="p">,</span><span class="n">spat</span> <span class="o">=</span> <span class="n">spat</span><span class="p">,</span><span class="n">desdic</span><span class="o">=</span><span class="n">desdic</span><span class="p">,</span><span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span> 
            <span class="k">return</span> <span class="s1">&#39;Nothing to attribute&#39;</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Ib Hansen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>