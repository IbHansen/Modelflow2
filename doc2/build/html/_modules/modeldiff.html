<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>modeldiff &mdash; ModelFlow  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="../index.html" class="icon icon-home"> ModelFlow
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">content:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core/Core.html">Core Modules, creates and solves model instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onboard/onboard.html">Processing model specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../attribution/Attribution.html">Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vis/modelvis.html">Quick result visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotly/modeldashsidebar.html">Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jupyter/jupyter.html">Jupyter Stuff</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelinvert.html">Targets and instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelmf.html">Enrich dataframes with modelflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/model_cvx.html">Convex optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelsandbox.html">Template for a user defined  model class based on the model class</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unsorted:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/model_financial_stability.html">model_financial_stability module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/model_ifrs9.html">model_ifrs9 module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/model_run_numba.html">model_run_numba module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modelclass2.html">modelclass2 module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modeldash.html">modeldash module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modeldashboot.html">modeldashboot module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modeldiff.html">modeldiff module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modelhelp.html">modelhelp module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modelnet.html">modelnet module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modelsandbox_Mixin.html">modelsandbox_Mixin module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/modeltodo.html">modeltodo module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ModelFlow</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>modeldiff</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for modeldiff</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue Oct 22 22:47:37 2013</span>


<span class="sd">Developement Module - only for the adventeous </span>

<span class="sd"> </span>
<span class="sd">This module handels symbolic differentiation of models \n</span>
<span class="sd">calculates the values of all the partial differentialkoifficients </span>
<span class="sd">and creates matrices for each lag </span>

<span class="sd">@author: Ib Hansen</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#from makrostart import smecstart,adamstart,monastart</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span>  <span class="k">as</span> <span class="nn">plt</span> 
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span><span class="p">,</span><span class="n">patches</span>
<span class="kn">import</span> <span class="nn">itertools</span>


<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">exp</span><span class="p">,</span> <span class="n">log</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">sympify</span><span class="p">,</span><span class="n">Symbol</span>
<span class="kn">from</span> <span class="nn">sympy.abc</span> <span class="kn">import</span> <span class="n">_clash1</span><span class="p">,</span><span class="n">_clash</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Math</span> <span class="p">,</span><span class="n">Latex</span> 
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">latex</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">linalg</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">modelmanipulation</span> <span class="kn">import</span> <span class="n">split_frml</span><span class="p">,</span><span class="n">udtryk_parse</span><span class="p">,</span><span class="n">find_arg</span><span class="p">,</span><span class="n">stripstring</span><span class="p">,</span><span class="n">pastestring</span> 
<span class="kn">from</span> <span class="nn">modelclass</span> <span class="kn">import</span> <span class="n">model</span> 
<span class="kn">from</span> <span class="nn">modelmanipulation</span> <span class="kn">import</span> <span class="n">normalize</span>
<span class="kn">import</span> <span class="nn">modelclass</span> <span class="k">as</span> <span class="nn">mc</span>
<span class="kn">from</span> <span class="nn">modelpattern</span> <span class="kn">import</span> <span class="n">nterm</span><span class="p">,</span><span class="n">udtrykre</span>


<span class="c1"># in order to use theese reserved words from sympy as variables </span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;im&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;im&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;li&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;if&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;if&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;IF&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;IF&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;pi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;pi&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;PI&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;PI&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;PCT&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;PCT&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;pct&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;pct&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;QP&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;QP&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;qp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;qp&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;QQ&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;QQ&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;qq&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;qq&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;lt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;lt&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;LT&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;LT&#39;</span><span class="p">)</span>
<span class="n">_clash</span><span class="p">[</span><span class="s1">&#39;EX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;EX&#39;</span><span class="p">)</span>


<span class="c1">#print(_clash)</span>

<div class="viewcode-block" id="findallvar"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.findallvar">[docs]</a><span class="k">def</span> <span class="nf">findallvar</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Finds all endogenous variables which is on the right side of = in the expresion for variable v</span>
<span class="sd">    lagged variables are included &#39;&#39;&#39;</span>
    <span class="n">terms</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">][</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rhsvar</span><span class="o">=</span><span class="p">{(</span><span class="n">nt</span><span class="o">.</span><span class="n">var</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="n">nt</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="k">if</span> <span class="n">nt</span><span class="o">.</span><span class="n">lag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">terms</span> <span class="k">if</span> <span class="n">nt</span><span class="o">.</span><span class="n">var</span> <span class="ow">and</span> <span class="n">nt</span><span class="o">.</span><span class="n">var</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">endogene</span><span class="p">}</span>
    <span class="n">var2</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rhsvar</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">var2</span></div>

<div class="viewcode-block" id="findendocur"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.findendocur">[docs]</a><span class="k">def</span> <span class="nf">findendocur</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Finds all endegenoujs variables which is on the right side of = in the expresion for variable v</span>
<span class="sd">    lagged variables are **not** included &#39;&#39;&#39;</span>
    <span class="n">terms</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">][</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rhsvar</span><span class="o">=</span><span class="p">{</span><span class="n">nt</span><span class="o">.</span><span class="n">var</span> <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">terms</span> <span class="k">if</span> <span class="n">nt</span><span class="o">.</span><span class="n">var</span> <span class="ow">and</span> <span class="n">nt</span><span class="o">.</span><span class="n">var</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">endogene</span> <span class="ow">and</span> <span class="n">nt</span><span class="o">.</span><span class="n">lag</span> <span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">nt</span><span class="o">.</span><span class="n">var</span> <span class="o">!=</span> <span class="n">v</span><span class="p">}</span>
    <span class="n">var2</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rhsvar</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">var2</span></div>
        
<div class="viewcode-block" id="modeldiff"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.modeldiff">[docs]</a><span class="k">def</span> <span class="nf">modeldiff</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">onlyendocur</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">endovar</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">maxdif</span><span class="o">=</span><span class="mi">9999999999999999</span><span class="p">,</span><span class="n">forcenum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Differentiate all relations with respect to all variable </span>
<span class="sd">    The result is placed in a dictory in the model instanse: model.diffendocur</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Find espressions for partial derivatives&#39;</span><span class="p">,</span><span class="ow">not</span> <span class="n">silent</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="o">=</span><span class="p">{}</span> <span class="c1">#defaultdict(defaultdict) #here we wanmt to store the derivativs</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">nvar</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">endogene</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nvar</span> <span class="o">&gt;=</span> <span class="n">maxdif</span><span class="p">:</span>
                <span class="k">break</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now differentiating </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">nvar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">onlyendocur</span><span class="p">:</span>
                <span class="n">endocur</span><span class="o">=</span><span class="n">findendocur</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">endocur</span><span class="o">=</span><span class="n">findallvar</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">t</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">a</span><span class="p">,</span><span class="n">fr</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">udtryk</span><span class="o">=</span><span class="n">split_frml</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">udtryk</span><span class="o">=</span><span class="n">udtryk</span>
            <span class="n">udtryk</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;LOG\(&#39;</span><span class="p">,</span><span class="s1">&#39;log(&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span> <span class="c1"># sympy uses lover case for log and exp </span>
            <span class="n">udtryk</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;EXP\(&#39;</span><span class="p">,</span><span class="s1">&#39;exp(&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span>
            <span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span><span class="o">=</span><span class="n">udtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kat</span><span class="o">=</span><span class="n">sympify</span><span class="p">(</span><span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">_clash</span><span class="p">)</span> <span class="c1"># we take the the $ out _clash1 makes I is not taken as imiganary </span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* Problem sympify &#39;</span><span class="p">,</span><span class="n">lhs</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">rhv</span> <span class="ow">in</span> <span class="n">endocur</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">forcenum</span><span class="p">:</span>
                        <span class="n">ud</span><span class="o">=</span><span class="n">kat</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sympify</span><span class="p">(</span><span class="n">rhv</span><span class="p">,</span><span class="n">_clash</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">forcenum</span> <span class="ow">or</span> <span class="s1">&#39;Derivative(&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ud</span><span class="p">)</span> <span class="p">:</span>
                        <span class="n">ud</span> <span class="o">=</span> <span class="n">numdif</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">rhv</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;numdif of </span><span class="si">{rhv}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">rhv</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ud</span><span class="p">)</span>
    
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;we have a serous problem deriving:&#39;</span><span class="p">,</span><span class="n">lhs</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">,</span><span class="n">rhv</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">lhs</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="n">rhs</span><span class="p">)</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model                           :&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of variables             :&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of endogeneus variables  :&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of derivatives           :&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> </div>
        
<div class="viewcode-block" id="diffout"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.diffout">[docs]</a><span class="k">def</span> <span class="nf">diffout</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">l</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">maxnavlen</span>
    <span class="n">llhs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">lhsvar</span><span class="p">)</span> <span class="k">for</span> <span class="n">lhsvar</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">)</span>
    <span class="n">lrhs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhsvar</span><span class="p">)</span> <span class="k">for</span> <span class="n">lhsvar</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span> 
               <span class="k">for</span> <span class="n">rhsvar</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">lhsvar</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lhsvar</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">llhs</span><span class="si">}}</span><span class="s1"> </span><span class="si">{</span><span class="n">rhsvar</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">lrhs</span><span class="si">}}</span><span class="s1"> </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">lhsvar</span><span class="p">][</span><span class="n">rhsvar</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
            <span class="k">for</span> <span class="n">lhsvar</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">rhsvar</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">lhsvar</span><span class="p">])</span>
            <span class="p">]</span> 
    <span class="k">return</span> <span class="n">out</span> </div>
 
       
<div class="viewcode-block" id="diffprint"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.diffprint">[docs]</a><span class="k">def</span> <span class="nf">diffprint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">udfil</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">f</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">if</span> <span class="n">udfil</span><span class="p">:</span><span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">udfil</span><span class="p">,</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">l</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">maxnavlen</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">e</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">],</span><span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of variables             :&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">),</span><span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of endogeneus variables  :&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">),</span><span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of derivatives           :&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span> </div>
<div class="viewcode-block" id="vardiff"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.vardiff">[docs]</a><span class="k">def</span> <span class="nf">vardiff</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Displays espressions for differential koifficients for a variable</span>
<span class="sd">    if var ends with * all matchning variables are displayes&#39;&#39;&#39;</span>
    <span class="n">l</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">maxnavlen</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">var</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">]):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">e</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">var</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">])</span>                
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">]):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">e</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">])</span></div>
<div class="viewcode-block" id="invdiff"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.invdiff">[docs]</a><span class="k">def</span> <span class="nf">invdiff</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">var</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Displays espressions for differential koifficients for a variable</span>
<span class="sd">    if var ends with * all matchning variables are displayes&#39;&#39;&#39;</span>
    <span class="n">l</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">maxnavlen</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">):</span>       
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="n">var</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">e</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">])</span></div>
<div class="viewcode-block" id="rettet"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.rettet">[docs]</a><span class="k">def</span> <span class="nf">rettet</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="fouteval"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.fouteval">[docs]</a><span class="k">def</span> <span class="nf">fouteval</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">databank</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; takes a dict of derivatives for a model and makes a function which returns a function which evaluates the </span>
<span class="sd">    derivatives in a period.</span>
<span class="sd">    The derivatives is both returned from the function and places in \n</span>
<span class="sd">    :model.difvalue&#39;&#39;&#39;</span>
    <span class="n">columnsnr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">get_columnsnr</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;def make_diffcalculate():</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  def diffcalculate(model,databank,periode):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="s1">&#39;from math import exp, log </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="s1">&#39;import sys</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="s1">&#39;row=databank.index.get_loc(periode)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="s1">&#39;values=databank.values</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="s1">&#39;diffvalue=</span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>   
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="s1">&#39;try :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">)):</span>
<span class="c1">#        print(v)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span> <span class="mi">20000000</span><span class="p">:</span> <span class="c1"># to make small tests calculations </span>
            <span class="k">break</span>
        <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;        &#39;</span><span class="o">+</span><span class="s1">&#39;diffvalue[&quot;&#39;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39;&quot;]=</span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>        
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">]):</span>
<span class="c1">#            print(&#39;   &#39;,e)</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="o">+</span><span class="n">v</span> <span class="ow">or</span> <span class="n">e</span> <span class="o">==</span> <span class="s1">&#39;Z&#39;</span><span class="o">+</span><span class="n">v</span> <span class="p">:</span><span class="k">continue</span>                
            <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;_D&#39;</span> <span class="p">:</span><span class="k">continue</span>     <span class="c1"># dont want dummyes </span>
<span class="c1">#            print(v.ljust(l),e.ljust(l),model.diffendocur[v][e],file=f)</span>
            <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;        &#39;</span><span class="o">+</span><span class="s1">&#39;diffvalue[&quot;&#39;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39;&quot;][&quot;&#39;</span><span class="o">+</span><span class="n">e</span><span class="o">+</span><span class="s1">&#39;&quot;]=&#39;</span><span class="p">)</span>
            <span class="n">terms</span><span class="o">=</span><span class="n">udtryk_parse</span><span class="p">(</span><span class="n">settozero</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">])))</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>       
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
                    <span class="n">ud</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                    <span class="n">ud</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">number</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">ud</span><span class="o">=</span> <span class="s1">&#39;values[row,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
                    <span class="k">else</span> <span class="p">:</span>  
                        <span class="n">ud</span><span class="o">=</span> <span class="s1">&#39;values[row&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span> 
                <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ud</span><span class="p">)</span>
            <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="s1">&#39;except :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="s1">&#39;   &#39;</span><span class="o">+</span><span class="s1">&#39;print(&quot;Error in&quot;,sys.exc_info())</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="s1">&#39;   &#39;</span><span class="o">+</span><span class="s1">&#39;raise</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="s1">&#39;model.diffvalue=diffvalue</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="s1">&#39;return diffvalue</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  return diffcalculate</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#    print(&#39;Function to evaluate derivatives of&#39;,model.name,&#39;created&#39;)</span>
<span class="c1">#        print (fib)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fib</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="calculate_diffvalue"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.calculate_diffvalue">[docs]</a><span class="k">def</span> <span class="nf">calculate_diffvalue</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">bank</span><span class="p">,</span><span class="n">per</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; calculates the numeric value of derivatives. </span>
<span class="sd">    the values are returnes and also places in model.diffvalue&#39;&#39;&#39;</span>
    <span class="n">funk</span><span class="o">=</span><span class="n">fouteval</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">bank</span><span class="p">)</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">funk</span><span class="p">,</span><span class="nb">globals</span><span class="p">())</span>
    <span class="n">xx</span><span class="o">=</span><span class="n">make_diffcalculate</span><span class="p">()</span>
    <span class="n">res</span><span class="o">=</span><span class="n">xx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">bank</span><span class="p">,</span><span class="n">per</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>
<div class="viewcode-block" id="calculate_delta"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.calculate_delta">[docs]</a><span class="k">def</span> <span class="nf">calculate_delta</span><span class="p">(</span><span class="n">databank</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; calculates the standard deviation of the change in all variable in a databank</span>
<span class="sd">    returns a panda series&#39;&#39;&#39;</span>
    <span class="n">delta</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;2000&#39;</span><span class="p">:</span><span class="s1">&#39;2013&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">delta</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>     </div>
<div class="viewcode-block" id="calculate_impact"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.calculate_impact">[docs]</a><span class="k">def</span> <span class="nf">calculate_impact</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">bank</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculate the impact of every variable in equation on the result based on </span>
<span class="sd">    the standard deviation and differential coefficient&#39;&#39;&#39;</span>
    <span class="n">impact</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">temp</span><span class="o">=</span><span class="n">calculate_delta</span><span class="p">(</span><span class="n">bank</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffvalue</span><span class="p">):</span>
        <span class="n">impact</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffvalue</span><span class="p">[</span><span class="n">v</span><span class="p">]):</span>
            <span class="n">evar</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># evar= variable name without lag - to find the standard error </span>
            <span class="n">impact</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">]</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffvalue</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">]</span><span class="o">*</span><span class="n">temp</span><span class="p">[</span><span class="n">evar</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">impact</span><span class="o">=</span><span class="n">impact</span></div>
<div class="viewcode-block" id="calculate_diffvalue_d3d"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.calculate_diffvalue_d3d">[docs]</a><span class="k">def</span> <span class="nf">calculate_diffvalue_d3d</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; creates a 3D dictonary derivatives for each lag&quot;&quot;&quot;</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="c1"># crates a nested dict </span>
    <span class="n">res</span><span class="o">=</span><span class="n">tree</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">diffvalue</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">diffvalue</span><span class="p">[</span><span class="n">v</span><span class="p">]:</span>
            <span class="n">ee</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
            <span class="n">evar</span><span class="o">=</span><span class="n">ee</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># evar= variable name without lag - to find the standard error </span>
            <span class="n">lag</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="mi">1</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">ee</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># extract the lag </span>
            <span class="n">d</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">diffvalue</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Differentialkoifficienten mellen&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="s1">&#39;og&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="s1">&#39;kan ikke beregnes&#39;</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="n">lag</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="n">evar</span><span class="p">]</span><span class="o">=</span><span class="n">d</span>
    <span class="n">model</span><span class="o">.</span><span class="n">diffvalue_d3d</span><span class="o">=</span><span class="n">res</span>
    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="calculate_mat"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.calculate_mat">[docs]</a><span class="k">def</span> <span class="nf">calculate_mat</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">lag</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; calcultae matrix of derivative values.</span>
<span class="sd">    very slow should be reworked </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rowname</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>
    <span class="n">colname</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">exogene</span><span class="p">)</span>
    <span class="n">ud</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">rowname</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">colname</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">pcol</span> <span class="ow">in</span> <span class="n">colname</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">prow</span> <span class="ow">in</span> <span class="n">rowname</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ud</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prow</span><span class="p">,</span><span class="n">pcol</span><span class="p">]</span> <span class="o">=</span>  <span class="n">model</span><span class="o">.</span><span class="n">diffvalue_d3d</span><span class="p">[</span><span class="n">lag</span><span class="p">][</span><span class="n">prow</span><span class="p">][</span><span class="n">pcol</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="n">ud</span></div>

<div class="viewcode-block" id="calculate_endocurmat"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.calculate_endocurmat">[docs]</a><span class="k">def</span> <span class="nf">calculate_endocurmat</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; for Newton solution find jacobi&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Finding derivatives&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span> 
        <span class="n">_</span> <span class="o">=</span> <span class="n">modeldiff</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">onlyendocur</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Calculating derivatives&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span> 
        <span class="n">res</span> <span class="o">=</span> <span class="n">calculate_diffvalue</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">madam</span><span class="o">.</span><span class="n">diffvalue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>
    

<div class="viewcode-block" id="calculate_allmat"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.calculate_allmat">[docs]</a><span class="k">def</span> <span class="nf">calculate_allmat</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Calculate and return a dictionary with a matrix of derivative values for each lag&#39;&#39;&#39;</span> 
    <span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Finding derivatives&#39;</span><span class="p">,</span><span class="n">show</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span> 
        <span class="n">_</span> <span class="o">=</span> <span class="n">modeldiff</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Calculating derivatives&#39;</span><span class="p">,</span><span class="n">show</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span> 
        <span class="n">res</span> <span class="o">=</span> <span class="n">calculate_diffvalue</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;creating dataframe&#39;</span><span class="p">,</span><span class="n">show</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span> 
        <span class="n">res2</span> <span class="o">=</span> <span class="n">calculate_diffvalue_d3d</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span><span class="n">calculate_mat</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">maxlag</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)}</span></div>

<div class="viewcode-block" id="calculate_matold"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.calculate_matold">[docs]</a><span class="k">def</span> <span class="nf">calculate_matold</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">lag</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">endo</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; calcultae matrix of derivative values.</span>
<span class="sd">    endo deteriins if it is with respect to endogeneous og exogeneous variables</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rowname</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>
    <span class="n">colname</span><span class="o">=</span><span class="n">rowname</span> <span class="k">if</span> <span class="n">endo</span> <span class="k">else</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">exogene</span><span class="p">)</span>
    <span class="n">col</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span>
    <span class="n">row</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rowname</span><span class="p">)</span>
    <span class="n">ud</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">))</span>
    <span class="n">placdirrow</span><span class="o">=</span><span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rowname</span><span class="p">)}</span>
    <span class="n">placdircol</span><span class="o">=</span><span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colname</span><span class="p">)}</span>
    <span class="k">for</span> <span class="n">vx</span> <span class="ow">in</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">diffvalue_d3d</span><span class="p">[</span><span class="n">lag</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">colname</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">vy</span> <span class="ow">in</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">diffvalue_d3d</span><span class="p">[</span><span class="n">lag</span><span class="p">][</span><span class="n">vx</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">rowname</span><span class="p">]:</span>
                    <span class="n">ud</span><span class="p">[</span><span class="n">placdirrow</span><span class="p">[</span><span class="n">vx</span><span class="p">],</span><span class="n">placdircol</span><span class="p">[</span><span class="n">vy</span><span class="p">]]</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">diffvalue_d3d</span><span class="p">[</span><span class="n">lag</span><span class="p">][</span><span class="n">vx</span><span class="p">][</span><span class="n">vy</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">rowname</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">colname</span><span class="p">)</span> </div>
<div class="viewcode-block" id="modelnet_dict"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.modelnet_dict">[docs]</a><span class="k">def</span> <span class="nf">modelnet_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">lag</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; creates a network where weight is determined by a 3d dict of impacts</span>
<span class="sd">    d: 3 d dictinorary &#39;&#39;&#39;</span>
    <span class="n">g</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">lag</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">lag</span><span class="p">][</span><span class="n">v</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">endogene</span> <span class="ow">and</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">endogene</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="n">lag</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">g</span></div>
<div class="viewcode-block" id="pagerank"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.pagerank">[docs]</a><span class="k">def</span> <span class="nf">pagerank</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; ranks the equations in a model according to the pagerank algoritme</span>
<span class="sd">    returns order in pagerank&#39;&#39;&#39;</span>
    <span class="n">xx</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">pagerank</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">sorteret</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span><span class="n">xx</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rankorder</span><span class="o">=</span><span class="p">[</span><span class="n">yy</span> <span class="k">for</span> <span class="n">xxx</span><span class="p">,</span><span class="n">yy</span> <span class="ow">in</span> <span class="n">sorteret</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">rankorder</span> </div>
<div class="viewcode-block" id="display_diff"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.display_diff">[docs]</a><span class="k">def</span> <span class="nf">display_diff</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">bank</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">temp</span><span class="o">=</span><span class="n">calculate_delta</span><span class="p">(</span><span class="n">bank</span><span class="p">)</span>
    <span class="n">l</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">maxnavlen</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffvalue</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span><span class="o">==</span><span class="n">var</span><span class="p">:</span><span class="k">continue</span> 
        <span class="n">f</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39; |\n&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">split_frml</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">])[</span><span class="mi">3</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">impact</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">evar</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">diffvalue</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:12.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffvalue</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">])</span>
            <span class="n">delta</span>     <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:12.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">evar</span><span class="p">])</span>
            <span class="n">timpact</span>   <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:12.1f}</span><span class="s1">% &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">impact</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">]</span><span class="o">/</span><span class="n">temp</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">e</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">diffvalue</span><span class="p">,</span><span class="n">delta</span><span class="p">,</span><span class="n">timpact</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">e</span><span class="p">])</span>  </div>
<div class="viewcode-block" id="display_ip_old"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.display_ip_old">[docs]</a><span class="k">def</span> <span class="nf">display_ip_old</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">ivar</span><span class="p">):</span>
    <span class="n">var</span><span class="o">=</span><span class="n">ivar</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">a</span><span class="p">,</span><span class="n">fr</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">udtryk</span><span class="o">=</span> <span class="n">split_frml</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">])</span>
    <span class="n">udtryk2</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;\_&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># get rid of _</span>
    <span class="n">udtryk3</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;var&gt;[a-zA-Z_]\w*)\((?P&lt;lag&gt;-[0-9]+)\)&#39;</span><span class="p">,</span><span class="s1">&#39;\g&lt;var&gt;_{\g&lt;lag&gt;}&#39;</span><span class="p">,</span><span class="n">udtryk2</span><span class="p">)</span> 
    <span class="n">udtryk3</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;delta_&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;\Delta &#39;</span><span class="p">,</span><span class="n">udtryk3</span><span class="p">)</span>
    <span class="n">totud</span><span class="o">=</span><span class="p">[</span><span class="n">udtryk3</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">ud</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\frac{\partial &#39;</span><span class="o">+</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;}{\partial &#39;</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="s1">&#39;}  = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ud</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;delta_&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;\Delta &#39;</span><span class="p">,</span><span class="n">ud</span><span class="p">)</span>

        <span class="n">ud</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;\_&#39;</span><span class="p">,</span><span class="n">ud</span><span class="p">)</span>
        <span class="n">ud2</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;var&gt;[a-zA-Z_]\w*)\((?P&lt;lag&gt;-[0-9]+)\)&#39;</span><span class="p">,</span><span class="s1">&#39;\g&lt;var&gt;_{\g&lt;lag&gt;}&#39;</span><span class="p">,</span><span class="n">ud</span><span class="p">)</span>
        <span class="n">totud</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="o">+</span><span class="n">ud2</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
       <span class="c1"># print(&#39; &#39;)</span>
    <span class="n">ud</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">totud</span><span class="p">)</span>
    <span class="n">ud2</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39; &amp; = &amp;&#39;</span><span class="p">,</span><span class="n">ud</span><span class="p">)</span>
    <span class="n">ud3</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\begin</span><span class="si">{eqnarray}</span><span class="s1">&#39;</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39; </span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">ud2</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\end</span><span class="si">{eqnarray}</span><span class="s1">$&#39;</span>
    <span class="k">return</span> <span class="n">ud3</span></div>

<div class="viewcode-block" id="display_all"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.display_all">[docs]</a><span class="k">def</span> <span class="nf">display_all</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">calculate_diffvalue</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">)</span>
    <span class="n">res2</span> <span class="o">=</span> <span class="n">calculate_diffvalue_d3d</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">endogene</span><span class="p">):</span>
        <span class="n">display_ip</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">v</span><span class="p">)</span></div>

<div class="viewcode-block" id="display_ip"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.display_ip">[docs]</a><span class="k">def</span> <span class="nf">display_ip</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">ivar</span><span class="p">):</span>
    <span class="n">var</span><span class="o">=</span><span class="n">ivar</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">a</span><span class="p">,</span><span class="n">fr</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">udtryk</span><span class="o">=</span> <span class="n">split_frml</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">])</span>
    <span class="n">udtryk2</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;\_&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># get rid of _</span>
    <span class="n">udtryk3</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;var&gt;[a-zA-Z_]\w*)\((?P&lt;lag&gt;-[0-9]+)\)&#39;</span><span class="p">,</span><span class="s1">&#39;\g&lt;var&gt;_{\g&lt;lag&gt;}&#39;</span><span class="p">,</span><span class="n">udtryk2</span><span class="p">)</span> 
    <span class="n">udtryk4</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39; &amp; = &amp;&#39;</span><span class="p">,</span><span class="n">udtryk3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">totud</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Formula:&#39;</span><span class="o">+</span><span class="n">udtryk4</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">ud</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\frac{\partial &#39;</span><span class="o">+</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;}{\partial &#39;</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="s1">&#39;}  = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ud</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;\_&#39;</span><span class="p">,</span><span class="n">ud</span><span class="p">)</span>
        <span class="n">ud2</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;var&gt;[a-zA-Z_]\w*)\((?P&lt;lag&gt;-[0-9]+)\)&#39;</span><span class="p">,</span><span class="s1">&#39;\g&lt;var&gt;_{\g&lt;lag&gt;}&#39;</span><span class="p">,</span><span class="n">ud</span><span class="p">)</span>
        <span class="n">ud2</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39; &amp; = &amp;&#39;</span><span class="p">,</span><span class="n">ud2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">totud</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="o">+</span><span class="n">ud2</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">totud</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&amp; = &amp; </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">diffvalue</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
       <span class="c1"># print(&#39; &#39;)</span>
    <span class="n">ud</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">totud</span><span class="p">)</span>
 <span class="c1">#   display(Latex(r&#39;\begin{align}&#39;+r&#39; \\&#39;+ud+r&#39;\end{align}&#39;)) </span>
    <span class="n">display</span><span class="p">(</span><span class="n">Latex</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\begin{eqnarray*}&#39;</span><span class="o">+</span><span class="n">ud</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\end{eqnarray*} &#39;</span><span class="p">))</span></div>
  <span class="c1">#  print(       (r&#39;\begin{eqnarray}&#39;+ud+r&#39;\end{eqnarray} &#39;))</span>

    
<div class="viewcode-block" id="settozero"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.settozero">[docs]</a><span class="k">def</span> <span class="nf">settozero</span><span class="p">(</span><span class="n">instring</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; sets subst() or Derivative() to zero in string </span>
<span class="sd">    the purpose is to get rid of derivatives of logical espressions </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">value</span><span class="o">=</span><span class="n">instring</span><span class="p">[:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="s1">&#39;SUBS(&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">forsum</span><span class="p">,</span> <span class="n">sumudtryk</span><span class="p">,</span> <span class="n">eftersum</span> <span class="o">=</span> <span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;SUBS&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">forsum</span> <span class="o">+</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="n">eftersum</span>
        <span class="k">while</span> <span class="s1">&#39;DERIVATIVE(&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">forsum</span><span class="p">,</span> <span class="n">sumudtryk</span><span class="p">,</span> <span class="n">eftersum</span> <span class="o">=</span> <span class="n">find_arg</span><span class="p">(</span><span class="s1">&#39;DERIVATIVE&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">forsum</span> <span class="o">+</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="n">eftersum</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** Error i settozero:&#39;</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span> </div>

<div class="viewcode-block" id="get_A"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.get_A">[docs]</a><span class="k">def</span> <span class="nf">get_A</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">):</span>
    <span class="n">jacobi</span> <span class="o">=</span> <span class="n">calculate_allmat</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">)</span>  <span class="c1"># calculate derivative matrix for all lags</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span><span class="n">j</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">names</span><span class="p">,</span><span class="n">names</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">jacobi</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="get_AINV"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.get_AINV">[docs]</a><span class="k">def</span> <span class="nf">get_AINV</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">I</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>                                        <span class="c1"># a idendity matrix</span>
    <span class="n">AINV</span><span class="o">=</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  
    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">AINV</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="get_compagnion"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.get_compagnion">[docs]</a><span class="k">def</span> <span class="nf">get_compagnion</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
    
    <span class="n">A</span> <span class="o">=</span> <span class="n">get_A</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">)</span>
    <span class="n">AINV</span><span class="o">=</span><span class="n">get_AINV</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>  
    <span class="n">names</span> <span class="o">=</span> <span class="n">AINV</span><span class="o">.</span><span class="n">columns</span><span class="c1">#    print(A[0])                                          # inverse(A) </span>
<span class="c1">#    print(AINV)                                          # inverse(A) </span>
    <span class="n">C</span><span class="o">=</span><span class="p">{</span><span class="n">lag</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">AINV</span><span class="p">,</span><span class="n">A</span><span class="p">[</span><span class="n">lag</span><span class="p">])</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">A</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">lag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">}</span>         <span class="c1"># calculate A**-1*A(lag)</span>
<span class="c1">#    print(C) </span>
    <span class="n">dim</span><span class="o">=</span><span class="n">AINV</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lags</span><span class="o">=</span><span class="p">[</span><span class="n">lag</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
<span class="c1">#    print(&#39;Lags &#39;,lags)</span>
    <span class="n">number</span><span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span> 
    <span class="n">top</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">((</span><span class="n">number</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dim</span><span class="p">,</span><span class="n">number</span><span class="o">*</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">bottom</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bmat</span><span class="p">([</span><span class="n">C</span><span class="p">[</span><span class="n">tlag</span><span class="p">]</span> <span class="k">for</span> <span class="n">tlag</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span> <span class="p">])</span>
<span class="c1">#    print(&#39;Top shape   &#39;,top.shape)</span>
<span class="c1">#    print(&#39;Bottom shape&#39;,bottom.shape)</span>
    <span class="n">ib2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bmat</span><span class="p">([[</span><span class="n">top</span><span class="p">],[</span><span class="n">bottom</span><span class="p">]])</span>
    <span class="n">newnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>       
    
    <span class="n">out</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ib2</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">newnames</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">newnames</span><span class="p">)</span>
    <span class="c1"># breakpoint()</span>
    <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="get_eigen"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.get_eigen">[docs]</a><span class="k">def</span> <span class="nf">get_eigen</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">get_compagnion</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">per</span><span class="p">)</span>
    <span class="n">compeig</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>       <span class="c1"># find the eigenvalues</span>
    <span class="k">return</span> <span class="n">compeig</span></div>
    
<div class="viewcode-block" id="eigplot0"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.eigplot0">[docs]</a><span class="k">def</span> <span class="nf">eigplot0</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span> 
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span> <span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Eigenvalues&#39;</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">x</span><span class="p">)],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_rticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>    
    <span class="n">langde</span> <span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">w</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.00000000000000000000000000000000000000001</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fig</span></div>
<span class="c1">#    ax = fig.add_subplot(2,2,  2   )# , projection=&#39;polar&#39;)</span>
<span class="c1">#    ax.hist(langde)</span>
<span class="c1">#    ax.set_title(&#39;Numbers&#39;)</span>
<div class="viewcode-block" id="eigplot"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.eigplot">[docs]</a><span class="k">def</span> <span class="nf">eigplot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">size</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="s1">&#39;polar&#39;</span><span class="p">})</span>  <span class="c1">#A4 </span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39; Eigenvalues&#39;</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">x</span><span class="p">)],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_rticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>    
    <span class="n">langde</span> <span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">w</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.00000000000000000000000000000000000000001</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fig</span></div>
<span class="c1">#    ax = fig.add_subplot(2,2,  2   )# , projection=&#39;polar&#39;)</span>
<span class="c1">#    ax.hist(langde)</span>
<span class="c1">#    ax.set_title(&#39;Numbers&#39;)</span>
           
<div class="viewcode-block" id="stabilitet"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.stabilitet">[docs]</a><span class="k">def</span> <span class="nf">stabilitet</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">minnumber</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">maxnumber</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">A</span><span class="o">=</span><span class="p">{</span><span class="n">lag</span><span class="p">:</span><span class="n">modeldiff</span><span class="o">.</span><span class="n">calculate_mat</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">lag</span><span class="p">,</span><span class="n">endo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">val3d</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span> <span class="c1"># calculate derivative matrix for all lags</span>
    <span class="n">I</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>                                        <span class="c1"># a idendity matrix</span>
    <span class="n">AINV</span><span class="o">=</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>                                            <span class="c1"># inverse(A) </span>
    <span class="n">C</span><span class="o">=</span><span class="p">{</span><span class="n">lag</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">AINV</span><span class="p">,</span><span class="n">A</span><span class="p">[</span><span class="n">lag</span><span class="p">])</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">A</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">lag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">}</span>         <span class="c1"># calculate A**-1*A(lag)</span>
    <span class="n">dim</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lags</span><span class="o">=</span><span class="p">[</span><span class="n">lag</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
<span class="c1">#    print(&#39;Lags &#39;,lags)</span>
    <span class="n">eigenval</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">eigenvec</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">number</span><span class="p">,</span><span class="n">lag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lags</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">minnumber</span> <span class="o">&lt;=</span> <span class="n">number</span> <span class="o">&lt;=</span> <span class="n">maxnumber</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">number</span><span class="p">,</span><span class="n">lag</span><span class="p">)</span>
            <span class="n">top</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">number</span><span class="o">*</span><span class="n">dim</span><span class="p">,(</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span>
            <span class="n">bottom</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bmat</span><span class="p">([</span><span class="n">C</span><span class="p">[</span><span class="n">tlag</span><span class="p">]</span> <span class="k">for</span> <span class="n">tlag</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span> <span class="k">if</span> <span class="n">tlag</span> <span class="o">&gt;=</span> <span class="n">lag</span><span class="p">])</span>
            <span class="c1">#print(&#39;Top shape   &#39;,top.shape)</span>
            <span class="c1">#print(&#39;Bottom shape&#39;,bottom.shape)</span>
            <span class="n">ib2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bmat</span><span class="p">([[</span><span class="n">top</span><span class="p">],[</span><span class="n">bottom</span><span class="p">]])</span>
            <span class="n">zzz</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">ib2</span><span class="p">)</span>
            <span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">zzz</span>  <span class="c1"># w=egenvrdien , v= egenvektorer</span>
            <span class="n">eigenval</span><span class="p">[</span><span class="n">lag</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="n">eigenvec</span><span class="p">[</span><span class="n">lag</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>
    <span class="k">return</span> <span class="n">eigenval</span><span class="p">,</span><span class="n">eigenvec</span></div>

<div class="viewcode-block" id="tout"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.tout">[docs]</a><span class="k">def</span> <span class="nf">tout</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">var</span></div>

<div class="viewcode-block" id="numdif"><a class="viewcode-back" href="../unsorted/modeldiff.html#modeldiff.numdif">[docs]</a><span class="k">def</span> <span class="nf">numdif</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">rhv</span><span class="p">,</span><span class="n">delta</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
<span class="c1">#        print(&#39;**&#39;,model.allvar[v][&#39;terms&#39;][&#39;frml&#39;])</span>
        <span class="k">def</span> <span class="nf">tout</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">var</span>

               
        <span class="n">nt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span>
        <span class="n">assignpos</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">aequalterm</span><span class="p">)</span>                       <span class="c1"># find the position of = </span>
        <span class="n">rhsterms</span> <span class="o">=</span> <span class="n">nt</span><span class="p">[</span><span class="n">assignpos</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vterm</span> <span class="o">=</span> <span class="n">udtryk_parse</span><span class="p">(</span><span class="n">rhv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">plusterm</span> <span class="o">=</span>  <span class="n">udtryk_parse</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">rhv</span><span class="si">}</span><span class="s1">+</span><span class="si">{</span><span class="n">delta</span><span class="o">/</span><span class="mi">2</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span>
        <span class="n">minusterm</span> <span class="o">=</span> <span class="n">udtryk_parse</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">rhv</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">delta</span><span class="o">/</span><span class="mi">2</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span>
        <span class="n">plus</span>  <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="n">plusterm</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">vterm</span> <span class="k">else</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rhsterms</span><span class="p">])</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="n">minusterm</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">vterm</span> <span class="k">else</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rhsterms</span><span class="p">])</span>
        <span class="n">eplus</span>  <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tout</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">plus</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="n">eminus</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tout</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">minus</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">eplus</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">eminus</span><span class="si">}</span><span class="s1">)/</span><span class="si">{</span><span class="n">delta</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expression</span> </div>
                
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="c1">#%%</span>
    <span class="k">def</span> <span class="nf">recode</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span><span class="n">yes</span><span class="p">,</span><span class="n">no</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function which recratetes the functionality of @recode from eviews &#39;&#39;&#39;</span> 
        <span class="k">return</span> <span class="n">yes</span> <span class="k">if</span> <span class="n">condition</span> <span class="k">else</span> <span class="n">no</span>

    <span class="n">ftest</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">    a= b*2*c**3</span>
<span class="s1">    b = a(-1)</span>
<span class="s1">    d = recode(a&gt;3,a(-1))</span>
<span class="s1">    c= (a&gt;3)</span>
<span class="s1">     &#39;&#39;&#39;</span>
    <span class="n">mtest</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">ftest</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="p">[</span><span class="n">recode</span><span class="p">])</span>   
    <span class="n">dmodel</span> <span class="o">=</span> <span class="n">diffmodel</span><span class="p">(</span><span class="n">mtest</span><span class="p">,</span><span class="n">forcenum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">zz</span> <span class="o">=</span> <span class="n">dmodel</span><span class="o">.</span><span class="n">equations</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">zz</span><span class="p">)</span>
        
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Ib Hansen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>